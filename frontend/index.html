<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Business Transformation Architect</title>
    <script>
    // Global error handler â€” show JS errors visibly on screen
    window.onerror = function(msg, url, line, col, error) {
        var d = document.getElementById('js-error-display');
        if (!d) { d = document.createElement('div'); d.id = 'js-error-display'; d.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#dc2626;color:white;padding:16px;z-index:99999;font-family:monospace;font-size:14px;white-space:pre-wrap;'; document.body.appendChild(d); }
        d.textContent += 'JS Error: ' + msg + ' (line ' + line + ', col ' + col + ')\n';
        return false;
    };
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }

        /* Layout */
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: #1e293b; border-right: 1px solid #334155; padding: 20px 0; flex-shrink: 0; }
        .main { flex: 1; padding: 32px; overflow-y: auto; }

        /* Sidebar */
        .logo { padding: 0 20px 24px; border-bottom: 1px solid #334155; margin-bottom: 16px; }
        .logo h1 { font-size: 20px; color: #38bdf8; }
        .logo p { font-size: 12px; color: #94a3b8; margin-top: 4px; }

        .nav-item { display: flex; align-items: center; padding: 12px 20px; cursor: pointer; transition: all 0.2s; gap: 12px; }
        .nav-item:hover { background: #334155; }
        .nav-item.active { background: #0ea5e9; color: white; }
        .nav-item .step-num { width: 28px; height: 28px; border-radius: 50%; background: #334155; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; flex-shrink: 0; }
        .nav-item.active .step-num { background: rgba(255,255,255,0.2); }
        .nav-item .step-label { font-size: 13px; line-height: 1.3; }
        .nav-item .gate-status { margin-left: auto; font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #334155; }
        .nav-item .gate-status.approved { background: #065f46; color: #6ee7b7; }

        /* Header */
        .page-header { margin-bottom: 28px; }
        .page-header h2 { font-size: 24px; color: #f1f5f9; }
        .page-header p { color: #94a3b8; margin-top: 6px; font-size: 14px; }

        /* Cards */
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .card h3 { font-size: 16px; color: #f1f5f9; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }

        /* Forms */
        .form-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .autocomplete-wrapper { position: relative; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid #475569; border-top: none; border-radius: 0 0 8px 8px; max-height: 240px; overflow-y: auto; z-index: 100; display: none; }
        .autocomplete-list.show { display: block; }
        .autocomplete-item { padding: 10px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .autocomplete-item:hover, .autocomplete-item.active { background: #334155; }
        .autocomplete-item .ac-name { color: #e2e8f0; }
        .autocomplete-item .ac-ticker { color: #38bdf8; font-size: 12px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 10px 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; font-size: 14px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #0ea5e9; }
        textarea { resize: vertical; min-height: 80px; }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #0ea5e9; color: white; }
        .btn-primary:hover { background: #0284c7; }
        .btn-success { background: #059669; color: white; }
        .btn-success:hover { background: #047857; }
        .btn-danger { background: #dc2626; color: white; font-size: 12px; padding: 4px 10px; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-sm { padding: 6px 14px; font-size: 13px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 12px; font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #334155; }
        td { padding: 10px 12px; font-size: 14px; border-bottom: 1px solid #1e293b; }
        tr:hover td { background: #1e293b; }

        /* RICE score badge */
        .rice-badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-weight: 600; font-size: 13px; }
        .rice-high { background: #065f46; color: #6ee7b7; }
        .rice-mid { background: #713f12; color: #fbbf24; }
        .rice-low { background: #7f1d1d; color: #fca5a5; }

        /* Status badges */
        .status { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 12px; }
        .status-pending { background: #334155; color: #94a3b8; }
        .status-approved { background: #065f46; color: #6ee7b7; }
        .status-active, .status-in_progress { background: #1e3a5f; color: #7dd3fc; }
        .status-draft { background: #334155; color: #cbd5e1; }
        .status-done, .status-completed, .status-achieved { background: #065f46; color: #6ee7b7; }
        .status-blocked, .status-at_risk { background: #7f1d1d; color: #fca5a5; }

        /* Gate approval */
        .gate-card { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: #0f172a; border-radius: 8px; margin-bottom: 10px; }
        .gate-card .gate-info { flex: 1; }
        .gate-card .gate-name { font-weight: 500; }
        .gate-card .gate-desc { font-size: 13px; color: #94a3b8; margin-top: 2px; }

        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; background: #065f46; color: #6ee7b7; padding: 12px 24px; border-radius: 8px; font-size: 14px; opacity: 0; transition: opacity 0.3s; z-index: 100; }
        .toast.show { opacity: 1; }

        /* Empty state */
        .empty { text-align: center; padding: 40px; color: #64748b; }
        .empty p { margin-top: 8px; font-size: 14px; }

        /* Loading spinner */
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #334155; border-top-color: #0ea5e9; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-overlay { text-align: center; padding: 60px 20px; }
        .loading-overlay .spinner { width: 40px; height: 40px; border-width: 4px; }
        .loading-overlay p { margin-top: 16px; color: #94a3b8; font-size: 14px; }
        .progress-msg { margin-top: 8px; color: #64748b; font-size: 13px; }

        /* Org setup form */
        .org-setup { max-width: 520px; margin: 40px auto; }
        .org-setup h3 { margin-bottom: 20px; font-size: 20px; color: #f1f5f9; text-align: center; }

        /* Analysis dashboard */
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .analysis-grid .card { margin-bottom: 0; }
        .chart-container { position: relative; height: 220px; display: flex; align-items: flex-end; gap: 6px; padding: 10px 0; }
        .chart-bar { flex: 1; background: linear-gradient(to top, #0ea5e9, #38bdf8); border-radius: 4px 4px 0 0; position: relative; min-width: 20px; transition: height 0.5s ease; }
        .chart-bar:hover { opacity: 0.85; }
        .chart-bar .bar-label { position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #94a3b8; white-space: nowrap; }
        .chart-bar .bar-value { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #e2e8f0; white-space: nowrap; }

        /* SWOT grid */
        .swot-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .swot-quad { padding: 16px; border-radius: 8px; }
        .swot-quad h4 { font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .swot-quad.strengths { background: #064e3b; }
        .swot-quad.strengths h4 { color: #6ee7b7; }
        .swot-quad.weaknesses { background: #7f1d1d; }
        .swot-quad.weaknesses h4 { color: #fca5a5; }
        .swot-quad.opportunities { background: #1e3a5f; }
        .swot-quad.opportunities h4 { color: #7dd3fc; }
        .swot-quad.threats { background: #713f12; }
        .swot-quad.threats h4 { color: #fbbf24; }
        .swot-quad li { font-size: 13px; margin-bottom: 6px; color: #e2e8f0; list-style: none; padding-left: 12px; position: relative; }
        .swot-quad li::before { content: ""; position: absolute; left: 0; top: 7px; width: 5px; height: 5px; border-radius: 50%; background: currentColor; opacity: 0.5; }

        /* Metric cards */
        .metric-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
        .metric-card { flex: 1; min-width: 120px; background: #0f172a; padding: 14px; border-radius: 8px; text-align: center; }
        .metric-card .metric-val { font-size: 22px; font-weight: 700; color: #38bdf8; }
        .metric-card .metric-label { font-size: 11px; color: #94a3b8; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Phase tabs */
        .phase-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .phase-tab { padding: 8px 18px; border-radius: 8px; background: #334155; color: #94a3b8; cursor: pointer; font-size: 13px; font-weight: 500; border: none; transition: all 0.2s; }
        .phase-tab.active { background: #0ea5e9; color: white; }
        .phase-tab:hover:not(.active) { background: #475569; color: #e2e8f0; }

        /* Comparison table */
        .comparison-table { width: 100%; border-collapse: collapse; }
        .comparison-table th { text-align: left; padding: 10px 12px; font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #334155; }
        .comparison-table td { padding: 10px 12px; font-size: 14px; border-bottom: 1px solid #1e293b; }
        .comparison-table .best { color: #6ee7b7; font-weight: 600; }
        .comparison-table .worst { color: #fca5a5; }

        /* Grouped bar chart */
        .grouped-chart { display: flex; align-items: flex-end; gap: 16px; padding: 10px 0; height: 240px; overflow-x: auto; }
        .bar-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .bar-group-bars { display: flex; align-items: flex-end; gap: 3px; height: 200px; }
        .bar-group-label { font-size: 10px; color: #94a3b8; }
        .g-bar { width: 24px; border-radius: 3px 3px 0 0; position: relative; min-height: 4px; transition: height 0.5s ease; }
        .g-bar:hover { opacity: 0.8; }
        .g-bar .g-val { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #e2e8f0; white-space: nowrap; }

        /* Chart legend */
        .chart-legend { display: flex; gap: 16px; margin-top: 8px; justify-content: center; }
        .chart-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #94a3b8; }
        .chart-legend-dot { width: 10px; height: 10px; border-radius: 2px; }

        /* Value Stream Flow Diagram */
        .vs-flow { display: flex; align-items: center; overflow-x: auto; padding: 20px 0; gap: 0; }
        .vs-flow-step { flex-shrink: 0; width: 150px; padding: 14px 10px; border-radius: 10px; background: #1e293b; border: 2px solid #334155; text-align: center; position: relative; }
        .vs-flow-step .step-title { font-size: 13px; font-weight: 600; color: #f1f5f9; margin-bottom: 6px; }
        .vs-flow-step .step-times { font-size: 11px; }
        .vs-flow-step .step-times .pt { color: #6ee7b7; }
        .vs-flow-step .step-times .wt { color: #fbbf24; }
        .vs-flow-step.type-trigger { border-color: #22c55e; border-style: dashed; }
        .vs-flow-step.type-delivery { border-color: #3b82f6; border-style: dashed; }
        .vs-flow-step.type-decision { border-radius: 0; transform: rotate(0deg); border-color: #a78bfa; }
        .vs-flow-step.bottleneck { background: #7c2d12; border-color: #f97316; }
        .vs-flow-arrow { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; width: 60px; }
        .vs-flow-arrow .arrow-line { width: 100%; height: 2px; background: #475569; position: relative; }
        .vs-flow-arrow .arrow-line::after { content: ""; position: absolute; right: -1px; top: -5px; border: 6px solid transparent; border-left-color: #475569; }
        .vs-flow-arrow .arrow-wait { font-size: 10px; color: #fbbf24; margin-top: 4px; }
        .vs-metrics-bar { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; padding: 14px; background: #0f172a; border-radius: 8px; }
        .vs-metrics-bar .vm-item { flex: 1; min-width: 100px; text-align: center; }
        .vs-metrics-bar .vm-val { font-size: 18px; font-weight: 700; color: #38bdf8; }
        .vs-metrics-bar .vm-label { font-size: 11px; color: #94a3b8; margin-top: 2px; text-transform: uppercase; }
        .vs-metrics-bar .vm-val.warn { color: #fbbf24; }
        .vs-metrics-bar .vm-val.good { color: #6ee7b7; }

        /* Editable table cell */
        .edit-cell { cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        .edit-cell:hover { background: #334155; }
        .edit-cell input, .edit-cell select { width: 100%; padding: 4px 6px; background: #0f172a; border: 1px solid #0ea5e9; border-radius: 4px; color: #e2e8f0; font-size: 13px; }

        /* Strategy layer colors */
        .layer-business { background: #064e3b; color: #6ee7b7; }
        .layer-digital { background: #1e3a5f; color: #7dd3fc; }
        .layer-data { background: #713f12; color: #fbbf24; }
        .layer-gen_ai { background: #581c87; color: #c4b5fd; }
        .strategy-card { border-left: 4px solid #334155; padding: 16px; background: #0f172a; border-radius: 8px; margin-bottom: 12px; }
        .strategy-card.business { border-left-color: #059669; }
        .strategy-card.digital { border-left-color: #2563eb; }
        .strategy-card.data { border-left-color: #d97706; }
        .strategy-card.gen_ai { border-left-color: #7c3aed; }
        /* Severity & confidence badges */
        .severity-badge { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-left: 4px; }
        .severity-high { background: #7f1d1d; color: #fca5a5; }
        .severity-medium { background: #713f12; color: #fbbf24; }
        .severity-low { background: #064e3b; color: #6ee7b7; }
        .confidence-badge { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 10px; margin-left: 2px; }
        .confidence-high { border: 1.5px solid #6ee7b7; color: #6ee7b7; }
        .confidence-medium { border: 1.5px dashed #fbbf24; color: #fbbf24; }
        .confidence-low { border: 1.5px dotted #94a3b8; color: #94a3b8; }
        /* Risk level badges */
        .risk-badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .risk-critical { background: #7f1d1d; color: #fca5a5; }
        .risk-high { background: #7c2d12; color: #fdba74; }
        .risk-medium { background: #713f12; color: #fbbf24; }
        .risk-low { background: #064e3b; color: #6ee7b7; }
        /* Impact score */
        .impact-bar { display: inline-block; height: 8px; border-radius: 4px; background: #0ea5e9; min-width: 8px; }
        .impact-label { font-size: 11px; color: #94a3b8; margin-left: 4px; }
        /* AI badge */
        .ai-badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #581c87; color: #c4b5fd; }
        /* Expandable text */
        .expand-toggle { cursor: pointer; color: #0ea5e9; font-size: 12px; margin-left: 4px; }
        .expand-toggle:hover { text-decoration: underline; }
        .sp-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #1e3a5f; color: #7dd3fc; }
        .effort-days-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #064e3b; color: #6ee7b7; }
        .dep-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #713f12; color: #fbbf24; }
        .acceptance-criteria { margin-top: 8px; padding: 10px; background: #0f172a; border-radius: 8px; font-size: 12px; color: #94a3b8; white-space: pre-line; display: none; }
        .acceptance-criteria.open { display: block; }
        .roadmap-phase { padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .roadmap-phase.quick-wins { background: #064e3b22; border: 1px solid #065f46; }
        .roadmap-phase.strategic { background: #1e3a5f22; border: 1px solid #1e40af; }
        .roadmap-phase.long-term { background: #713f1222; border: 1px solid #92400e; }
        .layer-badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-source-card { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 8px; background: #0f172a; border: 1px solid #334155; font-size: 13px; }
        .data-source-card .dot { width: 10px; height: 10px; border-radius: 50%; }
        .data-source-card .dot.active { background: #22c55e; }
        .data-source-card .dot.inactive { background: #475569; }
        .roadmap-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #1e293b; border-radius: 8px; margin-bottom: 8px; }
        .roadmap-item .ri-name { font-size: 14px; font-weight: 500; flex: 1; }
        .roadmap-item .ri-meta { display: flex; gap: 12px; align-items: center; font-size: 12px; color: #94a3b8; }

        /* Quarterly timeline roadmap */
        .qt-roadmap { display: flex; gap: 0; overflow-x: auto; padding-bottom: 8px; }
        .qt-quarter { flex: 1; min-width: 220px; border-right: 1px solid #334155; }
        .qt-quarter:last-child { border-right: none; }
        .qt-header { padding: 12px 16px; background: #1e293b; border-bottom: 2px solid #0ea5e9; text-align: center; font-weight: 600; font-size: 14px; color: #38bdf8; position: sticky; top: 0; }
        .qt-header .qt-count { font-size: 11px; color: #64748b; font-weight: 400; }
        .qt-items { padding: 12px 10px; min-height: 80px; }
        .qt-card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 12px; margin-bottom: 10px; transition: border-color 0.2s; }
        .qt-card:hover { border-color: #0ea5e9; }
        .qt-card .qt-name { font-size: 13px; font-weight: 500; margin-bottom: 6px; line-height: 1.3; }
        .qt-card .qt-parent { font-size: 11px; color: #64748b; margin-bottom: 6px; display: flex; flex-wrap: wrap; gap: 4px; }
        .qt-card .qt-parent span { background: #0f172a; padding: 1px 6px; border-radius: 4px; }
        .qt-card .qt-meta { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; font-size: 11px; color: #94a3b8; }
        .qt-phase-badge { display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .qt-phase-badge.qw { background: #064e3b; color: #6ee7b7; }
        .qt-phase-badge.st { background: #1e3a5f; color: #7dd3fc; }
        .qt-phase-badge.lt { background: #713f12; color: #fbbf24; }
        .qt-summary { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .qt-summary-card { background: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 16px 24px; text-align: center; flex: 1; min-width: 120px; }
        .qt-summary-card .qt-val { font-size: 28px; font-weight: 700; color: #f1f5f9; }
        .qt-summary-card .qt-lbl { font-size: 12px; color: #64748b; margin-top: 2px; }

        /* Risk levels */
        .risk-low { color: #6ee7b7; }
        .risk-medium { color: #fbbf24; }
        .risk-high { color: #f97316; }
        .risk-critical { color: #fca5a5; font-weight: 600; }

        /* Login/Register screen */
        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #0f172a; }
        .login-card { background: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 40px; width: 100%; max-width: 400px; }
        .login-card h2 { text-align: center; color: #38bdf8; margin-bottom: 8px; font-size: 22px; }
        .login-card .subtitle { text-align: center; color: #94a3b8; font-size: 13px; margin-bottom: 28px; }
        .login-card .form-group { margin-bottom: 16px; }
        .login-card .btn-primary { width: 100%; padding: 12px; font-size: 15px; margin-top: 8px; }
        .login-card .toggle-link { text-align: center; margin-top: 16px; font-size: 13px; color: #94a3b8; }
        .login-card .toggle-link a { color: #38bdf8; cursor: pointer; text-decoration: none; }
        .login-card .toggle-link a:hover { text-decoration: underline; }
        .login-card .error-msg { color: #fca5a5; font-size: 13px; text-align: center; margin-top: 12px; min-height: 20px; }

        /* User info in sidebar */
        .user-info { padding: 12px 20px; border-top: 1px solid #334155; margin-top: auto; }
        .user-info .user-name { font-size: 13px; color: #e2e8f0; font-weight: 500; }
        .user-info .user-email { font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .user-info .btn-logout { background: none; border: 1px solid #475569; color: #94a3b8; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 8px; width: 100%; transition: all 0.2s; }
        .user-info .btn-logout:hover { border-color: #dc2626; color: #fca5a5; }

        .sidebar { display: flex; flex-direction: column; }

        /* AI Dashboard */
        .ai-section { margin-bottom: 16px; }
        .ai-section-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 14px 18px; background: #1e293b; border: 1px solid #334155; border-radius: 10px; transition: all 0.2s; }
        .ai-section-header:hover { background: #253347; }
        .ai-section-header h4 { font-size: 14px; color: #f1f5f9; display: flex; align-items: center; gap: 8px; }
        .ai-section-header .toggle-arrow { color: #64748b; transition: transform 0.2s; font-size: 12px; }
        .ai-section-header .toggle-arrow.open { transform: rotate(90deg); }
        .ai-section-body { padding: 18px; background: #1e293b; border: 1px solid #334155; border-top: none; border-radius: 0 0 10px 10px; display: none; }
        .ai-section-body.open { display: block; }
        .ai-section.expanded .ai-section-header { border-radius: 10px 10px 0 0; }

        .health-score-circle { width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; margin: 0 auto 12px; }
        .health-score-bar { display: flex; gap: 4px; margin: 16px 0; }
        .health-score-bar .step-seg { flex: 1; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #fff; }

        .anomaly-card { background: #1a0a0a; border: 1px solid #dc2626; border-radius: 8px; padding: 14px; margin-bottom: 10px; }
        .anomaly-card .anomaly-title { font-size: 14px; font-weight: 600; color: #fca5a5; }
        .anomaly-card .anomaly-detail { font-size: 13px; color: #e2e8f0; margin-top: 4px; }

        .warning-card { background: #1a1400; border: 1px solid #d97706; border-radius: 8px; padding: 14px; margin-bottom: 10px; }
        .warning-card .warning-title { font-size: 14px; font-weight: 600; color: #fbbf24; }
        .warning-card .warning-detail { font-size: 13px; color: #e2e8f0; margin-top: 4px; }

        .forecast-card { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 14px; text-align: center; flex: 1; min-width: 180px; }
        .forecast-card .forecast-val { font-size: 22px; font-weight: 700; color: #38bdf8; }
        .forecast-card .forecast-range { font-size: 11px; color: #64748b; margin-top: 2px; }
        .forecast-card .forecast-label { font-size: 11px; color: #94a3b8; margin-top: 4px; text-transform: uppercase; }

        .nlq-chip { display: inline-block; padding: 6px 14px; border-radius: 20px; background: #334155; color: #94a3b8; font-size: 12px; cursor: pointer; margin: 4px; transition: all 0.2s; }
        .nlq-chip:hover { background: #475569; color: #e2e8f0; }

        .report-section { padding: 18px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; margin-bottom: 12px; }
        .report-section h5 { font-size: 15px; color: #38bdf8; margin-bottom: 10px; }
        .report-section .report-content { font-size: 13px; color: #e2e8f0; line-height: 1.7; white-space: pre-wrap; }

        .impact-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .impact-grid .impact-col { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 14px; }
        .impact-grid .impact-col h5 { font-size: 13px; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; }

        .threat-bar { height: 8px; border-radius: 4px; background: #334155; overflow: hidden; }
        .threat-bar-fill { height: 100%; border-radius: 4px; }

        .ai-loading { text-align: center; padding: 24px; }
        .ai-loading .spinner { width: 24px; height: 24px; }

        /* Data Ingestion Hub */
        .ingest-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .ingest-column { display: flex; flex-direction: column; gap: 12px; }
        .ingest-column h4 { font-size: 14px; color: #f1f5f9; margin-bottom: 4px; }
        .ingest-column p { font-size: 12px; color: #64748b; }
        .drop-zone { border: 2px dashed #475569; border-radius: 10px; padding: 28px 16px; text-align: center; cursor: pointer; transition: all 0.2s; background: #0f172a; }
        .drop-zone:hover, .drop-zone.drag-over { border-color: #0ea5e9; background: #0c1a2e; }
        .drop-zone .dz-icon { font-size: 28px; color: #475569; margin-bottom: 8px; }
        .drop-zone .dz-text { font-size: 13px; color: #94a3b8; }
        .drop-zone .dz-formats { font-size: 11px; color: #64748b; margin-top: 6px; }
        .source-status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .source-status.configured { background: #064e3b; color: #6ee7b7; }
        .source-status.not-configured { background: #1e293b; color: #64748b; }
        .url-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .url-table th { text-align: left; padding: 8px 10px; font-size: 11px; color: #94a3b8; text-transform: uppercase; border-bottom: 1px solid #334155; }
        .url-table td { padding: 8px 10px; border-bottom: 1px solid #1e293b; }
        .url-status-success { color: #6ee7b7; }
        .url-status-error { color: #fca5a5; }
        .url-status-pending { color: #94a3b8; }
        .card-collapsible .card-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .card-collapsible .card-header .toggle-arrow { color: #64748b; transition: transform 0.2s; font-size: 14px; margin-right: 8px; }
        .card-collapsible.expanded .toggle-arrow { transform: rotate(90deg); }
        .card-collapsible .card-body { display: none; margin-top: 16px; }
        .card-collapsible.expanded .card-body { display: block; }
        .refresh-result { padding: 10px 14px; border-radius: 8px; margin-top: 8px; font-size: 13px; }
        .refresh-result.ok { background: #064e3b; color: #6ee7b7; }
        .refresh-result.error { background: #7f1d1d; color: #fca5a5; }
        .refresh-result.skipped { background: #1e293b; color: #64748b; }
        .btn-lg { padding: 14px 28px; font-size: 15px; font-weight: 600; }

        /* Generate All Overlay */
        .gen-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .gen-modal { background: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 32px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .gen-modal h2 { font-size: 20px; color: #f1f5f9; margin-bottom: 20px; text-align: center; }
        .gen-step-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
        .gen-step-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #0f172a; border-radius: 8px; border: 1px solid #334155; }
        .gen-step-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; }
        .gen-step-icon.pending { background: #334155; color: #94a3b8; }
        .gen-step-icon.running { background: #1e3a5f; color: #7dd3fc; animation: pulse 1.5s infinite; }
        .gen-step-icon.done { background: #065f46; color: #6ee7b7; }
        .gen-step-icon.failed { background: #7f1d1d; color: #fca5a5; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .gen-step-info { flex: 1; }
        .gen-step-name { font-size: 14px; font-weight: 500; color: #e2e8f0; }
        .gen-step-status { font-size: 12px; color: #64748b; margin-top: 2px; }
        .gen-msg { text-align: center; font-size: 14px; color: #94a3b8; margin-bottom: 16px; }
        .gen-actions { display: flex; gap: 12px; justify-content: center; }
        .btn-outline { padding: 10px 20px; border-radius: 8px; border: 1px solid #475569; background: transparent; color: #94a3b8; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn-outline:hover { border-color: #e2e8f0; color: #e2e8f0; }
        .gen-progress-bar { height: 6px; background: #334155; border-radius: 3px; margin-bottom: 16px; overflow: hidden; }
        .gen-progress-fill { height: 100%; background: linear-gradient(90deg, #0ea5e9, #38bdf8); border-radius: 3px; transition: width 0.5s ease; }

        /* Review wizard */
        .review-step-card { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: #0f172a; border-radius: 8px; border: 1px solid #334155; margin-bottom: 8px; }
        .review-step-card .rsc-info { flex: 1; }
        .review-step-card .rsc-name { font-size: 14px; font-weight: 500; color: #e2e8f0; }
        .review-step-card .rsc-counts { font-size: 12px; color: #64748b; margin-top: 2px; }
        .review-step-card .rsc-actions { display: flex; gap: 8px; }

        /* Generate All button */
        .btn-generate-all { background: linear-gradient(135deg, #7c3aed, #2563eb); color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.2s; }
        .btn-generate-all:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Knowledge Base & Data Mode */
        .kb-modal { background: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 32px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .kb-modal h2 { font-size: 20px; color: #f1f5f9; margin-bottom: 8px; text-align: center; }
        .kb-subtitle { font-size: 13px; color: #64748b; text-align: center; margin-bottom: 20px; }
        .data-mode-toggle { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 16px; background: #0f172a; border-radius: 10px; margin-bottom: 20px; }
        .data-mode-toggle .mode-label { font-size: 14px; font-weight: 500; }
        .data-mode-toggle .mode-label.active { color: #38bdf8; }
        .data-mode-toggle .mode-label.inactive { color: #475569; }
        .toggle-switch { position: relative; width: 48px; height: 26px; background: #334155; border-radius: 13px; cursor: pointer; transition: background 0.3s; }
        .toggle-switch.live { background: #0ea5e9; }
        .toggle-switch .toggle-knob { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: #f1f5f9; border-radius: 50%; transition: left 0.3s; }
        .toggle-switch.live .toggle-knob { left: 25px; }
        .kb-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .kb-stat { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 12px; text-align: center; }
        .kb-stat-val { font-size: 24px; font-weight: 700; color: #38bdf8; }
        .kb-stat-label { font-size: 11px; color: #64748b; margin-top: 4px; }
        .kb-upload-area { border: 2px dashed #334155; border-radius: 10px; padding: 20px; text-align: center; margin-bottom: 16px; cursor: pointer; transition: border-color 0.2s; }
        .kb-upload-area:hover { border-color: #0ea5e9; }
        .kb-upload-area input[type="file"] { display: none; }
        .kb-doc-list { max-height: 250px; overflow-y: auto; }
        .kb-doc-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; margin-bottom: 6px; }
        .kb-doc-info { flex: 1; }
        .kb-doc-name { font-size: 13px; font-weight: 500; color: #e2e8f0; }
        .kb-doc-meta { font-size: 11px; color: #64748b; margin-top: 2px; }
        .kb-doc-badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; background: #334155; color: #94a3b8; font-weight: 500; }
        .kb-search { display: flex; gap: 8px; margin-bottom: 16px; }
        .kb-search input { flex: 1; }
        .kb-search-results { max-height: 200px; overflow-y: auto; margin-bottom: 16px; }
        .kb-search-result { padding: 10px 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; margin-bottom: 6px; }
        .kb-search-result .chunk-text { font-size: 12px; color: #cbd5e1; line-height: 1.5; }
        .kb-search-result .chunk-meta { font-size: 11px; color: #64748b; margin-top: 4px; }
        .sidebar-divider { height: 1px; background: #334155; margin: 8px 20px; }
        .nav-item-kb .step-num { background: #7c3aed; font-size: 11px; }
        .nav-item-kb:hover { background: #334155; }
        .data-mode-badge { display: flex; align-items: center; gap: 6px; padding: 6px 20px; font-size: 11px; color: #64748b; cursor: pointer; transition: all 0.2s; }
        .data-mode-badge:hover { color: #e2e8f0; }
        .data-mode-badge .mode-dot { width: 8px; height: 8px; border-radius: 50%; }
        .data-mode-badge .mode-dot.demo { background: #f59e0b; }
        .data-mode-badge .mode-dot.live { background: #10b981; }

        /* Responsive */
        @media (max-width: 768px) {
            .app { flex-direction: column; }
            .sidebar { width: 100%; }
            .form-row { flex-direction: column; }
            .form-group { min-width: 100%; }
            .analysis-grid { grid-template-columns: 1fr; }
            .swot-grid { grid-template-columns: 1fr; }
            .impact-grid { grid-template-columns: 1fr; }
            .ingest-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Login/Register Screen (shown when not authenticated) -->
<div id="login-screen" class="login-screen">
    <div class="login-card">
        <h2>Business Transformation Architect</h2>
        <p class="subtitle">Loading...</p>
    </div>
</div>

<!-- Main App (shown when authenticated) -->
<div class="app" id="app-container" style="display:none;">
    <nav class="sidebar">
        <div class="logo">
            <h1>Business Transformation Architect</h1>
            <p>Strategic Planning & Execution</p>
        </div>
        <div class="nav-item active" onclick="showStep(1)">
            <span class="step-num">1</span>
            <span class="step-label">Performance Dashboard</span>
        </div>
        <div class="nav-item" onclick="showStep(2)">
            <span class="step-num">2</span>
            <span class="step-label">Value Stream Analysis</span>
        </div>
        <div class="nav-item" onclick="showStep(3)">
            <span class="step-num">3</span>
            <span class="step-label">SWOT / TOWS Engine</span>
        </div>
        <div class="nav-item" onclick="showStep(4)">
            <span class="step-num">4</span>
            <span class="step-label">Strategy & OKRs</span>
        </div>
        <div class="nav-item" onclick="showStep(5)">
            <span class="step-num">5</span>
            <span class="step-label">Initiatives & RICE</span>
        </div>
        <div class="nav-item" onclick="showStep(6)">
            <span class="step-num">6</span>
            <span class="step-label">Epics & Roadmap</span>
        </div>
        <div class="nav-item" onclick="showStep(7)">
            <span class="step-num">7</span>
            <span class="step-label">Features & Roadmap</span>
        </div>
        <div class="sidebar-divider"></div>
        <div class="nav-item nav-item-kb" onclick="showKnowledgeBase()">
            <span class="step-num" style="background:#7c3aed;font-size:11px;">KB</span>
            <span class="step-label">Knowledge Base</span>
        </div>
        <div class="data-mode-badge" id="data-mode-badge" onclick="showKnowledgeBase()">
            <span class="mode-dot demo" id="mode-dot"></span>
            <span id="mode-text">Demo Mode</span>
        </div>
        <div class="user-info" id="user-info"></div>
    </nav>

    <main class="main" id="main-content">
        <!-- Content loaded dynamically -->
    </main>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '/api';
let currentStep = 1;
let authToken = localStorage.getItem('bta_token');
let currentUser = null;

// --- Auth ---
function getAuthHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
    return headers;
}

function renderLoginScreen(mode = 'login') {
    document.getElementById('app-container').style.display = 'none';
    const screen = document.getElementById('login-screen');
    screen.style.display = 'flex';

    if (mode === 'register') {
        screen.innerHTML = `
            <div class="login-card">
                <h2>Create Account</h2>
                <p class="subtitle">Business Transformation Architect</p>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="reg-name" placeholder="Your name" />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="reg-email" placeholder="you@company.com" />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="reg-password" placeholder="Min 8 characters" />
                </div>
                <button class="btn btn-primary" onclick="handleRegister()">Create Account</button>
                <div class="error-msg" id="auth-error"></div>
                <div class="toggle-link">Already have an account? <a onclick="renderLoginScreen('login')">Sign in</a></div>
            </div>
        `;
    } else {
        screen.innerHTML = `
            <div class="login-card">
                <h2>Sign In</h2>
                <p class="subtitle">Business Transformation Architect</p>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" placeholder="you@company.com" />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="Your password" />
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>
                <div class="error-msg" id="auth-error"></div>
                <div class="toggle-link">Don't have an account? <a onclick="renderLoginScreen('register')">Create one</a></div>
            </div>
        `;
    }

    // Enable enter key submission
    setTimeout(() => {
        const inputs = screen.querySelectorAll('input');
        inputs.forEach(inp => {
            inp.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (mode === 'register') handleRegister();
                    else handleLogin();
                }
            });
        });
        if (inputs.length) inputs[0].focus();
    }, 50);
}

async function handleRegister() {
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;
    const errEl = document.getElementById('auth-error');
    errEl.textContent = '';

    if (!name || !email || !password) { errEl.textContent = 'All fields are required'; return; }
    if (password.length < 8) { errEl.textContent = 'Password must be at least 8 characters'; return; }

    try {
        const res = await fetch(API + '/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password }),
        });
        const data = await res.json();
        if (!res.ok) { errEl.textContent = data.detail || 'Registration failed'; return; }
        // Auto-login after registration
        await doLogin(email, password);
    } catch (e) {
        errEl.textContent = 'Network error. Please try again.';
    }
}

async function handleLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const errEl = document.getElementById('auth-error');
    errEl.textContent = '';

    if (!email || !password) { errEl.textContent = 'Email and password are required'; return; }
    await doLogin(email, password);
}

async function doLogin(email, password) {
    const errEl = document.getElementById('auth-error');
    try {
        const res = await fetch(API + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (!res.ok) { errEl.textContent = data.detail || 'Login failed'; return; }

        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('bta_token', authToken);
        showApp();
    } catch (e) {
        errEl.textContent = 'Network error. Please try again.';
    }
}

function logout() {
    authToken = null;
    currentUser = null;
    localStorage.removeItem('bta_token');
    renderLoginScreen();
}

function showApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-container').style.display = 'flex';

    // Show user info in sidebar
    const userInfo = document.getElementById('user-info');
    if (currentUser) {
        userInfo.innerHTML = `
            <div class="user-name">${currentUser.name}</div>
            <div class="user-email">${currentUser.email}</div>
            <button class="btn-logout" onclick="logout()">Sign Out</button>
        `;
    }

    showStep(1);
    checkActiveGeneration();
    loadDataMode();
}

async function initApp() {
    try {
        if (authToken) {
            // Validate existing token
            try {
                const res = await fetch(API + '/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                if (res.ok) {
                    currentUser = await res.json();
                    showApp();
                    return;
                }
            } catch (e) {}
            // Token invalid/expired
            authToken = null;
            localStorage.removeItem('bta_token');
        }
        renderLoginScreen();
    } catch (err) {
        console.error('initApp error:', err);
        renderLoginScreen();
    }
}

// --- Utility ---
function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

async function api(path, method = 'GET', body = null) {
    const opts = { method, headers: getAuthHeaders() };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(API + path, opts);
    if (res.status === 401) { logout(); return null; }
    return res.json();
}

async function apiUpload(path, formData) {
    const headers = {};
    if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
    const res = await fetch(API + path, { method: 'POST', body: formData, headers });
    if (res.status === 401) { logout(); return null; }
    return res.json();
}

function riceClass(score) {
    if (score >= 5) return 'rice-high';
    if (score >= 2) return 'rice-mid';
    return 'rice-low';
}

function statusHtml(status) {
    return `<span class="status status-${status}">${status}</span>`;
}

// --- Navigation ---
function showStep(n) {
    currentStep = n;
    document.querySelectorAll('.nav-item').forEach((el, i) => {
        el.classList.toggle('active', i === n - 1);
    });
    const loaders = [null, loadStep1, loadStep2, loadStep3, loadStep4, loadStep5, loadStep6, loadStep7];
    loaders[n]();
}

// ===================== STEP 1: Performance Dashboard =====================
let step1Phase = 'data'; // 'setup', 'data', 'analysis', 'ai'

async function loadStep1() {
    const org = await api('/step1/organization');
    if (!org) {
        step1Phase = 'setup';
        renderStep1Setup();
    } else {
        if (step1Phase === 'setup') step1Phase = 'data';
        if (step1Phase === 'ai') {
            renderStep1AI();
        } else if (step1Phase === 'analysis') {
            renderStep1Analysis();
        } else {
            renderStep1Data(org);
        }
    }
}

function renderStep1Setup() {
    const industries = ['Technology','Healthcare','Financial Services','Consumer Goods','Energy','Industrials','Materials','Telecommunications','Utilities','Real Estate','Retail','Automotive','Aerospace & Defense','Media & Entertainment','Other'];
    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Step 1: Business Performance Dashboard</h2>
            <p>Set up your organization to auto-fetch financial data and competitor analysis.</p>
        </div>
        <div class="org-setup">
            <div class="card">
                <h3 style="justify-content:center;">Organization Setup</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Organization Name</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="org-name" placeholder="Start typing a company name..." autocomplete="off" oninput="onOrgNameInput(this.value)" onkeydown="onOrgNameKeydown(event)" />
                            <div class="autocomplete-list" id="org-name-suggestions"></div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Industry Type</label>
                        <select id="org-industry">
                            ${industries.map(i => `<option value="${i}">${i}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Competitor 1</label>
                        <input type="text" id="org-comp1" placeholder="e.g. Microsoft" />
                    </div>
                    <div class="form-group">
                        <label>Competitor 2</label>
                        <input type="text" id="org-comp2" placeholder="e.g. Google" />
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-primary" onclick="submitOrganization()" style="padding: 12px 32px; font-size: 15px;">Submit & Fetch Data</button>
                </div>
                <p style="text-align: center; margin-top: 12px; font-size: 12px; color: #64748b;">Enter a publicly traded company name for best results. Data is fetched from Finnhub & Alpha Vantage APIs.</p>
            </div>
        </div>
        <div id="step1-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(1, 'step1-gates');
}

// --- Organization Name Autocomplete ---
let _acTimer = null;
let _acIndex = -1;

async function onOrgNameInput(val) {
    clearTimeout(_acTimer);
    const list = document.getElementById('org-name-suggestions');
    if (!list) return;
    if (val.trim().length < 2) { list.classList.remove('show'); list.innerHTML = ''; return; }
    _acTimer = setTimeout(async () => {
        try {
            const results = await api('/step1/search-companies?q=' + encodeURIComponent(val.trim()));
            if (!results || !results.length) { list.classList.remove('show'); list.innerHTML = ''; return; }
            _acIndex = -1;
            list.innerHTML = results.map((r, i) =>
                `<div class="autocomplete-item" data-name="${r.name}" data-symbol="${r.symbol}" onmousedown="selectOrgSuggestion('${r.name.replace(/'/g, "\\'")}', '${r.symbol}')" onmouseenter="_acIndex=${i}">
                    <span class="ac-name">${r.name}</span><span class="ac-ticker">${r.symbol}</span>
                </div>`
            ).join('');
            list.classList.add('show');
        } catch (e) { list.classList.remove('show'); }
    }, 300);
}

function onOrgNameKeydown(e) {
    const list = document.getElementById('org-name-suggestions');
    if (!list || !list.classList.contains('show')) return;
    const items = list.querySelectorAll('.autocomplete-item');
    if (e.key === 'ArrowDown') { e.preventDefault(); _acIndex = Math.min(_acIndex + 1, items.length - 1); updateAcHighlight(items); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); _acIndex = Math.max(_acIndex - 1, 0); updateAcHighlight(items); }
    else if (e.key === 'Enter' && _acIndex >= 0) { e.preventDefault(); items[_acIndex].onmousedown(); }
    else if (e.key === 'Escape') { list.classList.remove('show'); }
}

function updateAcHighlight(items) {
    items.forEach((el, i) => el.classList.toggle('active', i === _acIndex));
    if (_acIndex >= 0 && items[_acIndex]) items[_acIndex].scrollIntoView({ block: 'nearest' });
}

function selectOrgSuggestion(name, symbol) {
    document.getElementById('org-name').value = name;
    const list = document.getElementById('org-name-suggestions');
    if (list) { list.classList.remove('show'); list.innerHTML = ''; }
}

async function submitOrganization() {
    const name = document.getElementById('org-name').value.trim();
    const industry = document.getElementById('org-industry').value;
    const competitor_1_name = document.getElementById('org-comp1')?.value.trim() || '';
    const competitor_2_name = document.getElementById('org-comp2')?.value.trim() || '';
    if (!name) { alert('Please enter an organization name.'); return; }

    // Save organization
    await api('/step1/organization', 'POST', { name, industry, competitor_1_name, competitor_2_name });

    // Show loading state
    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Step 1: Business Performance Dashboard</h2>
        </div>
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p id="ingest-status">Searching for ${name}...</p>
            <p class="progress-msg" id="ingest-progress">This may take 15-30 seconds</p>
        </div>
    `;

    // Trigger ingestion
    const result = await api('/step1/ingest', 'POST');

    if (result.error) {
        document.getElementById('ingest-status').textContent = 'Ingestion issue';
        document.getElementById('ingest-progress').textContent = result.error;
        setTimeout(() => { step1Phase = 'data'; loadStep1(); }, 2000);
        return;
    }

    if (result.skipped) {
        document.getElementById('ingest-status').textContent = 'Organization saved!';
        document.getElementById('ingest-progress').textContent = result.message || 'Add data via file upload, URLs, or manual entry.';
        toast('Organization saved â€” add data from the Data Tables tab');
        setTimeout(() => { step1Phase = 'data'; loadStep1(); }, 1500);
        return;
    }

    const s = result.summary || {};
    document.getElementById('ingest-status').textContent = 'Data fetched successfully!';
    document.getElementById('ingest-progress').innerHTML =
        `Ticker: <strong>${s.ticker || 'N/A'}</strong> | Revenue periods: <strong>${s.financials || 0}</strong> | Ops metrics: <strong>${s.ops_metrics || 0}</strong> | Competitors: <strong>${s.competitors || 0}</strong>`;

    toast('Data ingestion complete');
    setTimeout(() => { step1Phase = 'data'; loadStep1(); }, 1500);
}

async function renderStep1Data(org) {
    const [units, revenue, ops, competitors, urls] = await Promise.all([
        api('/step1/business-units'),
        api('/step1/revenue-splits'),
        api('/step1/ops-efficiency'),
        api('/step1/competitors'),
        api('/step1/urls'),
    ]);

    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Step 1: Business Performance Dashboard</h2>
            <p>${org.name}${org.ticker ? ' (' + org.ticker + ')' : ''} â€” ${org.industry}${org.country ? ' | ' + org.country : ''}</p>
        </div>

        <div class="phase-tabs">
            <button class="phase-tab" onclick="step1Phase='setup'; renderStep1Setup()">Org Setup</button>
            <button class="phase-tab active">Data Tables</button>
            <button class="phase-tab" onclick="step1Phase='analysis'; renderStep1Analysis()">Analysis Dashboard</button>
            <button class="phase-tab" onclick="step1Phase='ai'; renderStep1AI()">AI Insights</button>
            <button class="btn-generate-all" onclick="startGenerateAll()" title="AI generates all 7 steps automatically">Generate All Steps</button>
        </div>

        <div class="metric-row">
            <div class="metric-card"><div class="metric-val">${units.length}</div><div class="metric-label">Business Units</div></div>
            <div class="metric-card"><div class="metric-val">${revenue.length}</div><div class="metric-label">Revenue Records</div></div>
            <div class="metric-card"><div class="metric-val">${ops.length}</div><div class="metric-label">Ops Metrics</div></div>
            <div class="metric-card"><div class="metric-val">${competitors.length}</div><div class="metric-label">Competitors</div></div>
        </div>

        <div class="card">
            <h3>Data Ingestion</h3>
            <div class="ingest-grid">
                <div class="ingest-column">
                    <h4>Upload Documents</h4>
                    <div class="drop-zone" id="step1-drop-zone" onclick="document.getElementById('step1-file-input').click()">
                        <div class="dz-icon">&#128196;</div>
                        <div class="dz-text">Drag & drop files here or click to browse</div>
                        <div class="dz-formats">CSV, Excel, JSON, PDF, Word, Images</div>
                    </div>
                    <input type="file" id="step1-file-input" style="display:none"
                        accept=".csv,.xlsx,.json,.pdf,.docx,.png,.jpg,.jpeg"
                        onchange="uploadStep1File()">
                    <div id="step1-upload-status"></div>
                </div>
                <div class="ingest-column">
                    <h4>Application URLs</h4>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="step1-url-input" placeholder="https://...">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Label</label>
                            <input type="text" id="step1-url-label" placeholder="Optional label">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="step1-url-type">
                                <option value="external">External</option>
                                <option value="internal">Internal App</option>
                                <option value="investor">Investor Page</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="addStep1Url()">Add URL</button>
                </div>
                <div class="ingest-column">
                    <h4>Auto-Fetch Sources</h4>
                    <button class="btn btn-primary btn-lg" onclick="refreshAllSources()" style="width:100%">Refresh All Sources</button>
                    <div style="margin-top:10px; display:flex; flex-direction:column; gap:6px;">
                        <span class="source-status configured">Finnhub + Alpha Vantage</span>
                        <span class="source-status ${(urls || []).length ? 'configured' : 'not-configured'}">${(urls || []).length || 0} Saved URLs</span>
                    </div>
                    <div id="step1-refresh-results"></div>
                </div>
            </div>
        </div>

        ${(urls || []).length ? `<div class="card">
            <h3>Saved URLs <button class="btn btn-primary btn-sm" onclick="fetchAllStep1Urls()">Fetch All URLs</button></h3>
            <table class="url-table">
                <tr><th>URL</th><th>Label</th><th>Type</th><th>Status</th><th>Last Fetched</th><th>Actions</th></tr>
                ${urls.map(u => `<tr>
                    <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${u.url}">${u.url}</td>
                    <td>${u.label || '-'}</td>
                    <td>${u.url_type || 'external'}</td>
                    <td><span class="url-status-${u.status || 'pending'}">${u.status || 'pending'}</span></td>
                    <td>${u.last_fetched_at ? new Date(u.last_fetched_at).toLocaleString() : '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="fetchStep1Url(${u.id})">Fetch</button>
                        <button class="btn btn-danger" onclick="deleteStep1Url(${u.id})">Del</button>
                    </td>
                </tr>`).join('')}
            </table>
        </div>` : ''}

        <div class="card card-collapsible" id="card-bus-units">
            <div class="card-header" onclick="toggleStep1Card('card-bus-units')">
                <h3 style="margin-bottom:0"><span class="toggle-arrow">&#9654;</span> Business Units (${units.length}) <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); addBusinessUnit()">+ Add Manual</button></h3>
            </div>
            <div class="card-body">
                ${units.length ? `<table>
                    <tr><th>Name</th><th>Description</th><th></th></tr>
                    ${units.map(u => `<tr>
                        <td>${u.name}</td><td>${u.description || '-'}</td>
                        <td><button class="btn btn-danger" onclick="deleteBusinessUnit(${u.id})">Delete</button></td>
                    </tr>`).join('')}
                </table>` : '<div class="empty"><p>No business units yet.</p></div>'}
            </div>
        </div>

        <div class="card card-collapsible" id="card-revenue">
            <div class="card-header" onclick="toggleStep1Card('card-revenue')">
                <h3 style="margin-bottom:0"><span class="toggle-arrow">&#9654;</span> Revenue Splits (${revenue.length}) <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); addRevenueSplit()">+ Add Manual</button></h3>
            </div>
            <div class="card-body">
                ${revenue.length ? `<table>
                    <tr><th>Business Unit</th><th>Dimension</th><th>Value</th><th>Revenue</th><th>Period</th></tr>
                    ${revenue.map(r => `<tr>
                        <td>${r.business_unit_name}</td><td>${r.dimension}</td><td>${r.dimension_value}</td>
                        <td>$${Number(r.revenue).toLocaleString()}</td><td>${r.period}</td>
                    </tr>`).join('')}
                </table>` : '<div class="empty"><p>No revenue data yet.</p></div>'}
            </div>
        </div>

        <div class="card card-collapsible" id="card-ops">
            <div class="card-header" onclick="toggleStep1Card('card-ops')">
                <h3 style="margin-bottom:0"><span class="toggle-arrow">&#9654;</span> Ops Efficiency (${ops.length}) <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); addOpsMetric()">+ Add Manual</button></h3>
            </div>
            <div class="card-body">
                ${ops.length ? `<table>
                    <tr><th>Business Unit</th><th>Metric</th><th>Value</th><th>Target</th><th>Period</th></tr>
                    ${ops.map(o => `<tr>
                        <td>${o.business_unit_name}</td><td>${o.metric_name}</td>
                        <td>${o.metric_value}</td><td>${o.target_value || '-'}</td><td>${o.period}</td>
                    </tr>`).join('')}
                </table>` : '<div class="empty"><p>No ops metrics yet.</p></div>'}
            </div>
        </div>

        <div class="card card-collapsible" id="card-competitors">
            <div class="card-header" onclick="toggleStep1Card('card-competitors')">
                <h3 style="margin-bottom:0"><span class="toggle-arrow">&#9654;</span> Competitors (${competitors.length}) <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); addCompetitor()">+ Add Manual</button></h3>
            </div>
            <div class="card-body">
                ${competitors.length ? `<table>
                    <tr><th>Name</th><th>Market Share</th><th>Strengths</th><th>Weaknesses</th></tr>
                    ${competitors.map(c => `<tr>
                        <td>${c.name}</td><td>${c.market_share ? c.market_share + '%' : '-'}</td>
                        <td>${c.strengths || '-'}</td><td>${c.weaknesses || '-'}</td>
                    </tr>`).join('')}
                </table>` : '<div class="empty"><p>No competitor data yet.</p></div>'}
            </div>
        </div>
        <div id="step1-gates" style="margin-top:20px;"></div>
    `;

    // Setup drag-and-drop
    const dz = document.getElementById('step1-drop-zone');
    if (dz) {
        dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
        dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
        dz.addEventListener('drop', e => {
            e.preventDefault();
            dz.classList.remove('drag-over');
            const fi = document.getElementById('step1-file-input');
            fi.files = e.dataTransfer.files;
            uploadStep1File();
        });
    }

    renderStepGates(1, 'step1-gates');
}

function toggleStep1Card(cardId) {
    const card = document.getElementById(cardId);
    if (card) card.classList.toggle('expanded');
}

async function uploadStep1File() {
    const fi = document.getElementById('step1-file-input');
    if (!fi.files.length) return;
    const statusDiv = document.getElementById('step1-upload-status');
    statusDiv.innerHTML = '<div class="spinner"></div> Uploading & extracting...';
    const formData = new FormData();
    formData.append('file', fi.files[0]);
    const result = await apiUpload('/step1/upload', formData);
    fi.value = '';
    if (result && result.success) {
        const s = result.summary || {};
        statusDiv.innerHTML = `<div class="refresh-result ok">Extracted: ${s.business_units || 0} BUs, ${s.revenue_splits || 0} revenue, ${s.ops_efficiency || 0} ops, ${s.competitors || 0} competitors</div>`;
        toast('File data extracted');
        setTimeout(() => loadStep1(), 1500);
    } else {
        statusDiv.innerHTML = `<div class="refresh-result error">${result?.error || 'Upload failed'}</div>`;
    }
}

async function addStep1Url() {
    const url = document.getElementById('step1-url-input').value.trim();
    if (!url) { alert('Enter a URL'); return; }
    const label = document.getElementById('step1-url-label').value.trim();
    const url_type = document.getElementById('step1-url-type').value;
    const result = await api('/step1/urls', 'POST', { url, label, url_type });
    if (result && result.success) {
        toast('URL added');
        document.getElementById('step1-url-input').value = '';
        document.getElementById('step1-url-label').value = '';
        loadStep1();
    } else {
        alert(result?.error || 'Failed to add URL');
    }
}

async function deleteStep1Url(id) {
    if (!confirm('Delete this URL?')) return;
    await api(`/step1/urls/${id}`, 'DELETE');
    toast('URL deleted');
    loadStep1();
}

async function fetchStep1Url(id) {
    toast('Fetching URL...');
    const result = await api(`/step1/urls/${id}/fetch`, 'POST');
    if (result && result.success) {
        const s = result.summary || {};
        toast(`Extracted: ${s.business_units || 0} BUs, ${s.revenue_splits || 0} revenue, ${s.ops_efficiency || 0} ops, ${s.competitors || 0} competitors`);
        loadStep1();
    } else {
        alert(result?.error || 'Fetch failed');
    }
}

async function fetchAllStep1Urls() {
    toast('Fetching all URLs...');
    const result = await api('/step1/urls/fetch-all', 'POST');
    if (result && result.success) {
        const count = (result.results || []).filter(r => r.status === 'success').length;
        toast(`Fetched ${count} of ${(result.results || []).length} URLs`);
        loadStep1();
    } else {
        alert(result?.error || 'Fetch all failed');
    }
}

async function refreshAllSources() {
    const resDiv = document.getElementById('step1-refresh-results');
    resDiv.innerHTML = '<div class="spinner"></div> Refreshing all sources...';
    const result = await api('/step1/refresh-all', 'POST');
    if (result && result.success) {
        const sources = result.sources || {};
        let html = '';
        for (const [src, info] of Object.entries(sources)) {
            const status = info.status || 'skipped';
            const label = src.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            let detail = '';
            if (status === 'ok') detail = info.summary ? JSON.stringify(info.summary) : (info.message || 'Done');
            else if (status === 'error') detail = info.error || 'Error';
            else detail = info.reason || 'Skipped';
            html += `<div class="refresh-result ${status}">${label}: ${detail}</div>`;
        }
        resDiv.innerHTML = html;
        toast('All sources refreshed');
        setTimeout(() => loadStep1(), 2000);
    } else {
        resDiv.innerHTML = `<div class="refresh-result error">${result?.error || 'Refresh failed'}</div>`;
    }
}

async function reingestData() {
    if (!confirm('Re-fetch data from APIs? This will add new data without removing existing entries.')) return;
    document.getElementById('main-content').innerHTML = `
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Re-fetching data...</p>
        </div>
    `;
    await api('/step1/ingest', 'POST');
    toast('Data re-fetched');
    step1Phase = 'data';
    loadStep1();
}

function fmtRevenue(v) {
    if (v == null) return '-';
    if (v >= 1e12) return '$' + (v / 1e12).toFixed(1) + 'T';
    if (v >= 1e9) return '$' + (v / 1e9).toFixed(1) + 'B';
    if (v >= 1e6) return '$' + (v / 1e6).toFixed(0) + 'M';
    return '$' + Number(v).toLocaleString();
}

function fmtMetric(name, val) {
    if (val == null) return '-';
    if (name.includes('Margin') || name.includes('Return')) return (val * 100).toFixed(1) + '%';
    if (name.includes('Revenue') || name.includes('Market Cap')) return fmtRevenue(val);
    return Number(val).toFixed(2);
}

async function renderStep1Analysis() {
    document.getElementById('main-content').innerHTML = `
        <div class="loading-overlay"><div class="spinner"></div><p>Loading analysis...</p></div>
    `;

    const data = await api('/step1/analysis');
    const org = data.organization || {};
    const swot = data.swot || { strengths: [], weaknesses: [], opportunities: [], threats: [] };
    const compComparison = data.competitor_comparison || [];
    const revComparison = data.revenue_comparison || { org: [], competitors: [] };

    // --- Revenue Comparison Chart (grouped bars) ---
    // Collect all periods across org + competitors
    const allPeriods = new Set();
    revComparison.org.forEach(r => allPeriods.add(r.period));
    revComparison.competitors.forEach(c => c.data.forEach(r => allPeriods.add(r.period)));
    const periods = [...allPeriods].sort();

    // Build lookup maps
    const orgRevMap = {};
    revComparison.org.forEach(r => { orgRevMap[r.period] = r.revenue; });
    const compRevMaps = revComparison.competitors.map(c => {
        const m = {}; c.data.forEach(r => { m[r.period] = r.revenue; }); return { name: c.name, map: m };
    });

    const colors = ['#0ea5e9', '#22c55e', '#f97316', '#a78bfa'];
    let allRevVals = revComparison.org.map(r => r.revenue || 0);
    revComparison.competitors.forEach(c => c.data.forEach(r => allRevVals.push(r.revenue || 0)));
    const maxRev = Math.max(...allRevVals, 1);

    let revenueChartHtml = '';
    if (periods.length) {
        const barsHtml = periods.map(p => {
            const orgVal = orgRevMap[p] || 0;
            const bars = [`<div class="g-bar" style="height:${(orgVal/maxRev*100).toFixed(0)}%;background:${colors[0]}" title="${org.name}: ${fmtRevenue(orgVal)}"><span class="g-val">${fmtRevenue(orgVal)}</span></div>`];
            compRevMaps.forEach((c, i) => {
                const v = c.map[p] || 0;
                bars.push(`<div class="g-bar" style="height:${(v/maxRev*100).toFixed(0)}%;background:${colors[i+1]}" title="${c.name}: ${fmtRevenue(v)}"><span class="g-val">${fmtRevenue(v)}</span></div>`);
            });
            return `<div class="bar-group"><div class="bar-group-bars">${bars.join('')}</div><div class="bar-group-label">${p}</div></div>`;
        }).join('');

        const legendItems = [`<div class="chart-legend-item"><div class="chart-legend-dot" style="background:${colors[0]}"></div>${org.name || 'Org'}</div>`];
        compRevMaps.forEach((c, i) => {
            legendItems.push(`<div class="chart-legend-item"><div class="chart-legend-dot" style="background:${colors[i+1]}"></div>${c.name}</div>`);
        });

        revenueChartHtml = `<div class="grouped-chart">${barsHtml}</div><div class="chart-legend">${legendItems.join('')}</div>`;
    } else {
        revenueChartHtml = '<div class="empty"><p>No revenue data</p></div>';
    }

    // --- Financial Metrics Comparison Table ---
    const metricNames = ['Profit Margin', 'Operating Margin', 'Return on Equity', 'Return on Assets', 'PE Ratio', 'EPS', 'Revenue (TTM)', 'Market Cap'];
    let metricsTableHtml = '';
    if (compComparison.length) {
        const orgMetrics = org.metrics || {};
        // Add Revenue TTM and Market Cap to org metrics for comparison
        const orgRevTTM = (data.ops_metrics || []).find(m => m.metric_name === 'Revenue (TTM)');
        if (!orgMetrics['Revenue (TTM)']) {
            const latestRev = revComparison.org.length ? revComparison.org[revComparison.org.length - 1].revenue : null;
            if (latestRev) orgMetrics['Revenue (TTM)'] = latestRev;
        }
        if (!orgMetrics['Market Cap'] && org.market_cap) orgMetrics['Market Cap'] = org.market_cap * 1e6; // market_cap is in millions

        const headerCols = [`<th>Metric</th><th>${org.name || 'Org'}</th>`];
        compComparison.forEach(c => headerCols.push(`<th>${c.name}</th>`));

        const rows = metricNames.map(metric => {
            const orgVal = orgMetrics[metric];
            const compVals = compComparison.map(c => c.metrics[metric]);
            const allVals = [orgVal, ...compVals].filter(v => v != null);

            // Determine best/worst (higher is better for most metrics, lower PE is better)
            const higherBetter = metric !== 'PE Ratio';
            const best = allVals.length ? (higherBetter ? Math.max(...allVals) : Math.min(...allVals)) : null;
            const worst = allVals.length ? (higherBetter ? Math.min(...allVals) : Math.max(...allVals)) : null;

            function cellClass(v) {
                if (v == null || allVals.length < 2) return '';
                if (v === best) return 'best';
                if (v === worst) return 'worst';
                return '';
            }

            let cells = `<td>${metric}</td>`;
            cells += `<td class="${cellClass(orgVal)}">${fmtMetric(metric, orgVal)}</td>`;
            compComparison.forEach(c => {
                const v = c.metrics[metric];
                cells += `<td class="${cellClass(v)}">${fmtMetric(metric, v)}</td>`;
            });
            return `<tr>${cells}</tr>`;
        }).join('');

        metricsTableHtml = `<table class="comparison-table"><tr>${headerCols.join('')}</tr>${rows}</table>`;
    } else {
        // Fallback: show org metrics only
        const opsHtml = (data.ops_metrics || [])
            .filter(m => m.business_unit_name === org.name)
            .map(m => {
                const val = fmtMetric(m.metric_name, m.metric_value);
                return `<div class="metric-card"><div class="metric-val">${val}</div><div class="metric-label">${m.metric_name}</div></div>`;
            }).join('');
        metricsTableHtml = `<div class="metric-row" style="flex-wrap:wrap">${opsHtml || '<div class="empty" style="width:100%"><p>No metrics available</p></div>'}</div>`;
    }

    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Step 1: Analysis Dashboard</h2>
            <p>${org.name ? org.name + (org.ticker ? ' (' + org.ticker + ')' : '') + ' â€” ' + org.industry : 'Organization analysis'}${compComparison.length ? ' vs ' + compComparison.map(c=>c.name).join(', ') : ''}</p>
        </div>

        <div class="phase-tabs">
            <button class="phase-tab" onclick="step1Phase='setup'; renderStep1Setup()">Org Setup</button>
            <button class="phase-tab" onclick="step1Phase='data'; loadStep1()">Data Tables</button>
            <button class="phase-tab active">Analysis Dashboard</button>
            <button class="phase-tab" onclick="step1Phase='ai'; renderStep1AI()">AI Insights</button>
        </div>

        ${org.market_cap ? `<div class="metric-row">
            <div class="metric-card"><div class="metric-val">$${org.market_cap >= 1000 ? (org.market_cap/1000).toFixed(0) + 'B' : org.market_cap.toFixed(0) + 'M'}</div><div class="metric-label">Market Cap</div></div>
            <div class="metric-card"><div class="metric-val">${org.ticker || 'N/A'}</div><div class="metric-label">Ticker</div></div>
            <div class="metric-card"><div class="metric-val">${org.country || 'N/A'}</div><div class="metric-label">Country</div></div>
            <div class="metric-card"><div class="metric-val">${org.currency || 'N/A'}</div><div class="metric-label">Currency</div></div>
        </div>` : ''}

        <div class="card">
            <h3>Revenue Comparison${compComparison.length ? '' : ' Trend'}</h3>
            ${revenueChartHtml}
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>${compComparison.length ? 'Financial Metrics Comparison' : 'Key Financial Metrics'}</h3>
            ${metricsTableHtml}
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>Auto-Generated SWOT Analysis
                <button class="btn btn-success btn-sm" onclick="saveSwotToStep3()">Save to Step 3</button>
            </h3>
            <div class="swot-grid">
                <div class="swot-quad strengths">
                    <h4>Strengths</h4>
                    <ul>${swot.strengths.map(s => `<li>${typeof s === 'string' ? s : s.description}</li>`).join('')}</ul>
                </div>
                <div class="swot-quad weaknesses">
                    <h4>Weaknesses</h4>
                    <ul>${swot.weaknesses.map(w => `<li>${typeof w === 'string' ? w : w.description}</li>`).join('')}</ul>
                </div>
                <div class="swot-quad opportunities">
                    <h4>Opportunities</h4>
                    <ul>${swot.opportunities.map(o => `<li>${typeof o === 'string' ? o : o.description}</li>`).join('')}</ul>
                </div>
                <div class="swot-quad threats">
                    <h4>Threats</h4>
                    <ul>${swot.threats.map(t => `<li>${typeof t === 'string' ? t : t.description}</li>`).join('')}</ul>
                </div>
            </div>
        </div>
        <div id="step1-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(1, 'step1-gates');
}

async function saveSwotToStep3() {
    const data = await api('/step1/analysis');
    const swot = data.swot;
    const entries = [];
    swot.strengths.forEach(s => entries.push({ category: 'strength', description: typeof s === 'string' ? s : s.description, severity: (s && s.severity) || 'medium', confidence: (s && s.confidence) || 'medium' }));
    swot.weaknesses.forEach(w => entries.push({ category: 'weakness', description: typeof w === 'string' ? w : w.description, severity: (w && w.severity) || 'medium', confidence: (w && w.confidence) || 'medium' }));
    swot.opportunities.forEach(o => entries.push({ category: 'opportunity', description: typeof o === 'string' ? o : o.description, severity: (o && o.severity) || 'medium', confidence: (o && o.confidence) || 'medium' }));
    swot.threats.forEach(t => entries.push({ category: 'threat', description: typeof t === 'string' ? t : t.description, severity: (t && t.severity) || 'medium', confidence: (t && t.confidence) || 'medium' }));
    const result = await api('/step1/analysis/save-swot', 'POST', { entries });
    toast(`${result.saved || 0} SWOT entries saved to Step 3`);
}

async function addBusinessUnit() {
    const name = prompt('Business Unit name:');
    if (!name) return;
    const description = prompt('Description (optional):');
    await api('/step1/business-units', 'POST', { name, description });
    toast('Business Unit added');
    loadStep1();
}

async function deleteBusinessUnit(id) {
    if (!confirm('Delete this business unit?')) return;
    await api(`/step1/business-units/${id}`, 'DELETE');
    toast('Deleted');
    loadStep1();
}

async function addRevenueSplit() {
    const units = await api('/step1/business-units');
    if (!units.length) { alert('Add a business unit first.'); return; }
    const buId = prompt('Business Unit ID (' + units.map(u => u.id + '=' + u.name).join(', ') + '):');
    const dimension = prompt('Dimension (product/region/segment):');
    const dimension_value = prompt('Dimension value:');
    const revenue = prompt('Revenue amount:');
    const period = prompt('Period (e.g. 2026-Q1):');
    await api('/step1/revenue-splits', 'POST', { business_unit_id: +buId, dimension, dimension_value, revenue: +revenue, period });
    toast('Revenue split added');
    loadStep1();
}

async function addOpsMetric() {
    const units = await api('/step1/business-units');
    if (!units.length) { alert('Add a business unit first.'); return; }
    const buId = prompt('Business Unit ID (' + units.map(u => u.id + '=' + u.name).join(', ') + '):');
    const metric_name = prompt('Metric name:');
    const metric_value = prompt('Current value:');
    const target_value = prompt('Target value (optional):');
    const period = prompt('Period:');
    await api('/step1/ops-efficiency', 'POST', { business_unit_id: +buId, metric_name, metric_value: +metric_value, target_value: target_value ? +target_value : null, period });
    toast('Ops metric added');
    loadStep1();
}

async function addCompetitor() {
    const name = prompt('Competitor name:');
    if (!name) return;
    const market_share = prompt('Market share % (optional):');
    const strengths = prompt('Strengths (optional):');
    const weaknesses = prompt('Weaknesses (optional):');
    await api('/step1/competitors', 'POST', { name, market_share: market_share ? +market_share : null, strengths, weaknesses });
    toast('Competitor added');
    loadStep1();
}

// ===================== STEP 1: AI Insights =====================

function toggleAiSection(id) {
    const section = document.getElementById(id);
    const body = section.querySelector('.ai-section-body');
    const arrow = section.querySelector('.toggle-arrow');
    const isOpen = body.classList.contains('open');
    body.classList.toggle('open');
    arrow.classList.toggle('open');
    section.classList.toggle('expanded');
}

function aiSectionHtml(id, icon, title, bodyId) {
    return `<div class="ai-section" id="${id}">
        <div class="ai-section-header" onclick="toggleAiSection('${id}')">
            <h4>${icon} ${title} <span class="ai-badge">AI</span></h4>
            <span class="toggle-arrow">&#9654;</span>
        </div>
        <div class="ai-section-body" id="${bodyId}"></div>
    </div>`;
}

async function renderStep1AI() {
    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Step 1: AI-Powered Insights</h2>
            <p>AI analysis, forecasting, anomaly detection, and natural language querying across all transformation data.</p>
        </div>

        <div class="phase-tabs">
            <button class="phase-tab" onclick="step1Phase='setup'; renderStep1Setup()">Org Setup</button>
            <button class="phase-tab" onclick="step1Phase='data'; loadStep1()">Data Tables</button>
            <button class="phase-tab" onclick="step1Phase='analysis'; renderStep1Analysis()">Analysis Dashboard</button>
            <button class="phase-tab active">AI Insights</button>
        </div>

        ${aiSectionHtml('ai-sec-exec', '&#128202;', 'Executive Summary', 'ai-body-exec')}
        ${aiSectionHtml('ai-sec-financial', '&#128176;', 'AI Financial Analysis', 'ai-body-financial')}
        ${aiSectionHtml('ai-sec-trends', '&#128200;', 'Trends & Forecasting', 'ai-body-trends')}
        ${aiSectionHtml('ai-sec-anomaly', '&#9888;', 'Anomaly Detection', 'ai-body-anomaly')}
        ${aiSectionHtml('ai-sec-competitors', '&#127942;', 'Competitor Discovery', 'ai-body-competitors')}
        ${aiSectionHtml('ai-sec-enrich', '&#128269;', 'Data Enrichment', 'ai-body-enrich')}
        ${aiSectionHtml('ai-sec-health', '&#128154;', 'Transformation Health', 'ai-body-health')}
        ${aiSectionHtml('ai-sec-nlq', '&#128172;', 'Ask a Question', 'ai-body-nlq')}
        ${aiSectionHtml('ai-sec-scenario', '&#127919;', 'What-If Scenarios', 'ai-body-scenario')}
        ${aiSectionHtml('ai-sec-report', '&#128196;', 'Report Generation', 'ai-body-report')}
        <div id="step1-gates" style="margin-top:20px;"></div>
    `;

    // Pre-populate section bodies with controls
    _initExecSection();
    _initFinancialSection();
    _initTrendsSection();
    _initAnomalySection();
    _initCompetitorSection();
    _initEnrichSection();
    _initHealthSection();
    _initNlqSection();
    _initScenarioSection();
    _initReportSection();
    renderStepGates(1, 'step1-gates');
}

function _initExecSection() {
    document.getElementById('ai-body-exec').innerHTML = `
        <button class="btn btn-primary btn-sm" onclick="generateExecSummary(false)">Generate Summary</button>
        <button class="btn btn-sm" style="background:#334155;color:#94a3b8;margin-left:8px;" onclick="generateExecSummary(true)">Refresh</button>
        <div id="exec-result" style="margin-top:16px;"></div>`;
}

function _initFinancialSection() {
    document.getElementById('ai-body-financial').innerHTML = `
        <button class="btn btn-primary btn-sm" onclick="generateFinancialAnalysis()">Analyze Financials</button>
        <div id="financial-result" style="margin-top:16px;"></div>`;
}

function _initTrendsSection() {
    document.getElementById('ai-body-trends').innerHTML = `
        <button class="btn btn-primary btn-sm" onclick="generateTrendAnalysis()">Forecast Trends</button>
        <div id="trends-result" style="margin-top:16px;"></div>`;
}

function _initAnomalySection() {
    document.getElementById('ai-body-anomaly').innerHTML = `
        <button class="btn btn-primary btn-sm" onclick="runAnomalyDetection()">Scan for Anomalies</button>
        <div id="anomaly-result" style="margin-top:16px;"></div>`;
}

function _initCompetitorSection() {
    document.getElementById('ai-body-competitors').innerHTML = `
        <button class="btn btn-primary btn-sm" onclick="discoverCompetitors()">Discover Competitors</button>
        <div id="competitor-result" style="margin-top:16px;"></div>`;
}

function _initEnrichSection() {
    document.getElementById('ai-body-enrich').innerHTML = `
        <button class="btn btn-primary btn-sm" onclick="getEnrichmentSuggestions()">Get Suggestions</button>
        <div id="enrich-result" style="margin-top:16px;"></div>`;
}

function _initHealthSection() {
    document.getElementById('ai-body-health').innerHTML = `
        <button class="btn btn-primary btn-sm" onclick="checkTransformationHealth()">Assess Health</button>
        <div id="health-result" style="margin-top:16px;"></div>`;
}

function _initNlqSection() {
    document.getElementById('ai-body-nlq').innerHTML = `
        <div class="form-row">
            <div class="form-group" style="flex:4;">
                <input type="text" id="nlq-input" placeholder="Ask anything about your organization data..." onkeydown="if(event.key==='Enter')askQuestion()" />
            </div>
            <div class="form-group" style="flex:0;min-width:auto;">
                <button class="btn btn-primary" onclick="askQuestion()">Ask</button>
            </div>
        </div>
        <div id="nlq-result" style="margin-top:12px;"></div>`;
}

function _initScenarioSection() {
    document.getElementById('ai-body-scenario').innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <label>Scenario Type</label>
                <select id="scenario-type">
                    <option value="revenue_change">Revenue Change</option>
                    <option value="market_entry">Market Entry</option>
                    <option value="cost_change">Cost Change</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label>Scenario Name</label>
                <input type="text" id="scenario-name" placeholder="e.g. 20% Revenue Growth" />
            </div>
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label>Description / Parameters</label>
            <textarea id="scenario-desc" rows="2" placeholder="Describe the scenario... e.g. Revenue increases by 20% due to new product launch"></textarea>
        </div>
        <button class="btn btn-primary btn-sm" onclick="runScenario()">Model Scenario</button>
        <div id="scenario-result" style="margin-top:16px;"></div>`;
}

function _initReportSection() {
    document.getElementById('ai-body-report').innerHTML = `
        <div class="form-row" style="align-items:flex-end;">
            <div class="form-group">
                <label>Audience</label>
                <select id="report-audience">
                    <option value="c_suite">C-Suite</option>
                    <option value="board">Board</option>
                    <option value="technical">Technical</option>
                </select>
            </div>
            <div class="form-group" style="flex:0;min-width:auto;">
                <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
            </div>
        </div>
        <div id="report-result" style="margin-top:16px;"></div>`;
}

// --- AI Section JS Functions ---

function _showLoading(el) { el.innerHTML = '<div class="ai-loading"><div class="spinner"></div><p style="color:#94a3b8;font-size:13px;margin-top:8px;">Analyzing with AI...</p></div>'; }
function _showError(el, msg) { el.innerHTML = `<div style="color:#fca5a5;font-size:13px;padding:12px;background:#7f1d1d33;border:1px solid #7f1d1d;border-radius:8px;">${msg}<br><span style="color:#94a3b8;font-size:12px;margin-top:4px;display:inline-block;">Check that OPENAI_API_KEY is valid on Render. The AI features require a working OpenAI API key.</span></div>`; }
function _severityBadge(s) { return `<span class="severity-badge severity-${s||'medium'}">${s||'medium'}</span>`; }
function _confidenceBadge(c) { return `<span class="confidence-badge confidence-${c||'medium'}">${c||'medium'}</span>`; }
function _impactBadge(i) {
    const colors = {high:'severity-high',medium:'severity-medium',low:'severity-low'};
    return `<span class="severity-badge ${colors[i]||'severity-medium'}">${i||'medium'}</span>`;
}
function _scoreColor(s) {
    if (s >= 75) return '#059669';
    if (s >= 50) return '#d97706';
    if (s >= 25) return '#f97316';
    return '#dc2626';
}

async function generateExecSummary(refresh) {
    const el = document.getElementById('exec-result');
    _showLoading(el);
    const data = await api('/step1/ai/executive-summary', 'POST', { refresh: !!refresh });
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    el.innerHTML = `
        <div style="font-size:18px;font-weight:700;color:#38bdf8;margin-bottom:12px;">${data.headline || ''}</div>
        ${(data.summary_paragraphs||[]).map(p => `<p style="font-size:13px;color:#e2e8f0;margin-bottom:10px;line-height:1.6;">${p}</p>`).join('')}
        ${data.key_findings && data.key_findings.length ? `
            <h4 style="font-size:14px;margin:16px 0 8px;color:#f1f5f9;">Key Findings</h4>
            ${data.key_findings.map(f => `<div style="padding:8px 12px;background:#0f172a;border-radius:6px;margin-bottom:6px;font-size:13px;">
                ${f.finding} ${_impactBadge(f.impact)} <span class="confidence-badge confidence-${f.action_required==='immediate'?'high':f.action_required==='short_term'?'medium':'low'}">${(f.action_required||'').replace('_',' ')}</span>
            </div>`).join('')}` : ''}
        ${data.competitor_narrative ? `<div style="margin-top:12px;padding:12px;background:#1e3a5f33;border-radius:8px;font-size:13px;color:#7dd3fc;"><strong>Competitive Position:</strong> ${data.competitor_narrative}</div>` : ''}
        ${data.strategic_implications && data.strategic_implications.length ? `
            <h4 style="font-size:14px;margin:16px 0 8px;color:#f1f5f9;">Strategic Implications</h4>
            ${data.strategic_implications.map(si => `<div style="padding:8px 12px;background:#0f172a;border-radius:6px;margin-bottom:6px;font-size:13px;">
                ${si.implication} <span class="severity-badge severity-medium">${(si.timeframe||'').replace('_',' ')}</span>
                ${si.recommended_action ? `<div style="color:#94a3b8;margin-top:4px;font-size:12px;">Action: ${si.recommended_action}</div>` : ''}
            </div>`).join('')}` : ''}
        ${data.cached ? '<div style="margin-top:8px;font-size:11px;color:#64748b;">Cached result. Click Refresh for new analysis.</div>' : ''}
    `;
}

async function generateFinancialAnalysis() {
    const el = document.getElementById('financial-result');
    _showLoading(el);
    const data = await api('/step1/ai/financial-analysis', 'POST', {});
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    const swotHtml = ['strengths','weaknesses','opportunities','threats'].map(cat => `
        <div class="swot-quad ${cat}">
            <h4>${cat.charAt(0).toUpperCase()+cat.slice(1)}</h4>
            <ul>${(data[cat]||[]).map(e => `<li>${e.description||e} ${_severityBadge(e.severity)} ${_confidenceBadge(e.confidence)}</li>`).join('')}</ul>
        </div>`).join('');

    el.innerHTML = `
        <div class="swot-grid">${swotHtml}</div>
        ${data.key_insights && data.key_insights.length ? `
            <h4 style="font-size:14px;margin:16px 0 8px;color:#f1f5f9;">Key Insights</h4>
            ${data.key_insights.map(ki => `<div style="padding:10px 12px;background:#0f172a;border-radius:6px;margin-bottom:6px;font-size:13px;">
                <div style="font-weight:600;color:#38bdf8;">${ki.insight}</div>
                ${ki.supporting_data ? `<div style="color:#94a3b8;margin-top:4px;font-size:12px;">${ki.supporting_data}</div>` : ''}
                ${ki.strategic_implication ? `<div style="color:#6ee7b7;margin-top:2px;font-size:12px;">Implication: ${ki.strategic_implication}</div>` : ''}
            </div>`).join('')}` : ''}
        <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
            <div style="font-size:12px;color:#94a3b8;">Data Quality:</div>
            <div style="flex:1;height:8px;background:#334155;border-radius:4px;overflow:hidden;"><div style="height:100%;width:${data.data_quality_score||0}%;background:${_scoreColor(data.data_quality_score||0)};border-radius:4px;"></div></div>
            <div style="font-size:12px;font-weight:600;color:${_scoreColor(data.data_quality_score||0)};">${data.data_quality_score||0}%</div>
            ${_confidenceBadge(data.analysis_confidence)}
        </div>
        ${data.cached ? '<div style="margin-top:8px;font-size:11px;color:#64748b;">Cached result.</div>' : ''}
    `;
}

async function generateTrendAnalysis() {
    const el = document.getElementById('trends-result');
    _showLoading(el);
    const data = await api('/step1/ai/trend-analysis');
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    const rt = data.revenue_trend || {};
    const dirColors = {growing:'#059669',declining:'#dc2626',stable:'#d97706',volatile:'#a78bfa'};

    el.innerHTML = `
        <div class="metric-row">
            <div class="metric-card"><div class="metric-val" style="color:${dirColors[rt.direction]||'#38bdf8'}">${(rt.direction||'N/A').toUpperCase()}</div><div class="metric-label">Direction</div></div>
            <div class="metric-card"><div class="metric-val">${rt.cagr_pct != null ? rt.cagr_pct.toFixed(1)+'%' : 'N/A'}</div><div class="metric-label">CAGR</div></div>
        </div>
        ${rt.narrative ? `<p style="font-size:13px;color:#e2e8f0;margin:12px 0;line-height:1.6;">${rt.narrative}</p>` : ''}
        ${rt.yoy_growth_rates && rt.yoy_growth_rates.length ? `
            <h4 style="font-size:13px;color:#94a3b8;margin:12px 0 8px;">Year-over-Year Growth</h4>
            <table><tr><th>Period</th><th>Growth Rate</th></tr>
            ${rt.yoy_growth_rates.map(y => `<tr><td>${y.period||''}</td><td style="color:${(y.rate_pct||0)>=0?'#6ee7b7':'#fca5a5'}">${y.rate_pct != null ? y.rate_pct.toFixed(1)+'%' : '-'}</td></tr>`).join('')}
            </table>` : ''}
        ${data.forecasts && data.forecasts.length ? `
            <h4 style="font-size:13px;color:#94a3b8;margin:16px 0 8px;">Forecasts</h4>
            <div class="metric-row">${data.forecasts.map(f => `
                <div class="forecast-card">
                    <div class="forecast-val">${fmtRevenue(f.revenue_estimate)}</div>
                    <div class="forecast-range">${f.confidence_interval_low ? fmtRevenue(f.confidence_interval_low)+' â€” '+fmtRevenue(f.confidence_interval_high) : ''}</div>
                    <div class="forecast-label">${f.period||'Forecast'}</div>
                    ${f.methodology ? `<div style="font-size:10px;color:#64748b;margin-top:4px;">${f.methodology}</div>` : ''}
                </div>`).join('')}</div>` : ''}
        ${data.metric_trajectories && data.metric_trajectories.length ? `
            <h4 style="font-size:13px;color:#94a3b8;margin:16px 0 8px;">Metric Trajectories</h4>
            <table><tr><th>Metric</th><th>Current</th><th>Trajectory</th><th>Rate of Change</th></tr>
            ${data.metric_trajectories.map(mt => {
                const trajColor = mt.trajectory==='improving'?'#6ee7b7':mt.trajectory==='declining'?'#fca5a5':'#fbbf24';
                const trajArrow = mt.trajectory==='improving'?'&#9650;':mt.trajectory==='declining'?'&#9660;':'&#9654;';
                return `<tr><td>${mt.metric_name||''}</td><td>${mt.current_value!=null?mt.current_value:'-'}</td><td style="color:${trajColor}">${trajArrow} ${mt.trajectory||''}</td><td>${mt.rate_of_change||'-'}</td></tr>`;
            }).join('')}</table>` : ''}
        ${data.risk_indicators && data.risk_indicators.length ? `
            <h4 style="font-size:13px;color:#fca5a5;margin:16px 0 8px;">Risk Indicators</h4>
            <ul style="list-style:none;padding:0;">${data.risk_indicators.map(r => `<li style="font-size:13px;color:#fca5a5;margin-bottom:4px;">&#9888; ${r}</li>`).join('')}</ul>` : ''}
    `;
}

async function runAnomalyDetection() {
    const el = document.getElementById('anomaly-result');
    _showLoading(el);
    const data = await api('/step1/ai/anomaly-detection');
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    const health = data.overall_data_health || {};

    el.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="font-size:13px;color:#94a3b8;">Data Health Score:</div>
            <div style="flex:1;height:10px;background:#334155;border-radius:5px;overflow:hidden;"><div style="height:100%;width:${health.score||0}%;background:${_scoreColor(health.score||0)};border-radius:5px;"></div></div>
            <div style="font-size:14px;font-weight:700;color:${_scoreColor(health.score||0)};">${health.score||0}/100</div>
        </div>
        ${data.anomalies && data.anomalies.length ? `
            <h4 style="font-size:14px;color:#fca5a5;margin-bottom:8px;">Anomalies Detected</h4>
            ${data.anomalies.map(a => `<div class="anomaly-card">
                <div class="anomaly-title">${a.metric_name||''} â€” ${a.entity||''} ${_severityBadge(a.severity)}</div>
                <div class="anomaly-detail">Value: ${a.value!=null?a.value:'-'} | Expected: ${a.expected_range||'-'}</div>
                ${a.explanation ? `<div class="anomaly-detail" style="color:#94a3b8;">${a.explanation}</div>` : ''}
                ${a.possible_cause ? `<div class="anomaly-detail" style="color:#fbbf24;font-size:12px;">Possible cause: ${a.possible_cause}</div>` : ''}
            </div>`).join('')}` : '<p style="color:#6ee7b7;font-size:13px;">No anomalies detected.</p>'}
        ${data.data_quality_issues && data.data_quality_issues.length ? `
            <h4 style="font-size:14px;color:#fbbf24;margin:16px 0 8px;">Data Quality Issues</h4>
            ${data.data_quality_issues.map(dq => `<div class="warning-card">
                <div class="warning-title">${dq.issue||''}</div>
                <div class="warning-detail">${dq.affected_entity ? 'Affected: '+dq.affected_entity : ''}</div>
                ${dq.recommendation ? `<div class="warning-detail" style="color:#94a3b8;font-size:12px;">Recommendation: ${dq.recommendation}</div>` : ''}
            </div>`).join('')}` : ''}
        ${data.benchmark_deviations && data.benchmark_deviations.length ? `
            <h4 style="font-size:14px;color:#94a3b8;margin:16px 0 8px;">Benchmark Deviations</h4>
            <table><tr><th>Metric</th><th>Entity</th><th>Deviation</th><th>Direction</th><th>Significance</th></tr>
            ${data.benchmark_deviations.map(bd => `<tr>
                <td>${bd.metric||''}</td><td>${bd.entity||''}</td>
                <td>${bd.deviation_pct!=null?bd.deviation_pct.toFixed(1)+'%':'-'}</td>
                <td style="color:${bd.direction==='above'?'#6ee7b7':'#fca5a5'}">${bd.direction||''}</td>
                <td>${_severityBadge(bd.significance==='significant'?'high':bd.significance==='moderate'?'medium':'low')}</td>
            </tr>`).join('')}</table>` : ''}
        ${health.missing_critical_fields && health.missing_critical_fields.length ? `
            <div style="margin-top:12px;font-size:12px;color:#94a3b8;">Missing fields: ${health.missing_critical_fields.join(', ')}</div>` : ''}
    `;
}

async function discoverCompetitors() {
    const el = document.getElementById('competitor-result');
    _showLoading(el);
    const data = await api('/step1/ai/discover-competitors', 'POST', {});
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    const pos = data.competitive_positioning || {};

    el.innerHTML = `
        ${data.discovered_competitors && data.discovered_competitors.length ? `
            <h4 style="font-size:14px;color:#f1f5f9;margin-bottom:8px;">Discovered Competitors</h4>
            <table><tr><th>Name</th><th>Ticker</th><th>Relevance</th><th>Threat</th><th>Rationale</th><th></th></tr>
            ${data.discovered_competitors.map((c,i) => {
                const threatPct = (c.threat_score||5)*10;
                const threatColor = c.threat_score>=7?'#dc2626':c.threat_score>=4?'#d97706':'#059669';
                return `<tr>
                    <td><strong>${c.name||''}</strong></td><td>${c.ticker||'-'}</td>
                    <td><span class="severity-badge severity-${c.relevance==='direct'?'high':c.relevance==='emerging'?'medium':'low'}">${c.relevance||''}</span></td>
                    <td><div class="threat-bar" style="width:80px;"><div class="threat-bar-fill" style="width:${threatPct}%;background:${threatColor};"></div></div> <span style="font-size:11px;color:${threatColor};">${c.threat_score}/10</span></td>
                    <td style="font-size:12px;color:#94a3b8;max-width:200px;">${c.rationale||''}</td>
                    <td><button class="btn btn-success btn-sm" onclick="saveDiscoveredCompetitor(${i})">Save</button></td>
                </tr>`;
            }).join('')}</table>` : '<p style="color:#94a3b8;font-size:13px;">No new competitors discovered.</p>'}
        ${pos.org_position ? `
            <div style="margin-top:16px;padding:14px;background:#0f172a;border-radius:8px;">
                <h4 style="font-size:13px;color:#94a3b8;margin-bottom:8px;">Competitive Positioning</h4>
                <div style="font-size:14px;font-weight:600;color:#38bdf8;margin-bottom:8px;">Position: ${(pos.org_position||'').replace('_',' ').toUpperCase()}</div>
                ${pos.market_dynamics ? `<p style="font-size:13px;color:#e2e8f0;margin-bottom:8px;">${pos.market_dynamics}</p>` : ''}
                ${pos.key_differentiators && pos.key_differentiators.length ? `<div style="font-size:12px;color:#6ee7b7;">Differentiators: ${pos.key_differentiators.join(', ')}</div>` : ''}
                ${pos.vulnerability_areas && pos.vulnerability_areas.length ? `<div style="font-size:12px;color:#fca5a5;margin-top:4px;">Vulnerabilities: ${pos.vulnerability_areas.join(', ')}</div>` : ''}
            </div>` : ''}
        ${data.market_opportunities && data.market_opportunities.length ? `
            <h4 style="font-size:14px;color:#f1f5f9;margin:16px 0 8px;">Market Opportunities</h4>
            ${data.market_opportunities.map(mo => `<div style="padding:8px 12px;background:#0f172a;border-radius:6px;margin-bottom:6px;font-size:13px;">
                <div>${mo.opportunity||''} ${_impactBadge(mo.estimated_impact)}</div>
                ${mo.competitor_gap ? `<div style="font-size:12px;color:#94a3b8;margin-top:2px;">Gap: ${mo.competitor_gap}</div>` : ''}
            </div>`).join('')}` : ''}
    `;

    // Store competitors data for save function
    window._discoveredCompetitors = data.discovered_competitors || [];
}

async function saveDiscoveredCompetitor(index) {
    const comps = window._discoveredCompetitors || [];
    if (!comps[index]) return;
    const result = await api('/step1/ai/discover-competitors/save', 'POST', { competitors: [comps[index]] });
    toast(`${result.saved||0} competitor saved`);
}

async function getEnrichmentSuggestions() {
    const el = document.getElementById('enrich-result');
    _showLoading(el);
    const data = await api('/step1/ai/enrichment-suggestions');
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    el.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="font-size:13px;color:#94a3b8;">Data Completeness:</div>
            <div style="flex:1;height:10px;background:#334155;border-radius:5px;overflow:hidden;"><div style="height:100%;width:${data.data_completeness_score||0}%;background:${_scoreColor(data.data_completeness_score||0)};border-radius:5px;"></div></div>
            <div style="font-size:14px;font-weight:700;color:${_scoreColor(data.data_completeness_score||0)};">${data.data_completeness_score||0}%</div>
        </div>
        ${data.missing_metrics && data.missing_metrics.length ? `
            <h4 style="font-size:14px;color:#f1f5f9;margin-bottom:8px;">Missing Metrics</h4>
            ${data.missing_metrics.map(mm => `<div style="padding:10px 12px;background:#0f172a;border-radius:6px;margin-bottom:6px;font-size:13px;">
                <div><strong>${mm.metric_name||''}</strong> ${_impactBadge(mm.importance)}</div>
                ${mm.industry_typical_range ? `<div style="font-size:12px;color:#94a3b8;margin-top:2px;">Typical range: ${mm.industry_typical_range}</div>` : ''}
                ${mm.how_to_obtain ? `<div style="font-size:12px;color:#7dd3fc;margin-top:2px;">How: ${mm.how_to_obtain}</div>` : ''}
            </div>`).join('')}` : ''}
        ${data.suggested_business_units && data.suggested_business_units.length ? `
            <h4 style="font-size:14px;color:#f1f5f9;margin:16px 0 8px;">Suggested Business Units</h4>
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
            ${data.suggested_business_units.map(bu => `<div class="nlq-chip" title="${bu.rationale||''}">${bu.name||''}</div>`).join('')}
            </div>` : ''}
        ${data.revenue_dimensions && data.revenue_dimensions.length ? `
            <h4 style="font-size:14px;color:#f1f5f9;margin:16px 0 8px;">Revenue Dimensions</h4>
            ${data.revenue_dimensions.map(rd => `<div style="padding:8px 12px;background:#0f172a;border-radius:6px;margin-bottom:4px;font-size:13px;">
                <span class="severity-badge severity-medium">${rd.dimension||''}</span> ${rd.dimension_value||''} <span style="font-size:11px;color:#94a3b8;">â€” ${rd.rationale||''}</span>
            </div>`).join('')}` : ''}
        ${data.priority_actions && data.priority_actions.length ? `
            <h4 style="font-size:14px;color:#f1f5f9;margin:16px 0 8px;">Priority Actions</h4>
            <ol style="padding-left:18px;">${data.priority_actions.map(pa => `<li style="font-size:13px;color:#e2e8f0;margin-bottom:4px;">${pa}</li>`).join('')}</ol>` : ''}
    `;
}

async function checkTransformationHealth() {
    const el = document.getElementById('health-result');
    _showLoading(el);
    const data = await api('/step1/ai/transformation-health');
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    const score = data.overall_health_score || 0;
    const readinessColors = {ready:'#059669',nearly_ready:'#d97706',needs_work:'#f97316',not_ready:'#dc2626'};
    const stepNames = ['','Performance Dashboard','Value Stream Analysis','SWOT/TOWS Engine','Strategy & OKRs','Initiatives & RICE','Epics & Roadmap','Features & Roadmap'];

    el.innerHTML = `
        <div style="text-align:center;margin-bottom:16px;">
            <div class="health-score-circle" style="background:${_scoreColor(score)}22;border:3px solid ${_scoreColor(score)};">
                <span style="color:${_scoreColor(score)};">${score}</span>
            </div>
            <div style="font-size:14px;font-weight:600;color:${readinessColors[data.transformation_readiness]||'#94a3b8'};">${(data.transformation_readiness||'').replace('_',' ').toUpperCase()}</div>
        </div>
        ${data.step_scores && data.step_scores.length ? `
            <div class="health-score-bar">
                ${data.step_scores.map(ss => {
                    const s = ss.score||0;
                    return `<div class="step-seg" style="background:${_scoreColor(s)};opacity:0.85;" title="Step ${ss.step}: ${stepNames[ss.step]||ss.name||''} â€” ${s}/100">
                        <span>${ss.step||''}</span>
                    </div>`;
                }).join('')}
            </div>
            ${data.step_scores.map(ss => `<div style="padding:10px 12px;background:#0f172a;border-radius:6px;margin-bottom:6px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;font-weight:600;color:#f1f5f9;">Step ${ss.step}: ${stepNames[ss.step]||ss.name||''}</span>
                    <span style="font-size:13px;font-weight:700;color:${_scoreColor(ss.score||0)};">${ss.score||0}/100</span>
                </div>
                <div style="display:flex;gap:8px;margin-top:6px;align-items:center;">
                    <div style="flex:1;height:6px;background:#334155;border-radius:3px;overflow:hidden;"><div style="height:100%;width:${ss.completeness_pct||0}%;background:${_scoreColor(ss.completeness_pct||0)};border-radius:3px;"></div></div>
                    <span style="font-size:11px;color:#94a3b8;">${ss.completeness_pct||0}%</span>
                    <span class="severity-badge severity-${ss.quality_rating==='excellent'||ss.quality_rating==='good'?'low':ss.quality_rating==='fair'?'medium':'high'}">${ss.quality_rating||''}</span>
                </div>
                ${ss.issues && ss.issues.length ? `<div style="font-size:12px;color:#fca5a5;margin-top:4px;">${ss.issues.join('; ')}</div>` : ''}
                ${ss.recommendations && ss.recommendations.length ? `<div style="font-size:12px;color:#7dd3fc;margin-top:2px;">${ss.recommendations.join('; ')}</div>` : ''}
            </div>`).join('')}` : ''}
        ${data.critical_gaps && data.critical_gaps.length ? `
            <h4 style="font-size:14px;color:#fca5a5;margin:16px 0 8px;">Critical Gaps</h4>
            ${data.critical_gaps.map(cg => `<div class="anomaly-card">
                <div class="anomaly-title">${cg.gap||''} ${_severityBadge(cg.priority)}</div>
                <div class="anomaly-detail">Affected steps: ${(cg.affected_steps||[]).join(', ')}</div>
                ${cg.remediation ? `<div class="anomaly-detail" style="color:#7dd3fc;font-size:12px;">Remediation: ${cg.remediation}</div>` : ''}
            </div>`).join('')}` : ''}
        ${data.next_actions && data.next_actions.length ? `
            <h4 style="font-size:14px;color:#f1f5f9;margin:16px 0 8px;">Recommended Next Actions</h4>
            <ol style="padding-left:18px;">${data.next_actions.map(a => `<li style="font-size:13px;color:#e2e8f0;margin-bottom:4px;">${a}</li>`).join('')}</ol>` : ''}
    `;
}

async function askQuestion() {
    const input = document.getElementById('nlq-input');
    const question = input.value.trim();
    if (!question) return;

    const el = document.getElementById('nlq-result');
    _showLoading(el);
    const data = await api('/step1/ai/query', 'POST', { question });
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    el.innerHTML = `
        <div style="padding:14px;background:#0f172a;border-radius:8px;margin-bottom:12px;">
            <div style="font-size:14px;color:#e2e8f0;line-height:1.6;">${data.answer||''}</div>
            ${_confidenceBadge(data.confidence)}
        </div>
        ${data.supporting_data && data.supporting_data.length ? `
            <h4 style="font-size:13px;color:#94a3b8;margin-bottom:8px;">Supporting Data</h4>
            <table><tr><th>Source</th><th>Data Point</th><th>Relevance</th></tr>
            ${data.supporting_data.map(sd => `<tr><td>${sd.source||''}</td><td>${sd.data_point||''}</td><td style="font-size:12px;color:#94a3b8;">${sd.relevance||''}</td></tr>`).join('')}</table>` : ''}
        ${data.caveats && data.caveats.length ? `
            <div style="margin-top:8px;font-size:12px;color:#fbbf24;">Caveats: ${data.caveats.join('; ')}</div>` : ''}
        ${data.follow_up_questions && data.follow_up_questions.length ? `
            <div style="margin-top:12px;">
                <span style="font-size:12px;color:#94a3b8;">Follow-up questions:</span><br>
                ${data.follow_up_questions.map(q => `<span class="nlq-chip" onclick="document.getElementById('nlq-input').value='${q.replace(/'/g,"\\'")}';askQuestion();">${q}</span>`).join('')}
            </div>` : ''}
        ${data.data_tables_queried && data.data_tables_queried.length ? `
            <div style="margin-top:8px;font-size:11px;color:#64748b;">Tables queried: ${data.data_tables_queried.join(', ')}</div>` : ''}
    `;
}

async function runScenario() {
    const scenarioType = document.getElementById('scenario-type').value;
    const scenarioName = document.getElementById('scenario-name').value.trim() || 'Custom Scenario';
    const description = document.getElementById('scenario-desc').value.trim();
    if (!description) { toast('Please describe the scenario'); return; }

    const el = document.getElementById('scenario-result');
    _showLoading(el);
    const data = await api('/step1/ai/scenario', 'POST', {
        scenario_type: scenarioType,
        scenario_name: scenarioName,
        parameters: { description }
    });
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    const ia = data.impact_analysis || {};
    const fi = ia.financial_impact || {};
    const ci = ia.competitive_impact || {};
    const oi = ia.operational_impact || {};
    const posColors = {improves:'#059669',stable:'#d97706',weakens:'#dc2626'};
    const compColors = {increases:'#dc2626',stable:'#d97706',decreases:'#059669'};

    el.innerHTML = `
        ${data.scenario_summary ? `<p style="font-size:14px;color:#e2e8f0;margin-bottom:16px;">${data.scenario_summary}</p>` : ''}
        <div class="impact-grid">
            <div class="impact-col">
                <h5>Financial Impact</h5>
                <div class="metric-card" style="margin-bottom:8px;"><div class="metric-val" style="font-size:18px;">${fi.revenue_change_pct!=null?(fi.revenue_change_pct>=0?'+':'')+fi.revenue_change_pct.toFixed(1)+'%':'N/A'}</div><div class="metric-label">Revenue</div></div>
                <div class="metric-card"><div class="metric-val" style="font-size:18px;">${fi.margin_impact_pct!=null?(fi.margin_impact_pct>=0?'+':'')+fi.margin_impact_pct.toFixed(1)+'%':'N/A'}</div><div class="metric-label">Margin</div></div>
                ${fi.narrative ? `<p style="font-size:12px;color:#94a3b8;margin-top:8px;">${fi.narrative}</p>` : ''}
            </div>
            <div class="impact-col">
                <h5>Competitive Impact</h5>
                <div style="font-size:16px;font-weight:700;color:${posColors[ci.market_position_change]||'#94a3b8'};margin-bottom:8px;">${(ci.market_position_change||'stable').toUpperCase()}</div>
                ${ci.narrative ? `<p style="font-size:12px;color:#94a3b8;">${ci.narrative}</p>` : ''}
            </div>
            <div class="impact-col">
                <h5>Operational Impact</h5>
                <div style="font-size:16px;font-weight:700;color:${compColors[oi.complexity_change]||'#94a3b8'};margin-bottom:8px;">Complexity ${(oi.complexity_change||'stable').toUpperCase()}</div>
                ${oi.narrative ? `<p style="font-size:12px;color:#94a3b8;">${oi.narrative}</p>` : ''}
            </div>
        </div>
        ${data.risks && data.risks.length ? `
            <h4 style="font-size:14px;color:#fca5a5;margin:16px 0 8px;">Risks</h4>
            ${data.risks.map(r => `<div style="padding:8px 12px;background:#0f172a;border-radius:6px;margin-bottom:4px;font-size:13px;">
                ${r.risk||''} ${_impactBadge(r.probability)}
                ${r.mitigation ? `<div style="font-size:12px;color:#7dd3fc;margin-top:2px;">Mitigation: ${r.mitigation}</div>` : ''}
            </div>`).join('')}` : ''}
        ${data.opportunities && data.opportunities.length ? `
            <h4 style="font-size:14px;color:#6ee7b7;margin:16px 0 8px;">Opportunities</h4>
            ${data.opportunities.map(o => `<div style="padding:8px 12px;background:#0f172a;border-radius:6px;margin-bottom:4px;font-size:13px;">${o.opportunity||''} ${_impactBadge(o.probability)}</div>`).join('')}` : ''}
        ${data.downstream_effects ? `
            <h4 style="font-size:14px;color:#94a3b8;margin:16px 0 8px;">Downstream Effects</h4>
            <div style="font-size:13px;color:#e2e8f0;">
                ${data.downstream_effects.on_strategies ? `<div style="margin-bottom:4px;"><strong style="color:#94a3b8;">Strategies:</strong> ${data.downstream_effects.on_strategies}</div>` : ''}
                ${data.downstream_effects.on_initiatives ? `<div style="margin-bottom:4px;"><strong style="color:#94a3b8;">Initiatives:</strong> ${data.downstream_effects.on_initiatives}</div>` : ''}
                ${data.downstream_effects.on_value_streams ? `<div><strong style="color:#94a3b8;">Value Streams:</strong> ${data.downstream_effects.on_value_streams}</div>` : ''}
            </div>` : ''}
        ${data.recommendation ? `
            <div style="margin-top:16px;padding:14px;background:#064e3b33;border:1px solid #065f46;border-radius:8px;">
                <h4 style="font-size:13px;color:#6ee7b7;margin-bottom:6px;">Recommendation</h4>
                <p style="font-size:13px;color:#e2e8f0;">${data.recommendation}</p>
                ${_confidenceBadge(data.confidence)}
            </div>` : ''}
    `;
}

async function generateReport() {
    const audience = document.getElementById('report-audience').value;
    const el = document.getElementById('report-result');
    _showLoading(el);
    const data = await api('/step1/ai/generate-report', 'POST', { audience });
    if (data.error) { _showError(el, data.error); return; }
    if (!data.ai_powered) { _showError(el, data.message); return; }

    el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div>
                <div style="font-size:18px;font-weight:700;color:#38bdf8;">${data.report_title||'Report'}</div>
                <div style="font-size:12px;color:#94a3b8;">${data.date||''} | Audience: ${(data.audience||'').replace('_',' ').toUpperCase()}</div>
            </div>
            <button class="btn btn-sm" style="background:#334155;color:#94a3b8;" onclick="copyReport()">Copy to Clipboard</button>
        </div>
        ${(data.sections||[]).map(sec => `<div class="report-section">
            <h5>${sec.title||'Section'}</h5>
            <div class="report-content">${sec.content||''}</div>
            ${sec.data_visualizations && sec.data_visualizations.length ? `
                <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
                ${sec.data_visualizations.map(dv => `<div style="padding:6px 12px;background:#1e293b;border-radius:6px;font-size:11px;color:#94a3b8;">
                    <span style="color:#38bdf8;">[${dv.type||''}]</span> ${dv.title||''} ${dv.description ? 'â€” '+dv.description : ''}
                </div>`).join('')}</div>` : ''}
        </div>`).join('')}
        ${data.key_takeaways && data.key_takeaways.length ? `
            <div style="padding:14px;background:#064e3b33;border:1px solid #065f46;border-radius:8px;margin-top:12px;">
                <h4 style="font-size:14px;color:#6ee7b7;margin-bottom:8px;">Key Takeaways</h4>
                <ul style="padding-left:18px;">${data.key_takeaways.map(kt => `<li style="font-size:13px;color:#e2e8f0;margin-bottom:4px;">${kt}</li>`).join('')}</ul>
            </div>` : ''}
        ${data.appendix_notes && data.appendix_notes.length ? `
            <div style="margin-top:12px;font-size:11px;color:#64748b;">Appendix: ${data.appendix_notes.join(' | ')}</div>` : ''}
    `;

    // Store for clipboard
    window._lastReport = data;
}

function copyReport() {
    const data = window._lastReport;
    if (!data) return;
    let text = data.report_title + '\n' + (data.date||'') + '\nAudience: ' + (data.audience||'') + '\n\n';
    (data.sections||[]).forEach(s => { text += '## ' + s.title + '\n' + s.content + '\n\n'; });
    if (data.key_takeaways) { text += '## Key Takeaways\n' + data.key_takeaways.map(k => '- ' + k).join('\n') + '\n'; }
    navigator.clipboard.writeText(text).then(() => toast('Report copied to clipboard'));
}

// ===================== STEP 2: Value Streams =====================
let step2Phase = 'input';
let step2SelectedVs = null;

async function loadStep2() {
    if (step2Phase === 'edit' && step2SelectedVs) { renderStep2Edit(); return; }
    if (step2Phase === 'visual' && step2SelectedVs) { renderStep2Visual(); return; }
    renderStep2Input();
}

async function renderStep2Input() {
    step2Phase = 'input';
    const units = await api('/step1/business-units');
    const streams = await api('/step2/value-streams');

    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Step 2: Value Stream Analysis</h2>
            <p>Generate lean value stream maps with AI, or upload existing data.</p>
        </div>

        <div class="phase-tabs">
            <button class="phase-tab active">Input</button>
            <button class="phase-tab" onclick="step2Phase='edit'; step2SelectedVs=null; renderStep2EditList()">Data & Edit</button>
            <button class="phase-tab" onclick="step2Phase='visual'; step2SelectedVs=null; renderStep2VisualList()">Visual Map</button>
        </div>

        <div class="card">
            <h3>Generate Value Stream with AI</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Business Segment Name</label>
                    <input type="text" id="vs-segment" placeholder="e.g. Loan Processing, Claims Management, Order Fulfillment" />
                </div>
                <div class="form-group">
                    <label>Business Unit</label>
                    <select id="vs-bu">
                        ${units.length ? units.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">No business units â€” add one in Step 1</option>'}
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" onclick="generateValueStream()" ${!units.length ? 'disabled' : ''}>Generate Value Stream</button>
            <p style="font-size:12px;color:#64748b;margin-top:8px;">Uses OpenAI GPT-4o-mini to generate lean process steps, metrics, and competitor benchmarks.</p>
        </div>

        <div class="card">
            <h3>Upload Value Stream Data</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Business Unit</label>
                    <select id="vs-upload-bu">
                        ${units.length ? units.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">No business units</option>'}
                    </select>
                </div>
                <div class="form-group">
                    <label>CSV or JSON File</label>
                    <input type="file" id="vs-file" accept=".csv,.json" style="padding:8px;" />
                </div>
            </div>
            <button class="btn btn-success" onclick="uploadValueStream()" ${!units.length ? 'disabled' : ''}>Upload File</button>
            <p style="font-size:12px;color:#64748b;margin-top:8px;">CSV columns: step_order, step_name, description, step_type, process_time_hours, wait_time_hours, resources, is_bottleneck, notes</p>
        </div>

        <div class="card">
            <h3>Upload Process Map</h3>
            <p style="font-size:13px;color:#94a3b8;margin-bottom:12px;">Upload a visual process map (image, PDF) for AI extraction, or a BPMN XML file for direct parsing.</p>
            <div class="form-row">
                <div class="form-group">
                    <label>Business Unit</label>
                    <select id="vs-visual-bu">
                        ${units.length ? units.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">No business units</option>'}
                    </select>
                </div>
                <div class="form-group">
                    <label>Process Map File</label>
                    <input type="file" id="vs-visual-file" accept=".png,.jpg,.jpeg,.pdf,.bpmn,.xml" style="padding:8px;" />
                </div>
            </div>
            <button class="btn" style="background:#0d9488;color:#fff;" onclick="uploadVisualProcessMap()" ${!units.length ? 'disabled' : ''}>Extract Steps</button>
            <p style="font-size:12px;color:#64748b;margin-top:8px;">Supports PNG, JPG, PDF (via AI Vision), and BPMN/XML files. BPMN parsing works without an API key.</p>
        </div>

        <div class="card">
            <h3>Extract from URL</h3>
            <p style="font-size:13px;color:#94a3b8;margin-bottom:12px;">Provide a URL to a web page describing a process or workflow. AI will extract steps automatically.</p>
            <div class="form-row">
                <div class="form-group">
                    <label>Business Unit</label>
                    <select id="vs-url-bu">
                        ${units.length ? units.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">No business units</option>'}
                    </select>
                </div>
                <div class="form-group">
                    <label>Web URL</label>
                    <input type="text" id="vs-url-input" placeholder="https://example.com/process-description" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Segment Name (optional)</label>
                    <input type="text" id="vs-url-segment" placeholder="e.g. Order Fulfillment" />
                </div>
            </div>
            <button class="btn" style="background:#8b5cf6;color:#fff;" onclick="extractFromUrl()" ${!units.length ? 'disabled' : ''}>Extract from URL</button>
            <p style="font-size:12px;color:#64748b;margin-top:8px;">Fetches the page, extracts text, and uses AI to identify process steps. Requires OPENAI_API_KEY for best results.</p>
        </div>

        <div class="card">
            <h3>Pull from Sources</h3>
            <p style="font-size:13px;color:#94a3b8;margin-bottom:12px;">Aggregate data from multiple internal and external sources to build an enriched value stream.</p>
            <div class="form-row">
                <div class="form-group">
                    <label>Business Segment Name</label>
                    <input type="text" id="vs-pull-segment" placeholder="e.g. Loan Processing, Claims Management" />
                </div>
                <div class="form-group">
                    <label>Business Unit</label>
                    <select id="vs-pull-bu">
                        ${units.length ? units.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">No business units</option>'}
                    </select>
                </div>
            </div>
            <div class="form-row" style="gap:24px;">
                <div style="flex:1;">
                    <label style="font-weight:600;font-size:13px;color:#94a3b8;margin-bottom:8px;display:block;">Internal Sources</label>
                    <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;cursor:pointer;">
                        <input type="checkbox" class="pull-source-cb" value="app_data" checked /> App Data (existing records)
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;cursor:pointer;">
                        <input type="checkbox" class="pull-source-cb" value="erp_simulation" checked /> ERP Simulation (demo data)
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;cursor:pointer;">
                        <input type="checkbox" class="pull-source-cb" value="industry_benchmarks" checked /> Industry Benchmarks
                    </label>
                </div>
                <div style="flex:1;">
                    <label style="font-weight:600;font-size:13px;color:#94a3b8;margin-bottom:8px;display:block;">External Sources</label>
                    <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;cursor:pointer;">
                        <input type="checkbox" class="pull-source-cb" value="finnhub" /> Finnhub / Alpha Vantage
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;cursor:pointer;">
                        <input type="checkbox" class="pull-source-cb" value="web_search" /> Web Search (live)
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;cursor:pointer;">
                        <input type="checkbox" class="pull-source-cb" value="openai_research" /> OpenAI Research (GPT)
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;cursor:pointer;">
                        <input type="checkbox" class="pull-source-cb" value="competitor_operations" /> Competitor Operations (AI)
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;cursor:pointer;">
                        <input type="checkbox" class="pull-source-cb" value="jira" /> Jira (workflow data)
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;cursor:pointer;">
                        <input type="checkbox" class="pull-source-cb" value="servicenow" /> ServiceNow (incidents)
                    </label>
                </div>
            </div>
            <button class="btn" style="background:#7c3aed;color:#fff;margin-top:8px;" onclick="pullFromSources()" ${!units.length ? 'disabled' : ''}>Pull &amp; Generate</button>
            <p style="font-size:12px;color:#64748b;margin-top:8px;">Gathers data from selected sources, then synthesizes into a comprehensive value stream with metrics and benchmarks.</p>
        </div>

        ${streams.length ? `<div class="card">
            <h3>Existing Value Streams</h3>
            <table>
                <tr><th>Name</th><th>Business Unit</th><th>Description</th><th></th><th></th></tr>
                ${streams.map(s => `<tr>
                    <td><a href="#" onclick="step2SelectedVs=${s.id}; step2Phase='edit'; renderStep2Edit(); return false;" style="color:#38bdf8;">${s.name}</a></td>
                    <td>${s.business_unit_name}</td>
                    <td>${s.description || '-'}</td>
                    <td><button class="btn btn-sm" style="background:#334155;color:#e2e8f0" onclick="step2SelectedVs=${s.id}; step2Phase='visual'; renderStep2Visual();">View Map</button></td>
                    <td><button class="btn btn-danger" onclick="deleteVs(${s.id})">Delete</button></td>
                </tr>`).join('')}
            </table>
        </div>` : ''}
        <div id="step2-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(2, 'step2-gates');
}

async function generateValueStream() {
    const segment = document.getElementById('vs-segment').value.trim();
    const buId = document.getElementById('vs-bu').value;
    if (!segment) { alert('Enter a business segment name.'); return; }
    if (!buId) { alert('Select a business unit.'); return; }

    document.getElementById('main-content').innerHTML = `
        <div class="page-header"><h2>Step 2: Value Stream Analysis</h2></div>
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Generating value stream for "${segment}"...</p>
            <p class="progress-msg">AI is analyzing lean metrics, this may take 15-30 seconds</p>
        </div>
    `;

    const result = await api('/step2/generate', 'POST', { segment_name: segment, business_unit_id: +buId });

    if (result.error) {
        toast(result.error);
        if (result.id) {
            step2SelectedVs = result.id;
            step2Phase = 'edit';
            renderStep2Edit();
        } else {
            renderStep2Input();
        }
        return;
    }

    toast(`Generated ${result.steps} steps with ${result.benchmarks} competitor benchmarks`);
    step2SelectedVs = result.id;
    step2Phase = 'edit';
    renderStep2Edit();
}

async function uploadValueStream() {
    const buId = document.getElementById('vs-upload-bu').value;
    const fileInput = document.getElementById('vs-file');
    if (!buId) { alert('Select a business unit.'); return; }
    if (!fileInput.files.length) { alert('Select a file to upload.'); return; }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    const result = await apiUpload(`/step2/upload?business_unit_id=${buId}`, formData);

    if (result.error) { alert(result.error); return; }
    toast(`Uploaded ${result.steps} steps`);
    step2SelectedVs = result.id;
    step2Phase = 'edit';
    renderStep2Edit();
}

async function pullFromSources() {
    const segment = document.getElementById('vs-pull-segment').value.trim();
    const buId = document.getElementById('vs-pull-bu').value;
    if (!segment) { alert('Enter a business segment name.'); return; }
    if (!buId) { alert('Select a business unit.'); return; }

    const checkboxes = document.querySelectorAll('.pull-source-cb:checked');
    const sources = Array.from(checkboxes).map(cb => cb.value);
    if (!sources.length) { alert('Select at least one source.'); return; }

    const sourceLabels = {
        app_data: 'App Data', erp_simulation: 'ERP Simulation', industry_benchmarks: 'Benchmarks',
        finnhub: 'Finnhub', web_search: 'Web Search', openai_research: 'OpenAI',
        jira: 'Jira', servicenow: 'ServiceNow'
    };
    const progressItems = sources.map(s =>
        `<div id="pull-status-${s}" style="display:flex;align-items:center;gap:8px;margin:4px 0;font-size:13px;">
            <span class="spinner" style="width:14px;height:14px;border-width:2px;"></span>
            <span>${sourceLabels[s] || s}</span>
            <span style="color:#64748b;">gathering...</span>
        </div>`
    ).join('');

    document.getElementById('main-content').innerHTML = `
        <div class="page-header"><h2>Step 2: Value Stream Analysis</h2></div>
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Pulling from ${sources.length} source${sources.length > 1 ? 's' : ''} for "${segment}"...</p>
            <div style="margin-top:12px;text-align:left;max-width:300px;">${progressItems}</div>
            <p class="progress-msg" style="margin-top:12px;">This may take 15-60 seconds depending on sources selected</p>
        </div>
    `;

    const result = await api('/step2/pull-sources', 'POST', {
        segment_name: segment,
        business_unit_id: +buId,
        sources: sources
    });

    if (result.error) {
        alert(result.error);
        renderStep2Input();
        return;
    }

    const srcSummary = Object.entries(result.sources_used || {}).map(([k, v]) => `${sourceLabels[k] || k}: ${v}`).join(', ');
    toast(`Generated ${result.steps} steps, ${result.benchmarks} benchmarks (${result.synthesis_method}). Sources: ${srcSummary}`);
    step2SelectedVs = result.id;
    step2Phase = 'edit';
    renderStep2Edit();
}

async function uploadVisualProcessMap() {
    const buId = document.getElementById('vs-visual-bu').value;
    const fileInput = document.getElementById('vs-visual-file');
    if (!buId) { alert('Select a business unit.'); return; }
    if (!fileInput.files.length) { alert('Select a process map file to upload.'); return; }

    const file = fileInput.files[0];
    const ext = file.name.split('.').pop().toLowerCase();
    const isBpmn = ext === 'bpmn' || ext === 'xml';

    document.getElementById('main-content').innerHTML = `
        <div class="page-header"><h2>Step 2: Value Stream Analysis</h2></div>
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Extracting steps from "${file.name}"...</p>
            <p class="progress-msg">${isBpmn ? 'Parsing BPMN XML...' : 'AI Vision is analyzing the process map, this may take 15-30 seconds'}</p>
        </div>
    `;

    const formData = new FormData();
    formData.append('file', file);

    const result = await apiUpload(`/step2/upload-visual?business_unit_id=${buId}`, formData);

    if (result.error) {
        alert(result.error);
        renderStep2Input();
        return;
    }

    toast(`Extracted ${result.steps} steps from process map (${result.source_type})`);
    step2SelectedVs = result.id;
    step2Phase = 'edit';
    renderStep2Edit();
}

async function extractFromUrl() {
    const buId = document.getElementById('vs-url-bu').value;
    const url = document.getElementById('vs-url-input').value.trim();
    const segment = document.getElementById('vs-url-segment').value.trim();

    if (!buId) { alert('Select a business unit.'); return; }
    if (!url) { alert('Enter a URL to extract from.'); return; }

    document.getElementById('main-content').innerHTML = `
        <div class="page-header"><h2>Step 2: Value Stream Analysis</h2></div>
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Extracting process data from URL...</p>
            <p class="progress-msg">Fetching page content and analyzing with AI, this may take 15-30 seconds</p>
        </div>
    `;

    const result = await api('/step2/pull-from-url', 'POST', {
        url: url,
        business_unit_id: +buId,
        segment_name: segment
    });

    if (result.error && !result.id) {
        alert(result.error + (result.raw_text_preview ? '\n\nPreview: ' + result.raw_text_preview.substring(0, 200) : ''));
        renderStep2Input();
        return;
    }

    const confLabel = result.confidence === 'high' ? 'high confidence' : result.confidence === 'medium' ? 'medium confidence' : 'low confidence';
    toast(`Extracted ${result.steps} steps from URL (${confLabel})`);
    step2SelectedVs = result.id;
    step2Phase = 'edit';
    renderStep2Edit();
}

async function deleteVs(id) {
    if (!confirm('Delete this value stream and all its data?')) return;
    await api(`/step2/value-streams/${id}`, 'DELETE');
    toast('Value stream deleted');
    step2SelectedVs = null;
    renderStep2Input();
}

// --- Data & Edit Phase ---
async function renderStep2EditList() {
    const streams = await api('/step2/value-streams');
    if (streams.length === 1) { step2SelectedVs = streams[0].id; renderStep2Edit(); return; }

    document.getElementById('main-content').innerHTML = `
        <div class="page-header"><h2>Step 2: Value Stream Analysis</h2><p>Select a value stream to edit.</p></div>
        <div class="phase-tabs">
            <button class="phase-tab" onclick="renderStep2Input()">Input</button>
            <button class="phase-tab active">Data & Edit</button>
            <button class="phase-tab" onclick="step2Phase='visual'; step2SelectedVs=null; renderStep2VisualList()">Visual Map</button>
        </div>
        ${streams.length ? streams.map(s => `<div class="card" style="cursor:pointer;" onclick="step2SelectedVs=${s.id}; renderStep2Edit();">
            <h3>${s.name} <span style="font-size:13px;color:#64748b;font-weight:400;">${s.business_unit_name}</span></h3>
            <p style="color:#94a3b8;font-size:13px;">${s.description || 'No description'}</p>
        </div>`).join('') : '<div class="empty"><p>No value streams yet. Go to Input tab to create one.</p></div>'}
        <div id="step2-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(2, 'step2-gates');
}

async function renderStep2Edit() {
    step2Phase = 'edit';
    if (!step2SelectedVs) { renderStep2EditList(); return; }

    const detail = await api(`/step2/value-streams/${step2SelectedVs}/detail`);
    if (detail.error) { toast(detail.error); renderStep2EditList(); return; }

    const vs = detail.value_stream;
    const steps = detail.steps || [];
    const m = detail.metrics || {};
    const benchmarks = detail.benchmarks || [];

    const flowEff = m.flow_efficiency || 0;
    const effClass = flowEff >= 25 ? 'good' : flowEff >= 10 ? '' : 'warn';

    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>${vs.name}</h2>
            <p>${vs.business_unit_name} â€” ${vs.description || ''}</p>
        </div>

        <div class="phase-tabs">
            <button class="phase-tab" onclick="renderStep2Input()">Input</button>
            <button class="phase-tab active">Data & Edit</button>
            <button class="phase-tab" onclick="step2Phase='visual'; renderStep2Visual();">Visual Map</button>
            <button class="btn btn-sm" style="margin-left:auto;background:#334155;color:#e2e8f0;" onclick="step2SelectedVs=null; renderStep2EditList();">All Streams</button>
        </div>

        ${m.total_lead_time_hours != null ? `<div class="vs-metrics-bar">
            <div class="vm-item"><div class="vm-val">${Number(m.total_lead_time_hours).toFixed(1)}h</div><div class="vm-label">Total Lead Time</div></div>
            <div class="vm-item"><div class="vm-val good">${Number(m.total_process_time_hours).toFixed(1)}h</div><div class="vm-label">Process Time</div></div>
            <div class="vm-item"><div class="vm-val warn">${Number(m.total_wait_time_hours).toFixed(1)}h</div><div class="vm-label">Wait Time</div></div>
            <div class="vm-item"><div class="vm-val ${effClass}">${flowEff.toFixed(1)}%</div><div class="vm-label">Flow Efficiency</div></div>
            <div class="vm-item"><div class="vm-val" style="font-size:14px;color:#f97316;">${m.bottleneck_step || '-'}</div><div class="vm-label">Bottleneck</div></div>
            <div class="vm-item"><div class="vm-val" style="font-size:11px;color:#94a3b8;">${m.data_source || '-'}</div><div class="vm-label">Source</div></div>
        </div>` : ''}

        <div class="card" style="margin-top:16px;">
            <h3>Process Steps
                <span>
                    <button class="btn btn-primary btn-sm" onclick="addVsStep(${vs.id})">+ Add Step</button>
                    <button class="btn btn-success btn-sm" onclick="recalcVs(${vs.id})">Recalculate Metrics</button>
                </span>
            </h3>
            ${steps.length ? `<table>
                <tr><th>#</th><th>Name</th><th>Type</th><th>Process Time (h)</th><th>Wait Time (h)</th><th>Lead Time</th><th>Resources</th><th>Bottleneck</th><th></th></tr>
                ${steps.map(s => `<tr${s.is_bottleneck ? ' style="background:#7c2d1233;"' : ''}>
                    <td>${s.step_order}</td>
                    <td class="edit-cell" onclick="inlineEdit(this, ${vs.id}, ${s.id}, 'step_name', '${esc(s.step_name)}')">${s.step_name}</td>
                    <td class="edit-cell" onclick="inlineEditSelect(this, ${vs.id}, ${s.id}, 'step_type', '${s.step_type}', ['trigger','process','decision','delivery'])">${s.step_type}</td>
                    <td class="edit-cell" onclick="inlineEdit(this, ${vs.id}, ${s.id}, 'process_time_hours', '${s.process_time_hours}')">${Number(s.process_time_hours).toFixed(1)}</td>
                    <td class="edit-cell" onclick="inlineEdit(this, ${vs.id}, ${s.id}, 'wait_time_hours', '${s.wait_time_hours}')">${Number(s.wait_time_hours).toFixed(1)}</td>
                    <td>${Number(s.lead_time_hours).toFixed(1)}</td>
                    <td class="edit-cell" onclick="inlineEdit(this, ${vs.id}, ${s.id}, 'resources', '${esc(s.resources || '')}')">${s.resources || '-'}</td>
                    <td>${s.is_bottleneck ? '<span style="color:#f97316;font-weight:600;">Yes</span>' : '-'}</td>
                    <td><button class="btn btn-danger" onclick="deleteVsStep(${vs.id}, ${s.id})">Del</button></td>
                </tr>`).join('')}
            </table>` : '<div class="empty"><p>No steps yet. Generate or add steps manually.</p></div>'}
        </div>

        <div class="card">
            <h3>Competitor Benchmarks
                <span>
                    <button class="btn btn-sm" style="background:#7c3aed;color:#fff;" onclick="refreshCompetitorBenchmarks(${vs.id})">
                        ${benchmarks.length ? 'Refresh Benchmarks' : 'Generate Benchmarks'}
                    </button>
                </span>
            </h3>
            ${benchmarks.length ? `<table class="comparison-table">
                <tr><th>Company</th><th>Lead Time (h)</th><th>Process Time (h)</th><th>Flow Efficiency</th><th>Bottleneck</th><th>Notes</th></tr>
                <tr style="background:#0ea5e911;">
                    <td><strong>${vs.name} (Org)</strong></td>
                    <td>${Number(m.total_lead_time_hours || 0).toFixed(1)}</td>
                    <td>${Number(m.total_process_time_hours || 0).toFixed(1)}</td>
                    <td>${flowEff.toFixed(1)}%</td>
                    <td>${m.bottleneck_step || '-'}</td>
                    <td>-</td>
                </tr>
                ${benchmarks.map(b => {
                    let extra = '';
                    try { const info = JSON.parse(b.notes || '{}'); extra = info.key_differentiator || info.notes || b.notes || '-'; } catch(e) { extra = b.notes || '-'; }
                    return `<tr>
                    <td>${b.competitor_name}</td>
                    <td>${b.total_lead_time_hours != null ? Number(b.total_lead_time_hours).toFixed(1) : '-'}</td>
                    <td>${b.total_process_time_hours != null ? Number(b.total_process_time_hours).toFixed(1) : '-'}</td>
                    <td>${b.flow_efficiency != null ? Number(b.flow_efficiency).toFixed(1) + '%' : '-'}</td>
                    <td>${b.bottleneck_step || '-'}</td>
                    <td style="max-width:200px;font-size:12px;">${extra}</td>
                </tr>`;
                }).join('')}
            </table>` : '<div class="empty"><p>No competitor benchmarks yet. Click "Generate Benchmarks" to create AI-powered comparisons.</p></div>'}
            <div id="competitor-bp-${vs.id}"></div>
        </div>
        <div id="step2-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(2, 'step2-gates');
}

function esc(s) { return String(s).replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

function inlineEdit(cell, vsId, stepId, field, currentVal) {
    if (cell.querySelector('input')) return;
    const orig = cell.textContent;
    cell.innerHTML = `<input type="text" value="${currentVal}" onblur="saveInline(this, ${vsId}, ${stepId}, '${field}')" onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){this.dataset.cancel='1';this.blur();}" autofocus />`;
    cell.querySelector('input').focus();
}

function inlineEditSelect(cell, vsId, stepId, field, currentVal, options) {
    if (cell.querySelector('select')) return;
    cell.innerHTML = `<select onchange="saveInline(this, ${vsId}, ${stepId}, '${field}')" onblur="saveInline(this, ${vsId}, ${stepId}, '${field}')">
        ${options.map(o => `<option value="${o}" ${o === currentVal ? 'selected' : ''}>${o}</option>`).join('')}
    </select>`;
    cell.querySelector('select').focus();
}

async function saveInline(input, vsId, stepId, field) {
    if (input.dataset.cancel) { renderStep2Edit(); return; }
    let val = input.value;
    if (['process_time_hours', 'wait_time_hours', 'step_order'].includes(field)) val = parseFloat(val) || 0;
    await api(`/step2/value-streams/${vsId}/steps/${stepId}`, 'PUT', { [field]: val });
    renderStep2Edit();
}

async function addVsStep(vsId) {
    const name = prompt('Step name:');
    if (!name) return;
    const type = prompt('Step type (trigger/process/decision/delivery):') || 'process';
    const pt = prompt('Process time (hours):') || '0';
    const wt = prompt('Wait time (hours):') || '0';
    const order = prompt('Step order:') || '99';
    await api(`/step2/value-streams/${vsId}/steps`, 'POST', {
        step_name: name, step_type: type,
        process_time_hours: +pt, wait_time_hours: +wt, step_order: +order
    });
    toast('Step added');
    renderStep2Edit();
}

async function deleteVsStep(vsId, stepId) {
    if (!confirm('Delete this step?')) return;
    await api(`/step2/value-streams/${vsId}/steps/${stepId}`, 'DELETE');
    toast('Step deleted');
    renderStep2Edit();
}

async function recalcVs(vsId) {
    const result = await api(`/step2/value-streams/${vsId}/recalculate`, 'POST');
    toast(`Recalculated: Flow efficiency ${result.flow_efficiency}%`);
    renderStep2Edit();
}

// --- Visual Map Phase ---
async function renderStep2VisualList() {
    const streams = await api('/step2/value-streams');
    if (streams.length === 1) { step2SelectedVs = streams[0].id; renderStep2Visual(); return; }

    document.getElementById('main-content').innerHTML = `
        <div class="page-header"><h2>Step 2: Value Stream Analysis</h2><p>Select a value stream to visualize.</p></div>
        <div class="phase-tabs">
            <button class="phase-tab" onclick="renderStep2Input()">Input</button>
            <button class="phase-tab" onclick="step2Phase='edit'; step2SelectedVs=null; renderStep2EditList()">Data & Edit</button>
            <button class="phase-tab active">Visual Map</button>
        </div>
        ${streams.length ? streams.map(s => `<div class="card" style="cursor:pointer;" onclick="step2SelectedVs=${s.id}; renderStep2Visual();">
            <h3>${s.name} <span style="font-size:13px;color:#64748b;font-weight:400;">${s.business_unit_name}</span></h3>
        </div>`).join('') : '<div class="empty"><p>No value streams yet.</p></div>'}
        <div id="step2-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(2, 'step2-gates');
}

async function renderStep2Visual() {
    step2Phase = 'visual';
    if (!step2SelectedVs) { renderStep2VisualList(); return; }

    const detail = await api(`/step2/value-streams/${step2SelectedVs}/detail`);
    if (detail.error) { toast(detail.error); renderStep2VisualList(); return; }

    const vs = detail.value_stream;
    const steps = detail.steps || [];
    const m = detail.metrics || {};
    const benchmarks = detail.benchmarks || [];
    const flowEff = m.flow_efficiency || 0;
    const effClass = flowEff >= 25 ? 'good' : flowEff >= 10 ? '' : 'warn';

    // Build flow diagram
    let flowHtml = '';
    steps.forEach((s, i) => {
        const classes = ['vs-flow-step', `type-${s.step_type}`];
        if (s.is_bottleneck) classes.push('bottleneck');

        flowHtml += `<div class="${classes.join(' ')}">
            <div class="step-title">${s.step_name}</div>
            <div class="step-times">
                <span class="pt">${Number(s.process_time_hours).toFixed(1)}h proc</span><br/>
                <span class="wt">${Number(s.wait_time_hours).toFixed(1)}h wait</span>
            </div>
        </div>`;

        if (i < steps.length - 1) {
            flowHtml += `<div class="vs-flow-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-wait">${Number(steps[i+1].wait_time_hours).toFixed(1)}h wait</div>
            </div>`;
        }
    });

    // Build competitor comparison
    let compHtml = '';
    if (benchmarks.length) {
        const allEntries = [
            { name: vs.name + ' (Org)', lt: m.total_lead_time_hours, pt: m.total_process_time_hours, fe: flowEff, bn: m.bottleneck_step, isOrg: true },
            ...benchmarks.map(b => ({ name: b.competitor_name, lt: b.total_lead_time_hours, pt: b.total_process_time_hours, fe: b.flow_efficiency, bn: b.bottleneck_step, isOrg: false }))
        ];
        // Find best values for highlighting
        const validLt = allEntries.filter(e => e.lt != null).map(e => e.lt);
        const validFe = allEntries.filter(e => e.fe != null).map(e => e.fe);
        const bestLt = validLt.length ? Math.min(...validLt) : null;
        const bestFe = validFe.length ? Math.max(...validFe) : null;

        compHtml = `<div class="card">
            <h3>Competitor Comparison</h3>
            <table class="comparison-table">
                <tr><th>Company</th><th>Lead Time (h)</th><th>Process Time (h)</th><th>Flow Efficiency</th><th>Bottleneck</th></tr>
                ${allEntries.map(e => `<tr${e.isOrg ? ' style="background:#0ea5e911;"' : ''}>
                    <td>${e.isOrg ? '<strong>' + e.name + '</strong>' : e.name}</td>
                    <td class="${e.lt === bestLt ? 'best' : ''}">${e.lt != null ? Number(e.lt).toFixed(1) : '-'}</td>
                    <td>${e.pt != null ? Number(e.pt).toFixed(1) : '-'}</td>
                    <td class="${e.fe === bestFe ? 'best' : ''}">${e.fe != null ? Number(e.fe).toFixed(1) + '%' : '-'}</td>
                    <td>${e.bn || '-'}</td>
                </tr>`).join('')}
            </table>
        </div>`;
    }

    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>${vs.name} â€” Value Stream Map</h2>
            <p>${vs.business_unit_name}</p>
        </div>

        <div class="phase-tabs">
            <button class="phase-tab" onclick="renderStep2Input()">Input</button>
            <button class="phase-tab" onclick="step2Phase='edit'; renderStep2Edit();">Data & Edit</button>
            <button class="phase-tab active">Visual Map</button>
            <button class="btn btn-sm" style="margin-left:auto;background:#334155;color:#e2e8f0;" onclick="step2SelectedVs=null; renderStep2VisualList();">All Streams</button>
        </div>

        <div class="card">
            <h3>Flow Diagram</h3>
            ${steps.length ? `<div class="vs-flow">${flowHtml}</div>` : '<div class="empty"><p>No steps to visualize.</p></div>'}
        </div>

        <div class="vs-metrics-bar">
            <div class="vm-item"><div class="vm-val">${Number(m.total_lead_time_hours || 0).toFixed(1)}h</div><div class="vm-label">Total Lead Time</div></div>
            <div class="vm-item"><div class="vm-val good">${Number(m.total_process_time_hours || 0).toFixed(1)}h</div><div class="vm-label">Process Time</div></div>
            <div class="vm-item"><div class="vm-val warn">${Number(m.total_wait_time_hours || 0).toFixed(1)}h</div><div class="vm-label">Wait Time</div></div>
            <div class="vm-item"><div class="vm-val ${effClass}">${flowEff.toFixed(1)}%</div><div class="vm-label">Flow Efficiency</div></div>
            <div class="vm-item"><div class="vm-val" style="font-size:14px;color:#f97316;">${m.bottleneck_step || '-'}</div><div class="vm-label">Bottleneck</div></div>
        </div>

        ${compHtml}
        <div id="step2-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(2, 'step2-gates');
}

// Legacy lever support
async function addLever() {
    const streams = await api('/step2/value-streams');
    if (!streams.length) { alert('Add a value stream first.'); return; }
    const vsId = prompt('Value Stream ID (' + streams.map(s => s.id + '=' + s.name).join(', ') + '):');
    const lever_type = prompt('Lever type (growth/efficiency/experience/effectiveness):');
    const opportunity = prompt('Opportunity description:');
    const current_state = prompt('Current state (optional):');
    const target_state = prompt('Target state (optional):');
    const impact_estimate = prompt('Impact (low/medium/high):');
    await api('/step2/levers', 'POST', { value_stream_id: +vsId, lever_type, opportunity, current_state, target_state, impact_estimate });
    toast('Lever added');
    loadStep2();
}

// ===================== STEP 3: SWOT/TOWS =====================
let step3Phase = 'generate';

async function loadStep3() {
    if (step3Phase === 'swot') { renderStep3Swot(); return; }
    if (step3Phase === 'tows') { renderStep3Tows(); return; }
    renderStep3Generate();
}

async function renderStep3Generate() {
    step3Phase = 'generate';
    const [org, streams, swot] = await Promise.all([
        api('/step1/organization'),
        api('/step2/value-streams'),
        api('/step3/swot'),
    ]);

    const hasOrg = !!org;
    const hasStreams = streams.length > 0;
    const autoEntries = swot.filter(s => (s.data_source || '').startsWith('Auto-generated'));
    const hasAuto = autoEntries.length > 0;

    // Get first business unit for auto-generate
    const units = await api('/step1/business-units');
    const defaultBuId = units.length ? units[0].id : null;

    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Step 3: SWOT to TOWS Action Engine</h2>
            <p>Auto-generate SWOT analysis from financial performance and value stream data, then create TOWS strategic actions.</p>
        </div>

        <div class="phase-tabs">
            <button class="phase-tab active">Auto-Generate</button>
            <button class="phase-tab" onclick="step3Phase='swot'; renderStep3Swot()">SWOT Grid</button>
            <button class="phase-tab" onclick="step3Phase='tows'; renderStep3Tows()">TOWS Actions</button>
        </div>

        <div class="card">
            <h3>Data Source Status</h3>
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <div style="flex:1; min-width:200px; padding: 16px; border-radius: 8px; background: ${hasOrg ? '#064e3b' : '#334155'}; border: 1px solid ${hasOrg ? '#065f46' : '#475569'};">
                    <div style="font-size: 14px; font-weight: 600; color: ${hasOrg ? '#6ee7b7' : '#94a3b8'};">${hasOrg ? 'Ready' : 'Not Available'}</div>
                    <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">Step 1: Financial Performance</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 2px;">${hasOrg ? org.name + (org.ticker ? ' (' + org.ticker + ')' : '') : 'Set up organization in Step 1'}</div>
                </div>
                <div style="flex:1; min-width:200px; padding: 16px; border-radius: 8px; background: ${hasStreams ? '#064e3b' : '#334155'}; border: 1px solid ${hasStreams ? '#065f46' : '#475569'};">
                    <div style="font-size: 14px; font-weight: 600; color: ${hasStreams ? '#6ee7b7' : '#94a3b8'};">${hasStreams ? 'Ready' : 'Not Available'}</div>
                    <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">Step 2: Value Stream Analysis</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 2px;">${hasStreams ? streams.length + ' value stream(s): ' + streams.map(s => s.name).join(', ') : 'Create value streams in Step 2'}</div>
                </div>
            </div>
        </div>

        ${hasAuto ? `<div style="background: #713f12; border: 1px solid #92400e; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; font-size: 13px; color: #fbbf24;">
            ${autoEntries.length} auto-generated entries exist. Re-generating will replace them. Manual entries will be preserved.
        </div>` : ''}

        <div class="card" id="generate-card">
            <h3>Auto-Generate SWOT & TOWS</h3>
            <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">
                Analyzes financial metrics, competitor benchmarks, value stream flow efficiency, bottlenecks, and improvement levers to generate comprehensive SWOT entries and TOWS strategic actions.
            </p>
            ${defaultBuId ? `
                <button class="btn btn-primary" onclick="runAutoGenerate(${defaultBuId})" style="padding: 12px 28px; font-size: 15px;" ${!hasOrg && !hasStreams ? 'disabled' : ''}>
                    Auto-Generate SWOT & TOWS
                </button>
                ${!hasOrg && !hasStreams ? '<p style="color: #fca5a5; font-size: 12px; margin-top: 8px;">Complete Step 1 or Step 2 first to enable auto-generation.</p>' : ''}
            ` : '<p style="color: #fca5a5; font-size: 13px;">No business units found. Set up your organization in Step 1 first.</p>'}
        </div>

        ${swot.length ? `<div class="card">
            <h3>Current SWOT Preview (${swot.length} entries)</h3>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${['strength', 'weakness', 'opportunity', 'threat'].map(cat => {
                    const items = swot.filter(s => s.category === cat);
                    return `<span style="font-size: 12px; padding: 4px 10px; border-radius: 12px; background: #334155; color: #94a3b8;">${cat}s: ${items.length}</span>`;
                }).join('')}
            </div>
        </div>` : ''}
        <div id="step3-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(3, 'step3-gates');
}

async function runAutoGenerate(buId) {
    const card = document.getElementById('generate-card');
    card.innerHTML = `
        <div class="loading-overlay" style="padding: 40px;">
            <div class="spinner"></div>
            <p>Generating SWOT entries from Step 1 & Step 2 data...</p>
            <p class="progress-msg">Analyzing financial metrics, value streams, and benchmarks. AI analysis will be used if available.</p>
        </div>
    `;

    const result = await api('/step3/auto-generate', 'POST', { business_unit_id: buId });

    if (result.error) {
        card.innerHTML = `<h3>Error</h3><p style="color: #fca5a5;">${result.error}</p>`;
        return;
    }

    toast(`Generated ${result.swot_generated} SWOT entries and ${result.tows_generated} TOWS actions`);
    // Auto-navigate to SWOT Grid after successful generation
    step3Phase = 'swot';
    renderStep3Swot();
}

async function renderStep3Swot() {
    step3Phase = 'swot';
    const swot = await api('/step3/swot');
    const grouped = { strength: [], weakness: [], opportunity: [], threat: [] };
    swot.forEach(s => grouped[s.category]?.push(s));

    const units = await api('/step1/business-units');

    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Step 3: SWOT Analysis Grid</h2>
            <p>Review and manage SWOT entries from auto-generation and manual input.</p>
        </div>

        <div class="phase-tabs">
            <button class="phase-tab" onclick="step3Phase='generate'; renderStep3Generate()">Auto-Generate</button>
            <button class="phase-tab active">SWOT Grid</button>
            <button class="phase-tab" onclick="step3Phase='tows'; renderStep3Tows()">TOWS Actions</button>
        </div>

        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
            <button class="btn btn-primary btn-sm" onclick="addSwot()">+ Add Manual Entry</button>
            <button class="btn btn-sm" style="background:#334155;color:#e2e8f0;" onclick="step3Phase='generate'; renderStep3Generate()">Regenerate</button>
        </div>

        <div class="swot-grid">
            ${[
                { key: 'strength', label: 'Strengths', cls: 'strengths' },
                { key: 'weakness', label: 'Weaknesses', cls: 'weaknesses' },
                { key: 'opportunity', label: 'Opportunities', cls: 'opportunities' },
                { key: 'threat', label: 'Threats', cls: 'threats' },
            ].map(q => `
                <div class="swot-quad ${q.cls}">
                    <h4>${q.label} (${grouped[q.key].length})</h4>
                    <ul>
                        ${grouped[q.key].length ? grouped[q.key].map(s => `
                            <li style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 8px;">
                                <span style="flex:1;">${s.description}
                                    <span style="display:block;margin-top:3px;">
                                        ${s.severity ? `<span class="severity-badge severity-${s.severity}">${s.severity}</span>` : ''}
                                        ${s.confidence ? `<span class="confidence-badge confidence-${s.confidence}">${s.confidence}</span>` : ''}
                                    </span>
                                    ${s.data_source ? `<span style="font-size:10px; color:#94a3b8; display:block; margin-top:2px;">${s.data_source}</span>` : ''}
                                </span>
                                <button class="btn btn-danger" style="flex-shrink:0; padding:2px 6px; font-size:11px;" onclick="deleteSwot(${s.id})">x</button>
                            </li>
                        `).join('') : '<li style="color: #94a3b8;">No entries yet</li>'}
                    </ul>
                </div>
            `).join('')}
        </div>
        <div id="step3-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(3, 'step3-gates');
}

async function renderStep3Tows() {
    step3Phase = 'tows';
    const tows = await api('/step3/tows');

    const grouped = { SO: [], WO: [], ST: [], WT: [] };
    tows.forEach(t => grouped[t.strategy_type]?.push(t));

    const typeLabels = {
        SO: { name: 'SO: Strength-Opportunity', desc: 'Leverage strengths to capitalize on opportunities', color: '#064e3b', border: '#065f46' },
        WO: { name: 'WO: Weakness-Opportunity', desc: 'Address weaknesses by leveraging opportunities', color: '#1e3a5f', border: '#1e40af' },
        ST: { name: 'ST: Strength-Threat', desc: 'Use strengths to counter threats', color: '#713f12', border: '#92400e' },
        WT: { name: 'WT: Weakness-Threat', desc: 'Minimize threats while addressing weaknesses', color: '#7f1d1d', border: '#991b1b' },
    };

    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Step 3: TOWS Strategic Actions</h2>
            <p>Cross-referenced strategies generated from SWOT analysis.</p>
        </div>

        <div class="phase-tabs">
            <button class="phase-tab" onclick="step3Phase='generate'; renderStep3Generate()">Auto-Generate</button>
            <button class="phase-tab" onclick="step3Phase='swot'; renderStep3Swot()">SWOT Grid</button>
            <button class="phase-tab active">TOWS Actions</button>
        </div>

        ${tows.length ? Object.entries(typeLabels).map(([type, info]) => {
            const items = grouped[type] || [];
            return `<div class="card" style="border-left: 3px solid ${info.border};">
                <h3>${info.name} <span style="font-size:12px; color:#94a3b8; font-weight:400;">(${items.length} actions)</span></h3>
                <p style="font-size: 12px; color: #64748b; margin-bottom: 12px;">${info.desc}</p>
                ${items.length ? `<table>
                    <tr><th>Action</th><th>Impact</th><th>SWOT Pairing</th><th>Priority</th></tr>
                    ${items.map(t => `<tr>
                        <td>${t.action_description}
                            ${t.rationale ? `<div style="font-size:11px;color:#64748b;margin-top:4px;">${t.rationale}</div>` : ''}
                        </td>
                        <td style="white-space:nowrap;">
                            <span class="impact-bar" style="width:${(t.impact_score || 5) * 8}px;"></span>
                            <span class="impact-label">${t.impact_score || 5}/10</span>
                        </td>
                        <td style="font-size: 12px; color: #94a3b8; max-width: 300px;">
                            <span style="color:#6ee7b7;">${t.swot_1_cat}:</span> ${(t.swot_1 || '').substring(0, 50)}${(t.swot_1 || '').length > 50 ? '...' : ''}
                            <br/><span style="color:#7dd3fc;">${t.swot_2_cat}:</span> ${(t.swot_2 || '').substring(0, 50)}${(t.swot_2 || '').length > 50 ? '...' : ''}
                        </td>
                        <td>${statusHtml(t.priority || 'medium')}</td>
                    </tr>`).join('')}
                </table>` : '<p style="color: #64748b; font-size: 13px;">No actions in this category</p>'}
            </div>`;
        }).join('') : `
            <div class="empty" style="padding: 60px 20px;">
                <p style="font-size: 16px; color: #94a3b8;">No TOWS actions generated yet</p>
                <p style="margin-top: 12px;">
                    <button class="btn btn-primary" onclick="step3Phase='generate'; renderStep3Generate();">Go to Auto-Generate</button>
                </p>
            </div>
        `}
        <div id="step3-gates" style="margin-top:20px;"></div>
    `;
    renderStepGates(3, 'step3-gates');
}

async function addSwot() {
    const units = await api('/step1/business-units');
    if (!units.length) { alert('Add a business unit in Step 1 first.'); return; }
    const buId = units.length === 1 ? units[0].id : prompt('Business Unit ID (' + units.map(u => u.id + '=' + u.name).join(', ') + '):');
    if (!buId) return;
    const category = prompt('Category (strength/weakness/opportunity/threat):');
    if (!category) return;
    const description = prompt('Description:');
    if (!description) return;
    await api('/step3/swot', 'POST', { business_unit_id: +buId, category, description, data_source: 'Manual entry' });
    toast('SWOT entry added');
    renderStep3Swot();
}

async function deleteSwot(id) {
    if (!confirm('Delete this SWOT entry? Related TOWS actions will also be removed.')) return;
    await api(`/step3/swot/${id}`, 'DELETE');
    toast('SWOT entry deleted');
    renderStep3Swot();
}

async function addTows() {
    const strategy_type = prompt('Strategy type (SO/WO/ST/WT):');
    const swot_entry_1_id = prompt('First SWOT entry ID:');
    const swot_entry_2_id = prompt('Second SWOT entry ID:');
    const action_description = prompt('Action description:');
    const priority = prompt('Priority (low/medium/high/critical):');
    await api('/step3/tows', 'POST', { strategy_type, swot_entry_1_id: +swot_entry_1_id, swot_entry_2_id: +swot_entry_2_id, action_description, priority });
    toast('TOWS action added');
    renderStep3Tows();
}

// ===================== STEP 4: Strategy & OKRs =====================
let step4Phase = 'inputs';

function layerBadge(layer) {
    const colors = { business: '#059669', digital: '#2563eb', data: '#d97706', gen_ai: '#7c3aed' };
    const bg = { business: '#064e3b', digital: '#1e3a5f', data: '#713f12', gen_ai: '#581c87' };
    return `<span class="layer-badge" style="background:${bg[layer] || '#334155'};color:${colors[layer] || '#94a3b8'}">${layer}</span>`;
}

async function loadStep4() {
    const mc = document.getElementById('main-content');
    mc.innerHTML = `
        <div class="page-header">
            <h2>Step 4: Four-Layer Strategy & OKRs</h2>
            <p>Define Business, Digital, Data, and Gen AI strategies with auto-generated OKRs and Key Results.</p>
        </div>
        <div class="phase-tabs">
            <button class="phase-tab ${step4Phase==='inputs'?'active':''}" onclick="step4Phase='inputs';loadStep4()">1. Inputs</button>
            <button class="phase-tab ${step4Phase==='generate'?'active':''}" onclick="step4Phase='generate';loadStep4()">2. Generate</button>
            <button class="phase-tab ${step4Phase==='review'?'active':''}" onclick="step4Phase='review';loadStep4()">3. Review</button>
            <button class="phase-tab ${step4Phase==='initiatives'?'active':''}" onclick="step4Phase='initiatives';loadStep4()">4. Initiatives</button>
        </div>
        <div id="step4-content"></div>
        <div id="step4-gates" style="margin-top:20px;"></div>
    `;
    const renderers = { inputs: renderStep4Inputs, generate: renderStep4Generate, review: renderStep4Review, initiatives: renderStep4Initiatives };
    await renderers[step4Phase]();
    renderStepGates(4, 'step4-gates');
}

async function renderStep4Inputs() {
    const [sources, inputs] = await Promise.all([api('/step4/data-sources'), api('/step4/inputs')]);
    const inputsByType = {};
    inputs.forEach(inp => { if (!inputsByType[inp.input_type]) inputsByType[inp.input_type] = []; inputsByType[inp.input_type].push(inp); });

    const getVal = (type) => (inputsByType[type] && inputsByType[type][0]) ? inputsByType[type][0].content : '';

    document.getElementById('step4-content').innerHTML = `
        <div class="card">
            <h3>Data Source Availability</h3>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
                <div class="data-source-card"><span class="dot ${sources.organization?'active':'inactive'}"></span>Step 1: Financial (${sources.counts.organization})</div>
                <div class="data-source-card"><span class="dot ${sources.value_streams?'active':'inactive'}"></span>Step 2: Value Streams (${sources.counts.value_streams})</div>
                <div class="data-source-card"><span class="dot ${sources.swot?'active':'inactive'}"></span>Step 3: SWOT (${sources.counts.swot})</div>
                <div class="data-source-card"><span class="dot ${sources.tows?'active':'inactive'}"></span>Step 3: TOWS (${sources.counts.tows})</div>
                <div class="data-source-card"><span class="dot ${sources.user_inputs?'active':'inactive'}"></span>User Inputs (${sources.counts.inputs})</div>
                <div class="data-source-card"><span class="dot ${(inputsByType['document_reference']||[]).length>0?'active':'inactive'}"></span>Documents (${(inputsByType['document_reference']||[]).length})</div>
            </div>
        </div>

        <div class="card">
            <h3>Strategy Context (Your Input)</h3>
            <p style="font-size:13px;color:#94a3b8;margin-bottom:16px;">Provide strategic direction for each layer. These inputs guide the auto-generation engine.</p>
            ${['business', 'digital', 'data', 'gen_ai'].map(layer => `
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;">${layerBadge(layer)} ${layer.replace('_',' ')} Strategy Context</label>
                    <textarea id="input-${layer}" rows="3" placeholder="Describe your ${layer.replace('_',' ')} strategy priorities...">${getVal(layer+'_strategy')}</textarea>
                    <button class="btn btn-primary btn-sm" style="margin-top:6px;" onclick="saveStrategyInput('${layer}_strategy', document.getElementById('input-${layer}').value)">Save</button>
                </div>
            `).join('')}
        </div>

        <div class="card">
            <h3>Additional Context</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Competitor Strategy</label>
                    <textarea id="input-competitor" rows="2" placeholder="Key competitor moves or strategies...">${getVal('competitor_strategy')}</textarea>
                    <button class="btn btn-primary btn-sm" style="margin-top:6px;" onclick="saveStrategyInput('competitor_strategy', document.getElementById('input-competitor').value)">Add</button>
                </div>
                <div class="form-group">
                    <label>Ongoing Initiatives</label>
                    <textarea id="input-ongoing" rows="2" placeholder="Current initiatives to consider...">${getVal('ongoing_initiatives')}</textarea>
                    <button class="btn btn-primary btn-sm" style="margin-top:6px;" onclick="saveStrategyInput('ongoing_initiatives', document.getElementById('input-ongoing').value)">Save</button>
                </div>
            </div>
            <div style="margin-top:16px;">
                <label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;">Document Reference</label>
                <div class="form-row">
                    <div class="form-group" style="max-width:200px;">
                        <input id="doc-filename" placeholder="File name" />
                    </div>
                    <div class="form-group">
                        <input id="doc-summary" placeholder="Summary of document content" />
                    </div>
                    <button class="btn btn-primary btn-sm" style="align-self:flex-end;" onclick="saveDocRef()">Add Doc</button>
                </div>
            </div>
        </div>

        ${inputs.length ? `<div class="card">
            <h3>Saved Inputs</h3>
            <table>
                <tr><th>Type</th><th>Content</th><th>File</th><th></th></tr>
                ${inputs.map(inp => `<tr>
                    <td><span class="status status-active" style="font-size:11px;">${inp.input_type}</span></td>
                    <td style="max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${inp.content}</td>
                    <td>${inp.file_name || '-'}</td>
                    <td><button class="btn btn-danger" onclick="deleteStrategyInput(${inp.id})">Delete</button></td>
                </tr>`).join('')}
            </table>
        </div>` : ''}
    `;
}

async function saveStrategyInput(type, content) {
    if (!content || !content.trim()) { alert('Please enter some content.'); return; }
    await api('/step4/inputs', 'POST', { input_type: type, content: content.trim() });
    toast('Input saved');
    renderStep4Inputs();
}

async function saveDocRef() {
    const fileName = document.getElementById('doc-filename').value.trim();
    const summary = document.getElementById('doc-summary').value.trim();
    if (!summary) { alert('Please enter a document summary.'); return; }
    await api('/step4/inputs', 'POST', { input_type: 'document_reference', content: summary, file_name: fileName || null });
    toast('Document reference added');
    renderStep4Inputs();
}

async function deleteStrategyInput(id) {
    if (!confirm('Delete this input?')) return;
    await api(`/step4/inputs/${id}`, 'DELETE');
    toast('Input deleted');
    renderStep4Inputs();
}

async function renderStep4Generate() {
    const sources = await api('/step4/data-sources');
    const totalData = sources.counts.organization + sources.counts.value_streams + sources.counts.swot + sources.counts.tows + sources.counts.inputs;

    document.getElementById('step4-content').innerHTML = `
        <div class="card" style="text-align:center;padding:40px;">
            <h3 style="justify-content:center;">Auto-Generate Strategies & OKRs</h3>
            <div class="metric-row" style="justify-content:center;margin:20px 0;">
                <div class="metric-card"><div class="metric-val">${sources.counts.organization}</div><div class="metric-label">Org Records</div></div>
                <div class="metric-card"><div class="metric-val">${sources.counts.value_streams}</div><div class="metric-label">Value Streams</div></div>
                <div class="metric-card"><div class="metric-val">${sources.counts.tows}</div><div class="metric-label">TOWS Actions</div></div>
                <div class="metric-card"><div class="metric-val">${sources.counts.inputs}</div><div class="metric-label">User Inputs</div></div>
            </div>
            <p style="color:#94a3b8;margin-bottom:20px;">The engine will generate 4-layer strategies (Business, Digital, Data, Gen AI) with OKRs and Key Results based on all available upstream data${totalData === 0 ? '. <strong style="color:#fbbf24">Warning: No upstream data found. Add data in Steps 1-3 or provide user inputs first.</strong>' : '.'}</p>
            <button class="btn btn-primary" style="padding:14px 40px;font-size:16px;" onclick="runAutoGenerate()" id="btn-generate">Generate Strategies & OKRs</button>
            <div id="generate-result" style="margin-top:20px;"></div>
        </div>
    `;
}

async function runAutoGenerate() {
    const btn = document.getElementById('btn-generate');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Generating...';
    document.getElementById('generate-result').innerHTML = '';

    const result = await api('/step4/auto-generate', 'POST');

    // Store AI metadata for the review page
    if (result.cross_layer_notes) sessionStorage.setItem('cross_layer_notes', result.cross_layer_notes);
    else sessionStorage.removeItem('cross_layer_notes');
    if (result.initiative_suggestions && result.initiative_suggestions.length) sessionStorage.setItem('initiative_suggestions', JSON.stringify(result.initiative_suggestions));
    else sessionStorage.removeItem('initiative_suggestions');

    document.getElementById('generate-result').innerHTML = `
        <div style="padding:16px;background:#064e3b;border-radius:8px;color:#6ee7b7;">
            Generated <strong>${result.strategies}</strong> strategies, <strong>${result.okrs}</strong> OKRs, and <strong>${result.key_results}</strong> key results.
            ${result.ai_powered ? ' <span class="ai-badge" style="margin-left:8px;">AI-Powered</span>' : ''}
        </div>
    `;
    btn.innerHTML = 'Generate Strategies & OKRs';
    btn.disabled = false;
    toast('Strategies generated successfully');
    setTimeout(() => { step4Phase = 'review'; loadStep4(); }, 1500);
}

async function renderStep4Review() {
    const strategies = await api('/step4/strategies-full');
    const layers = ['business', 'digital', 'data', 'gen_ai'];
    const layerNames = { business: 'Business', digital: 'Digital', data: 'Data', gen_ai: 'Gen AI' };
    const allApproved = strategies.length > 0 && strategies.every(s => s.approved);

    // Check if any strategy was AI-generated
    const hasAI = strategies.some(s => (s.description || '').includes('(AI)'));

    let html = '';

    // Cross-layer notes (stored in sessionStorage from generation)
    const crossNotes = sessionStorage.getItem('cross_layer_notes');
    if (crossNotes) {
        html += `<div class="card" style="border-left:3px solid #7c3aed;margin-bottom:16px;">
            <h3 style="font-size:14px;">Cross-Layer Synergies ${hasAI ? '<span class="ai-badge" style="margin-left:8px;">AI</span>' : ''}</h3>
            <p style="font-size:13px;color:#94a3b8;">${crossNotes}</p>
        </div>`;
    }

    html += `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div>
                <span style="font-size:14px;color:#94a3b8;">${strategies.length} strategies | ${allApproved ? '<span style="color:#6ee7b7">All Approved</span>' : '<span style="color:#fbbf24">Pending Approval</span>'}</span>
                ${hasAI ? ' <span class="ai-badge">AI-Powered</span>' : ''}
            </div>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-primary btn-sm" onclick="addManualStrategy()">+ Add Manual Strategy</button>
                <button class="btn btn-success" onclick="approveAllStrategies()" ${allApproved ? 'disabled style="opacity:0.5"' : ''}>Approve All Strategies</button>
            </div>
        </div>
    `;

    for (const layer of layers) {
        const layerStrats = strategies.filter(s => s.layer === layer);
        if (!layerStrats.length) continue;

        html += `<div style="margin-bottom:24px;">
            <h3 style="margin-bottom:12px;">${layerBadge(layer)} ${layerNames[layer]} Layer (${layerStrats.length})</h3>`;

        for (const s of layerStrats) {
            const riskBadge = s.risk_level ? `<span class="risk-badge risk-${s.risk_level}" style="margin-left:8px;">${s.risk_level} risk</span>` : '';

            html += `<div class="strategy-card ${layer}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                    <div style="flex:1;">
                        <strong style="font-size:15px;cursor:pointer;" onclick="editStrategyName(${s.id}, this)" title="Click to edit">${s.name}</strong>
                        <span class="status ${s.approved ? 'status-approved' : 'status-pending'}" style="margin-left:8px;">${s.approved ? 'Approved' : 'Pending'}</span>
                        ${riskBadge}
                    </div>
                    <button class="btn btn-danger" onclick="deleteStrategy(${s.id})">Delete</button>
                </div>
                <p style="font-size:13px;color:#94a3b8;margin-bottom:8px;cursor:pointer;" onclick="editStrategyDesc(${s.id}, this)" title="Click to edit">${s.description || 'No description'}</p>
                ${s.risks ? `<div style="font-size:12px;color:#fbbf24;margin-bottom:8px;padding:6px 10px;background:#713f1233;border-radius:6px;cursor:pointer;" onclick="this.style.whiteSpace=this.style.whiteSpace==='nowrap'?'normal':'nowrap'" title="Click to expand">Risks: ${s.risks}</div>` : ''}
                ${s.tows_action_id ? `<span style="font-size:11px;color:#64748b;">TOWS Action #${s.tows_action_id}</span>` : ''}`;

            // OKRs
            if (s.okrs && s.okrs.length) {
                for (const okr of s.okrs) {
                    html += `<div style="margin-top:12px;padding:12px;background:#1e293b;border-radius:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong style="font-size:13px;cursor:pointer;" onclick="editOkrObjective(${okr.id}, this)" title="Click to edit">OKR: ${okr.objective}</strong>
                            <div>
                                <span style="font-size:11px;color:#64748b;margin-right:8px;">${okr.time_horizon || ''} ${statusHtml(okr.status)}</span>
                                <button class="btn btn-danger" onclick="deleteOkr(${okr.id})">Del</button>
                            </div>
                        </div>`;

                    if (okr.key_results && okr.key_results.length) {
                        html += `<table style="margin-top:6px;">
                            <tr><th>Key Result</th><th>Metric</th><th>Current</th><th>Target</th><th>Scenarios</th><th>Unit</th><th></th></tr>
                            ${okr.key_results.map(kr => `<tr>
                                <td style="font-size:13px;">${kr.key_result}
                                    ${kr.rationale ? `<div style="font-size:10px;color:#64748b;margin-top:2px;" title="${kr.rationale}">${kr.rationale.substring(0, 60)}${kr.rationale.length > 60 ? '...' : ''}</div>` : ''}
                                </td>
                                <td style="font-size:13px;">${kr.metric || '-'}</td>
                                <td style="font-size:13px;">${kr.current_value}</td>
                                <td style="font-size:13px;font-weight:600;">${kr.target_value}</td>
                                <td style="font-size:11px;color:#94a3b8;">
                                    ${kr.target_optimistic != null || kr.target_pessimistic != null ?
                                        `<span style="color:#6ee7b7;">${kr.target_optimistic != null ? kr.target_optimistic : '-'}</span> / <span style="color:#fca5a5;">${kr.target_pessimistic != null ? kr.target_pessimistic : '-'}</span>` : '-'}
                                </td>
                                <td style="font-size:13px;">${kr.unit || '-'}</td>
                                <td><button class="btn btn-danger" onclick="deleteKeyResult(${okr.id}, ${kr.id})">X</button></td>
                            </tr>`).join('')}
                        </table>`;
                    }

                    html += `<button class="btn btn-sm" style="background:#334155;color:#e2e8f0;margin-top:8px;font-size:12px;" onclick="addKeyResult(${okr.id})">+ Key Result</button>
                    </div>`;
                }
            }

            html += `<button class="btn btn-sm" style="background:#334155;color:#e2e8f0;margin-top:10px;font-size:12px;" onclick="addOkrToStrategy(${s.id})">+ Add OKR</button>
            </div>`;
        }
        html += `</div>`;
    }

    // Initiative suggestions
    const initSugg = sessionStorage.getItem('initiative_suggestions');
    if (initSugg) {
        try {
            const suggestions = JSON.parse(initSugg);
            if (suggestions.length) {
                html += `<div class="card" style="border-left:3px solid #0ea5e9;">
                    <h3 style="font-size:14px;">AI-Suggested Initiatives</h3>
                    <ul style="padding-left:16px;">
                        ${suggestions.map(s => `<li style="font-size:13px;color:#94a3b8;margin-bottom:6px;">${s}</li>`).join('')}
                    </ul>
                </div>`;
            }
        } catch(e) {}
    }

    if (allApproved) {
        html += `<div style="text-align:center;padding:20px;">
            <button class="btn btn-primary" style="padding:14px 40px;font-size:16px;" onclick="step4Phase='initiatives';loadStep4()">Define Digital Initiatives &rarr;</button>
        </div>`;
    }

    document.getElementById('step4-content').innerHTML = html;
}

async function addManualStrategy() {
    const layer = prompt('Layer (business/digital/data/gen_ai):');
    if (!layer || !['business','digital','data','gen_ai'].includes(layer)) { alert('Invalid layer.'); return; }
    const name = prompt('Strategy name:');
    if (!name) return;
    const description = prompt('Description (optional):');
    await api('/step4/strategies', 'POST', { layer, name, description });
    toast('Strategy added');
    renderStep4Review();
}

async function editStrategyName(id, el) {
    const newName = prompt('Edit strategy name:', el.textContent);
    if (newName && newName !== el.textContent) {
        await api(`/step4/strategies/${id}`, 'PUT', { name: newName });
        toast('Updated');
        renderStep4Review();
    }
}

async function editStrategyDesc(id, el) {
    const newDesc = prompt('Edit description:', el.textContent);
    if (newDesc !== null && newDesc !== el.textContent) {
        await api(`/step4/strategies/${id}`, 'PUT', { description: newDesc });
        toast('Updated');
        renderStep4Review();
    }
}

async function deleteStrategy(id) {
    if (!confirm('Delete this strategy and all its OKRs?')) return;
    await api(`/step4/strategies/${id}`, 'DELETE');
    toast('Strategy deleted');
    renderStep4Review();
}

async function editOkrObjective(id, el) {
    const current = el.textContent.replace('OKR: ', '');
    const newObj = prompt('Edit objective:', current);
    if (newObj && newObj !== current) {
        await api(`/step4/okrs/${id}`, 'PUT', { objective: newObj });
        toast('Updated');
        renderStep4Review();
    }
}

async function deleteOkr(id) {
    if (!confirm('Delete this OKR and its key results?')) return;
    await api(`/step4/okrs/${id}`, 'DELETE');
    toast('OKR deleted');
    renderStep4Review();
}

async function addOkrToStrategy(strategyId) {
    const objective = prompt('Objective:');
    if (!objective) return;
    const time_horizon = prompt('Time horizon (e.g. 12 months):') || '12 months';
    await api('/step4/okrs', 'POST', { strategy_id: strategyId, objective, time_horizon });
    toast('OKR added');
    renderStep4Review();
}

async function addKeyResult(okrId) {
    const key_result = prompt('Key result description:');
    if (!key_result) return;
    const metric = prompt('Metric name (optional):');
    const target_value = prompt('Target value:') || '0';
    const unit = prompt('Unit (optional):');
    await api(`/step4/okrs/${okrId}/key-results`, 'POST', { key_result, metric, target_value: +target_value, unit });
    toast('Key result added');
    renderStep4Review();
}

async function deleteKeyResult(okrId, krId) {
    await api(`/step4/okrs/${okrId}/key-results/${krId}`, 'DELETE');
    toast('Key result deleted');
    renderStep4Review();
}

async function approveAllStrategies() {
    if (!confirm('Approve all strategies? This enables initiative generation.')) return;
    const result = await api('/step4/approve-all', 'POST');
    toast(`${result.approved} strategies approved`);
    renderStep4Review();
}

async function renderStep4Initiatives() {
    // Check if strategies are approved first
    const strategies = await api('/step4/strategies');
    const approved = (strategies || []).filter(s => s.approved === 1 || s.approved === true);
    const hasApproved = approved.length > 0;

    document.getElementById('step4-content').innerHTML = `
        <div class="card" style="text-align:center;padding:40px;">
            <h3 style="justify-content:center;">Define Digital Initiatives from Strategies</h3>
            <p style="color:#94a3b8;margin-bottom:20px;">This will create product groups, digital products, and initiatives from your approved strategies and OKRs.</p>
            ${!hasApproved ? `<div style="background:#713f12;border:1px solid #92400e;border-radius:8px;padding:16px;margin-bottom:20px;color:#fbbf24;font-size:14px;">
                No approved strategies found. Go to the <strong>Review</strong> tab and click <strong>"Approve All Strategies"</strong> first.
                <br><button class="btn btn-primary btn-sm" style="margin-top:12px;" onclick="step4Phase='review';loadStep4()">Go to Review Tab</button>
            </div>` : ''}
            <button class="btn btn-primary" style="padding:14px 40px;font-size:16px;" onclick="runInitiativeGenerate()" id="btn-init-generate" ${!hasApproved ? 'disabled' : ''}>Define Digital Initiatives & OKRs</button>
            <div id="init-generate-result" style="margin-top:20px;"></div>
        </div>
    `;
}

async function runInitiativeGenerate() {
    const btn = document.getElementById('btn-init-generate');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Generating...';
    document.getElementById('init-generate-result').innerHTML = '';

    const result = await api('/step5/auto-generate', 'POST');

    if (result.error) {
        document.getElementById('init-generate-result').innerHTML = `<div style="padding:16px;background:#7f1d1d;border-radius:8px;color:#fca5a5;">${result.error}</div>`;
        btn.innerHTML = 'Define Digital Initiatives & OKRs';
        btn.disabled = false;
        return;
    }

    document.getElementById('init-generate-result').innerHTML = `
        <div style="padding:16px;background:#064e3b;border-radius:8px;color:#6ee7b7;">
            ${result.ai_powered ? '<span class="ai-badge" style="margin-bottom:8px;display:inline-block;">AI-Powered</span> ' : ''}
            Created <strong>${result.initiatives}</strong> initiatives, <strong>${result.products}</strong> products, <strong>${result.groups}</strong> product groups.
            ${result.ai_powered ? '<br><span style="font-size:12px;color:#c4b5fd;">Initiatives generated with context-aware RICE scoring, risks, and dependencies.</span>' : ''}
        </div>
        <button class="btn btn-primary" style="margin-top:16px;" onclick="showStep(5);step5Phase='roadmap';loadStep5()">View Roadmap in Step 5 &rarr;</button>
    `;
    btn.innerHTML = 'Define Digital Initiatives & OKRs';
    btn.disabled = false;
    toast('Initiatives generated');
}

// â”€â”€â”€ Quarterly Roadmap Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function phaseBadge(phase) {
    const m = { quick_win: ['QW','qw'], strategic: ['ST','st'], long_term: ['LT','lt'] };
    const [label, cls] = m[phase] || ['â€”',''];
    return `<span class="qt-phase-badge ${cls}">${label}</span>`;
}

// â”€â”€â”€ Step 5: Initiatives Quarterly Roadmap (2 years) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderStep5Roadmap() {
    const roadmap = await api('/step5/roadmap');
    const q = roadmap.quarters || [];
    const pc = roadmap.phase_counts || {};

    let html = `
        <div class="qt-summary">
            <div class="qt-summary-card"><div class="qt-val">${roadmap.total}</div><div class="qt-lbl">Total Initiatives</div></div>
            <div class="qt-summary-card"><div class="qt-val" style="color:#6ee7b7">${pc.quick_wins||0}</div><div class="qt-lbl">Quick Wins</div></div>
            <div class="qt-summary-card"><div class="qt-val" style="color:#7dd3fc">${pc.strategic||0}</div><div class="qt-lbl">Strategic</div></div>
            <div class="qt-summary-card"><div class="qt-val" style="color:#fbbf24">${pc.long_term||0}</div><div class="qt-lbl">Long-term</div></div>
        </div>
        <div class="qt-roadmap">
    `;

    for (const qtr of q) {
        html += `<div class="qt-quarter">
            <div class="qt-header">${qtr.label} <span class="qt-count">(${qtr.items.length})</span></div>
            <div class="qt-items">`;
        if (!qtr.items.length) {
            html += '<div style="text-align:center;color:#475569;font-size:12px;padding:20px 0;">No initiatives</div>';
        }
        for (const i of qtr.items) {
            const rice = i.rice_override || i.rice_score || 0;
            html += `<div class="qt-card" style="border-left: 3px solid ${{quick_win:'#6ee7b7',strategic:'#7dd3fc',long_term:'#fbbf24'}[i.computed_phase]||'#475569'}">
                <div class="qt-name">${i.name}</div>
                <div class="qt-parent">
                    <span>${i.product_name || ''}</span>
                    ${i.strategy_name ? '<span>' + i.strategy_name + '</span>' : ''}
                </div>
                <div class="qt-meta">
                    ${phaseBadge(i.computed_phase)}
                    ${i.strategy_layer ? layerBadge(i.strategy_layer) : ''}
                    <span class="rice-badge ${riceClass(rice)}">${Number(rice).toFixed(1)}</span>
                    <span>E:${i.effort||'-'}</span>
                    ${statusHtml(i.status)}
                </div>
            </div>`;
        }
        html += '</div></div>';
    }
    html += '</div>';
    document.getElementById('step5-content').innerHTML = html;
}

// ===================== STEP 5: Initiatives & RICE =====================
let step5Phase = 'table';

async function loadStep5() {
    const mc = document.getElementById('main-content');
    mc.innerHTML = `
        <div class="page-header">
            <h2>Step 5: Digital Initiatives & RICE Prioritization</h2>
            <p>Score initiatives using RICE = (Reach x Impact x Confidence) / Effort. Override scores manually.</p>
        </div>
        <div class="phase-tabs">
            <button class="phase-tab ${step5Phase==='table'?'active':''}" onclick="step5Phase='table';loadStep5()">Initiatives Table</button>
            <button class="phase-tab ${step5Phase==='roadmap'?'active':''}" onclick="step5Phase='roadmap';loadStep5()">Roadmap View</button>
        </div>
        <div id="step5-content"></div>
        <div id="step5-gates" style="margin-top:20px;"></div>
    `;
    if (step5Phase === 'roadmap') {
        await renderStep5Roadmap();
    } else {
        await renderStep5Table();
    }
    renderStepGates(5, 'step5-gates');
}

async function renderStep5Table() {
    const [groups, products, initiatives] = await Promise.all([
        api('/step5/product-groups'),
        api('/step5/digital-products'),
        api('/step5/initiatives-full'),
    ]);

    let html = `
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div class="card" style="flex:1;">
                <h3>Product Groups <button class="btn btn-primary btn-sm" onclick="addProductGroup()">+ Add</button></h3>
                ${groups.map(g => `<div style="padding: 6px 0; font-size: 14px;">${g.name} <span style="color:#64748b">(ID: ${g.id})</span></div>`).join('') || '<p style="color:#64748b">None yet</p>'}
            </div>
            <div class="card" style="flex:1;">
                <h3>Digital Products <button class="btn btn-primary btn-sm" onclick="addDigitalProduct()">+ Add</button></h3>
                ${products.map(p => `<div style="padding: 6px 0; font-size: 14px;">${p.name} <span style="color:#64748b">(${p.product_group_name}, ID: ${p.id})</span></div>`).join('') || '<p style="color:#64748b">None yet</p>'}
            </div>
        </div>
        <div class="card">
            <h3>Initiatives (RICE Ranked) <button class="btn btn-primary btn-sm" onclick="addInitiative()">+ Add</button></h3>`;

    if (!initiatives.length) {
        html += '<div class="empty"><p>No initiatives yet. Generate from Step 4 or add manually.</p></div>';
    } else {
        for (const i of initiatives) {
            const effective = i.rice_override || i.rice_score;
            const phase = i.roadmap_phase || (effective >= 3 && i.effort <= 2 ? 'quick_win' : effective >= 2 && i.effort <= 4 ? 'strategic' : 'long_term');
            const borderColor = { business: '#059669', digital: '#2563eb', data: '#d97706', gen_ai: '#7c3aed' }[i.strategy_layer] || '#334155';

            const phaseColors = { quick_win: '#6ee7b7', strategic: '#7dd3fc', long_term: '#fbbf24' };
            html += `<div class="strategy-card" style="border-left-color:${borderColor};">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <div style="font-weight:500;font-size:14px;" title="${i.name}">${i.name}</div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        ${i.ai_generated ? '<span class="ai-badge">AI</span>' : ''}
                        ${i.strategy_layer ? layerBadge(i.strategy_layer) : ''}
                        <span class="rice-badge ${riceClass(effective)}" ${i.ai_rationale ? 'title="' + i.ai_rationale.replace(/"/g, '&quot;') + '"' : ''}>RICE ${Number(effective).toFixed(1)}</span>
                        <span style="padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;color:${phaseColors[phase] || '#94a3b8'};border:1px solid ${phaseColors[phase] || '#475569'}">${phase.replace('_',' ')}</span>
                        ${statusHtml(i.status)}
                    </div>
                </div>
                <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
                    <span style="font-size:12px;color:#94a3b8;">R:${i.reach} I:${i.impact} C:${i.confidence} E:${i.effort}</span>
                    <label style="font-size:11px;color:#64748b;">Value
                        <select style="width:50px;padding:2px;font-size:12px;" onchange="updateInitField(${i.id},'value_score',+this.value)">
                            ${[1,2,3,4,5].map(v => `<option value="${v}" ${i.value_score==v?'selected':''}>${v}</option>`).join('')}
                        </select>
                    </label>
                    <label style="font-size:11px;color:#64748b;">Size
                        <select style="width:50px;padding:2px;font-size:12px;" onchange="updateInitField(${i.id},'size_score',+this.value)">
                            ${[1,2,3,4,5].map(v => `<option value="${v}" ${i.size_score==v?'selected':''}>${v}</option>`).join('')}
                        </select>
                    </label>
                    ${i.impacted_segments ? '<span class="dep-badge">' + i.impacted_segments + '</span>' : ''}
                    <button class="btn btn-sm" style="background:#334155;color:#e2e8f0;font-size:11px;" onclick="overrideRice(${i.id})">RICE</button>
                    <button class="btn btn-sm" style="background:#334155;color:#e2e8f0;font-size:11px;" onclick="editInitMeta(${i.id})">Edit</button>
                </div>
                <div style="font-size:12px;color:#64748b;margin-bottom:8px;">
                    Product: ${i.product_name}${i.strategy_name ? ' | Strategy: ' + i.strategy_name : ''}
                </div>
                ${i.risks ? '<div style="font-size:12px;color:#fca5a5;margin-bottom:6px;cursor:pointer;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">Risks <span class="expand-toggle">[toggle]</span></div><div style="display:none;font-size:12px;color:#94a3b8;padding:8px;background:#1e293b;border-radius:6px;margin-bottom:6px;">' + i.risks + '</div>' : ''}
                ${i.dependencies ? '<div style="font-size:12px;color:#fbbf24;margin-bottom:6px;">Dependencies: ' + i.dependencies + '</div>' : ''}
                ${i.ai_rationale ? '<div style="font-size:11px;color:#c4b5fd;cursor:pointer;margin-bottom:4px;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">AI Rationale <span class="expand-toggle">[toggle]</span></div><div style="display:none;font-size:12px;color:#94a3b8;padding:8px;background:#0f172a;border-radius:6px;margin-bottom:6px;">' + i.ai_rationale + '</div>' : ''}`;

            // Strategic OKRs section
            if (i.strategic_okrs && i.strategic_okrs.length) {
                for (const okr of i.strategic_okrs) {
                    html += `<div style="margin-top:8px;padding:10px;background:#1e293b;border-radius:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <strong style="font-size:13px;">OKR: ${okr.objective}</strong>
                            <span style="font-size:11px;color:#64748b;">${okr.time_horizon || ''} ${statusHtml(okr.status)}</span>
                        </div>`;
                    if (okr.key_results && okr.key_results.length) {
                        html += `<table style="margin-top:6px;">
                            <tr><th>Key Result</th><th>Metric</th><th>Current</th><th>Target</th><th>Unit</th></tr>
                            ${okr.key_results.map(kr => `<tr>
                                <td style="font-size:13px;">${kr.key_result}</td>
                                <td style="font-size:13px;">${kr.metric || '-'}</td>
                                <td style="font-size:13px;">${kr.current_value}</td>
                                <td style="font-size:13px;">${kr.target_value}</td>
                                <td style="font-size:13px;">${kr.unit || '-'}</td>
                            </tr>`).join('')}
                        </table>`;
                    }
                    html += `</div>`;
                }
            } else {
                html += `<div style="font-size:12px;color:#475569;margin-top:8px;">No linked strategic OKRs</div>`;
            }

            html += `</div>`;
        }
    }

    html += `</div>`;
    document.getElementById('step5-content').innerHTML = html;
}

async function updateInitField(id, field, value) {
    await api(`/step5/initiatives/${id}`, 'PUT', { [field]: value });
    toast('Updated');
}

async function editInitMeta(id) {
    const deps = prompt('Dependencies (comma-separated, or leave blank):');
    const risks = prompt('Risks (comma-separated, or leave blank):');
    const segments = prompt('Impacted segments (comma-separated, or leave blank):');
    const data = {};
    if (deps !== null) data.dependencies = deps;
    if (risks !== null) data.risks = risks;
    if (segments !== null) data.impacted_segments = segments;
    if (Object.keys(data).length) {
        await api(`/step5/initiatives/${id}`, 'PUT', data);
        toast('Metadata updated');
        renderStep5Table();
    }
}

async function addProductGroup() {
    const name = prompt('Product group name:');
    if (!name) return;
    await api('/step5/product-groups', 'POST', { name });
    toast('Product group added');
    loadStep5();
}

async function addDigitalProduct() {
    const groups = await api('/step5/product-groups');
    if (!groups.length) { alert('Add a product group first.'); return; }
    const pgId = prompt('Product Group ID (' + groups.map(g => g.id + '=' + g.name).join(', ') + '):');
    const name = prompt('Product name:');
    await api('/step5/digital-products', 'POST', { product_group_id: +pgId, name });
    toast('Digital product added');
    loadStep5();
}

async function addInitiative() {
    const products = await api('/step5/digital-products');
    if (!products.length) { alert('Add a digital product first.'); return; }
    const dpId = prompt('Digital Product ID (' + products.map(p => p.id + '=' + p.name).join(', ') + '):');
    const name = prompt('Initiative name:');
    const description = prompt('Description (optional):');
    const reach = prompt('Reach (number of users/quarter):') || '1';
    const impact = prompt('Impact (0.25=minimal, 0.5=low, 1=medium, 2=high, 3=massive):') || '1';
    const confidence = prompt('Confidence (0.5=low, 0.8=medium, 1.0=high):') || '1';
    const effort = prompt('Effort (person-quarters):') || '1';
    await api('/step5/initiatives', 'POST', { digital_product_id: +dpId, name, description, reach: +reach, impact: +impact, confidence: +confidence, effort: +effort });
    toast('Initiative added');
    loadStep5();
}

async function overrideRice(id) {
    const score = prompt('Override RICE score:');
    const reason = prompt('Reason for override:');
    await api(`/step5/initiatives/${id}`, 'PUT', { rice_override: +score, rice_override_reason: reason });
    toast('RICE override applied');
    loadStep5();
}

// ===================== STEP 6: Epics & Teams =====================
let step6Phase = 'generate';

async function loadStep6() {
    const mc = document.getElementById('main-content');
    mc.innerHTML = `
        <div class="page-header">
            <h2>Step 6: Epics & Roadmap</h2>
            <p>Auto-decompose initiatives into scored epics with cross-layer dependencies and phase-based roadmap.</p>
        </div>
        <div class="phase-tabs">
            <button class="phase-tab ${step6Phase==='generate'?'active':''}" onclick="step6Phase='generate';loadStep6()">Generate</button>
            <button class="phase-tab ${step6Phase==='review'?'active':''}" onclick="step6Phase='review';loadStep6()">Review Epics</button>
            <button class="phase-tab ${step6Phase==='roadmap'?'active':''}" onclick="step6Phase='roadmap';loadStep6()">Roadmap</button>
        </div>
        <div id="step6-content"></div>
        <div id="step6-gates" style="margin-top:20px;"></div>
    `;
    if (step6Phase === 'generate') await renderStep6Generate();
    else if (step6Phase === 'review') await renderStep6Review();
    else await renderStep6Roadmap();
    renderStepGates(6, 'step6-gates');
}

// --- Tab 1: Generate ---
async function renderStep6Generate() {
    const [summary, teams] = await Promise.all([
        api('/step6/summary'),
        api('/step6/teams'),
    ]);
    document.getElementById('step6-content').innerHTML = `
        <div class="metric-row" style="margin-bottom:20px;">
            <div class="metric-card"><div class="metric-val">${summary.initiatives}</div><div class="metric-label">Initiatives Ready</div></div>
            <div class="metric-card"><div class="metric-val">${summary.epics}</div><div class="metric-label">Existing Epics</div></div>
            <div class="metric-card"><div class="metric-val">${summary.product_okrs}</div><div class="metric-label">Product OKRs</div></div>
            <div class="metric-card"><div class="metric-val">${summary.teams}</div><div class="metric-label">Teams</div></div>
            <div class="metric-card"><div class="metric-val">${summary.dependencies}</div><div class="metric-label">Dependencies</div></div>
        </div>

        <div class="card">
            <h3>Auto-Generate Epics & Product OKRs</h3>
            <p style="color:#94a3b8;font-size:13px;margin-bottom:16px;">
                Decomposes each approved/proposed initiative into 3 layer-specific epics with value/size/effort scoring,
                creates product OKRs from strategic OKRs, and infers cross-layer dependencies.
            </p>
            ${summary.initiatives > 0
                ? `<button class="btn btn-primary" onclick="runStep6Generate()" id="btn-gen6">Generate Epics & Product OKRs</button>`
                : '<p style="color:#f97316;">No approved/proposed initiatives found. Complete Step 5 first.</p>'}
            <div id="gen6-result" style="margin-top:16px;"></div>
        </div>

        <div class="card">
            <h3>Teams <button class="btn btn-primary btn-sm" onclick="addTeam()">+ Add</button></h3>
            ${teams.length ? `<table>
                <tr><th>Name</th><th>Capacity</th><th>ID</th></tr>
                ${teams.map(t => `<tr><td>${t.name}</td><td>${t.capacity || '-'}</td><td>${t.id}</td></tr>`).join('')}
            </table>` : '<div class="empty"><p>No teams yet. Add teams to assign to epics.</p></div>'}
        </div>
    `;
}

async function runStep6Generate() {
    const btn = document.getElementById('btn-gen6');
    const resultDiv = document.getElementById('gen6-result');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Generating...';
    resultDiv.innerHTML = '';
    try {
        const res = await api('/step6/auto-generate', 'POST', {});
        const epicCount = res.epics ? res.epics.length : 0;
        const okrCount = res.product_okrs ? res.product_okrs.length : 0;
        const depCount = res.dependencies ? res.dependencies.length : 0;
        const skipCount = res.skipped ? res.skipped.length : 0;
        const teamCount = res.team_assignments ? res.team_assignments.length : 0;
        resultDiv.innerHTML = `
            <div style="padding:16px;background:#064e3b;border-radius:8px;color:#6ee7b7;">
                <strong>Generation Complete</strong>
                ${res.ai_powered ? ' <span class="ai-badge">AI-Powered</span>' : ''}<br>
                ${epicCount} epics created, ${okrCount} product OKRs created, ${depCount} cross-layer dependencies inferred.
                ${teamCount > 0 ? `<br>${teamCount} team assignments recommended.` : ''}
                ${skipCount > 0 ? `<br><span style="color:#fbbf24;">${skipCount} epics skipped (already exist).</span>` : ''}
                ${res.ai_powered ? '<br><span style="font-size:12px;color:#c4b5fd;">Epics generated with AI-powered decomposition, effort estimates, and team recommendations.</span>' : ''}
            </div>
        `;
        if (epicCount > 0) {
            setTimeout(() => { step6Phase = 'review'; loadStep6(); }, 1500);
        }
    } catch (err) {
        resultDiv.innerHTML = `<div style="padding:16px;background:#7f1d1d;border-radius:8px;color:#fca5a5;">Error: ${err.message || err}</div>`;
    }
    btn.disabled = false;
    btn.textContent = 'Generate Epics & Product OKRs';
}

// --- Tab 2: Review ---
async function renderStep6Review() {
    const [epics, teams] = await Promise.all([
        api('/step6/epics-full'),
        api('/step6/teams'),
    ]);

    // Group epics by initiative
    const grouped = {};
    for (const e of epics) {
        const key = e.initiative_id;
        if (!grouped[key]) grouped[key] = { initiative_name: e.initiative_name, layer: e.strategy_layer, rice: e.rice_override || e.rice_score, epics: [] };
        grouped[key].epics.push(e);
    }

    let html = '';
    if (!epics.length) {
        html = '<div class="empty"><p>No epics yet. Use the Generate tab first.</p></div>';
    } else {
        for (const [initId, group] of Object.entries(grouped)) {
            const rice = group.rice || 0;
            html += `<div class="card" style="margin-bottom:20px;">
                <h3 style="margin-bottom:12px;">
                    ${group.initiative_name}
                    ${group.layer ? layerBadge(group.layer) : ''}
                    <span class="rice-badge ${riceClass(rice)}" style="margin-left:8px;">RICE ${Number(rice).toFixed(1)}</span>
                </h3>`;

            for (const e of group.epics) {
                const borderColor = { business: '#059669', digital: '#2563eb', data: '#d97706', gen_ai: '#7c3aed' }[group.layer] || '#334155';
                const depInfo = [];
                if (e.depends_on && e.depends_on.length) depInfo.push('Depends on: ' + e.depends_on.map(d => d.name.split(':')[0]).join(', '));
                if (e.blocks && e.blocks.length) depInfo.push('Blocks: ' + e.blocks.map(d => d.name.split(':')[0]).join(', '));

                const riskCls = 'risk-badge risk-' + (e.risk_level || 'medium');
                const depCount = (e.depends_on ? e.depends_on.length : 0) + (e.blocks ? e.blocks.length : 0);
                html += `<div class="strategy-card" style="border-left-color:${borderColor};">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div style="font-weight:500;font-size:14px;">
                            ${e.name}
                            ${e.ai_generated ? ' <span class="ai-badge">AI</span>' : ''}
                            ${e.estimated_effort_days ? ' <span class="effort-days-badge">~' + Math.round(e.estimated_effort_days) + ' days</span>' : ''}
                            <span class="${riskCls}">${e.risk_level || 'medium'}</span>
                            ${depCount > 0 ? ' <span class="dep-badge">' + depCount + ' deps</span>' : ''}
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            ${statusHtml(e.status)}
                            <button class="btn btn-danger" onclick="deleteEpic(${e.id})">Delete</button>
                        </div>
                    </div>
                    <p style="font-size:13px;color:#94a3b8;margin-bottom:10px;">${e.description || ''}</p>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
                        <label style="font-size:11px;color:#64748b;">Value
                            <select style="width:50px;padding:2px;font-size:12px;" onchange="updateEpicField(${e.id},'value_score',+this.value)">
                                ${[1,2,3,4,5].map(v => `<option value="${v}" ${e.value_score==v?'selected':''}>${v}</option>`).join('')}
                            </select>
                        </label>
                        <label style="font-size:11px;color:#64748b;">Size
                            <select style="width:50px;padding:2px;font-size:12px;" onchange="updateEpicField(${e.id},'size_score',+this.value)">
                                ${[1,2,3,4,5].map(v => `<option value="${v}" ${e.size_score==v?'selected':''}>${v}</option>`).join('')}
                            </select>
                        </label>
                        <label style="font-size:11px;color:#64748b;">Effort
                            <select style="width:50px;padding:2px;font-size:12px;" onchange="updateEpicField(${e.id},'effort_score',+this.value)">
                                ${[1,2,3,4,5].map(v => `<option value="${v}" ${e.effort_score==v?'selected':''}>${v}</option>`).join('')}
                            </select>
                        </label>
                        <label style="font-size:11px;color:#64748b;">Risk
                            <select style="width:80px;padding:2px;font-size:12px;" onchange="updateEpicField(${e.id},'risk_level',this.value)">
                                ${['low','medium','high','critical'].map(r => `<option value="${r}" ${e.risk_level==r?'selected':''}>${r}</option>`).join('')}
                            </select>
                        </label>
                        <label style="font-size:11px;color:#64748b;">Team
                            <select style="width:100px;padding:2px;font-size:12px;" onchange="updateEpicField(${e.id},'team_id',this.value?+this.value:null)">
                                <option value="">-- None --</option>
                                ${teams.map(t => `<option value="${t.id}" ${e.team_id==t.id?'selected':''}>${t.name}</option>`).join('')}
                            </select>
                        </label>
                        <span style="font-size:13px;font-weight:600;color:#38bdf8;">Priority: ${(e.priority_score || 0).toFixed(1)}</span>
                    </div>
                    ${e.risks ? '<div style="font-size:12px;color:#fca5a5;margin-bottom:6px;cursor:pointer;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">Risks <span class="expand-toggle">[toggle]</span></div><div style="display:none;font-size:12px;color:#94a3b8;padding:8px;background:#1e293b;border-radius:6px;margin-bottom:6px;">' + e.risks + '</div>' : ''}
                    ${e.ai_rationale ? '<div style="font-size:11px;color:#c4b5fd;cursor:pointer;margin-bottom:4px;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">AI Rationale <span class="expand-toggle">[toggle]</span></div><div style="display:none;font-size:12px;color:#94a3b8;padding:8px;background:#0f172a;border-radius:6px;margin-bottom:6px;">' + e.ai_rationale + '</div>' : ''}
                    ${e.okr_objective ? `<div style="margin-top:8px;padding:10px;background:#1e293b;border-radius:8px;">
                        <strong style="font-size:13px;">Product OKR: ${e.okr_objective}</strong>
                        ${e.product_key_results && e.product_key_results.length ? `<table style="margin-top:6px;">
                            <tr><th>Key Result</th><th>Metric</th><th>Current</th><th>Target</th><th>Unit</th></tr>
                            ${e.product_key_results.map(kr => `<tr>
                                <td style="font-size:13px;">${kr.key_result}</td>
                                <td style="font-size:13px;">${kr.metric || '-'}</td>
                                <td style="font-size:13px;">${kr.current_value}</td>
                                <td style="font-size:13px;">${kr.target_value}</td>
                                <td style="font-size:13px;">${kr.unit || '-'}</td>
                            </tr>`).join('')}
                        </table>` : ''}
                    </div>` : ''}
                    <div style="font-size:12px;color:#64748b;margin-top:6px;">
                        ${e.product_group_name ? 'Group: ' + e.product_group_name + ' ' : ''}
                        ${depInfo.length ? '| ' + depInfo.join(' | ') : ''}
                    </div>
                </div>`;
            }
            html += '</div>';
        }
    }

    html += `<div style="margin-top:16px;">
        <button class="btn btn-primary" onclick="addManualEpic()">+ Add Manual Epic</button>
    </div>`;

    document.getElementById('step6-content').innerHTML = html;
}

async function updateEpicField(id, field, value) {
    await api(`/step6/epics/${id}`, 'PUT', { [field]: value });
    toast('Updated');
    renderStep6Review();
}

async function deleteEpic(id) {
    if (!confirm('Delete this epic and its features/dependencies?')) return;
    await api(`/step6/epics/${id}`, 'DELETE');
    toast('Epic deleted');
    renderStep6Review();
}

async function addManualEpic() {
    const initiatives = await api('/step5/initiatives');
    if (!initiatives.length) { alert('Add initiatives in Step 5 first.'); return; }
    const initId = prompt('Initiative ID (' + initiatives.map(i => i.id + '=' + i.name).join(', ') + '):');
    if (!initId) return;
    const name = prompt('Epic name:');
    if (!name) return;
    const description = prompt('Description (optional):');
    await api('/step6/epics', 'POST', { initiative_id: +initId, name, description });
    toast('Epic added');
    renderStep6Review();
}

// --- Tab 3: Epics/Capabilities Quarterly Roadmap (1 year) ---
async function renderStep6Roadmap() {
    const roadmap = await api('/step6/roadmap');
    const q = roadmap.quarters || [];
    const pc = roadmap.phase_counts || {};
    const deps = roadmap.dependency_edges || [];

    let html = `
        <div class="qt-summary">
            <div class="qt-summary-card"><div class="qt-val">${roadmap.total}</div><div class="qt-lbl">Total Epics</div></div>
            <div class="qt-summary-card"><div class="qt-val" style="color:#6ee7b7">${pc.quick_wins||0}</div><div class="qt-lbl">Quick Wins</div></div>
            <div class="qt-summary-card"><div class="qt-val" style="color:#7dd3fc">${pc.strategic||0}</div><div class="qt-lbl">Strategic</div></div>
            <div class="qt-summary-card"><div class="qt-val" style="color:#fbbf24">${pc.long_term||0}</div><div class="qt-lbl">Long-term</div></div>
            <div class="qt-summary-card"><div class="qt-val">${deps.length}</div><div class="qt-lbl">Dependencies</div></div>
        </div>
        <div class="qt-roadmap">
    `;

    for (const qtr of q) {
        html += `<div class="qt-quarter">
            <div class="qt-header">${qtr.label} <span class="qt-count">(${qtr.items.length})</span></div>
            <div class="qt-items">`;
        if (!qtr.items.length) {
            html += '<div style="text-align:center;color:#475569;font-size:12px;padding:20px 0;">No epics</div>';
        }
        for (const e of qtr.items) {
            const riskCls = 'risk-' + (e.risk_level || 'medium');
            const phaseColor = {quick_win:'#6ee7b7',strategic:'#7dd3fc',long_term:'#fbbf24'}[e.computed_phase] || '#475569';
            html += `<div class="qt-card" style="border-left: 3px solid ${phaseColor}">
                <div class="qt-name">
                    ${e.name}
                    ${e.ai_generated ? ' <span class="ai-badge">AI</span>' : ''}
                    ${e.estimated_effort_days ? ' <span class="effort-days-badge">~' + Math.round(e.estimated_effort_days) + 'd</span>' : ''}
                </div>
                <div class="qt-parent">
                    ${e.product_name ? '<span>Product: ' + e.product_name + '</span>' : ''}
                    ${e.initiative_name ? '<span>Initiative: ' + e.initiative_name + '</span>' : ''}
                </div>
                <div class="qt-meta">
                    ${phaseBadge(e.computed_phase)}
                    ${e.strategy_layer ? layerBadge(e.strategy_layer) : ''}
                    <span style="font-weight:600;color:#38bdf8;">P:${(e.priority_score||0).toFixed(1)}</span>
                    <span>E:${e.effort_score||'-'}</span>
                    <span>V:${e.value_score||'-'}</span>
                    <span class="${riskCls}">${e.risk_level||'medium'}</span>
                    ${e.dep_count ? '<span class="dep-badge">' + e.dep_count + ' deps</span>' : ''}
                    ${e.team_name ? '<span>' + e.team_name + '</span>' : ''}
                    ${statusHtml(e.status)}
                </div>
            </div>`;
        }
        html += '</div></div>';
    }
    html += '</div>';
    document.getElementById('step6-content').innerHTML = html;
}

async function addTeam() {
    const name = prompt('Team name:');
    if (!name) return;
    const capacity = prompt('Capacity (optional):');
    await api('/step6/teams', 'POST', { name, capacity: capacity ? +capacity : null });
    toast('Team added');
    loadStep6();
}

// ===================== STEP 7: Feature Decomposition & Delivery Roadmap =====================
let step7Phase = 'generate';

async function loadStep7() {
    const mc = document.getElementById('main-content');
    mc.innerHTML = `
        <div class="page-header">
            <h2>Step 7: Feature Decomposition & Delivery Roadmap</h2>
            <p>Auto-decompose epics into scored features with delivery OKRs and phase-based roadmap.</p>
        </div>
        <div class="phase-tabs">
            <button class="phase-tab ${step7Phase==='generate'?'active':''}" onclick="step7Phase='generate';loadStep7()">Generate</button>
            <button class="phase-tab ${step7Phase==='review'?'active':''}" onclick="step7Phase='review';loadStep7()">Review Features</button>
            <button class="phase-tab ${step7Phase==='roadmap'?'active':''}" onclick="step7Phase='roadmap';loadStep7()">Roadmap</button>
        </div>
        <div id="step7-content"></div>
        <div id="step7-gates" style="margin-top:20px;"></div>
    `;
    if (step7Phase === 'generate') await renderStep7Generate();
    else if (step7Phase === 'review') await renderStep7Review();
    else await renderStep7Roadmap();
    renderStepGates(7, 'step7-gates');
}

// --- Tab 1: Generate ---
async function renderStep7Generate() {
    const [summary, dokrs] = await Promise.all([
        api('/step7/summary'),
        api('/step7/delivery-okrs'),
    ]);
    document.getElementById('step7-content').innerHTML = `
        <div class="metric-row" style="margin-bottom:20px;">
            <div class="metric-card"><div class="metric-val">${summary.epics}</div><div class="metric-label">Epics Ready</div></div>
            <div class="metric-card"><div class="metric-val">${summary.features}</div><div class="metric-label">Existing Features</div></div>
            <div class="metric-card"><div class="metric-val">${summary.delivery_okrs}</div><div class="metric-label">Delivery OKRs</div></div>
            <div class="metric-card"><div class="metric-val">${summary.teams}</div><div class="metric-label">Teams</div></div>
        </div>

        <div class="card">
            <h3>Auto-Generate Features & Delivery OKRs</h3>
            <p style="color:#94a3b8;font-size:13px;margin-bottom:16px;">
                Decomposes each epic into 3 layer-specific features with value/size/effort scoring inherited from the epic,
                and creates delivery OKRs cascaded from product OKRs.
            </p>
            ${summary.epics > 0
                ? '<button class="btn btn-primary" onclick="runStep7Generate()" id="btn-gen7">Generate Features & Delivery OKRs</button>'
                : '<p style="color:#f97316;">No epics found. Complete Step 6 first.</p>'}
            <div id="gen7-result" style="margin-top:16px;"></div>
        </div>

        <div class="card">
            <h3>Delivery OKRs</h3>
            ${dokrs.length ? '<table><tr><th>Objective</th><th>Product OKR</th><th>Team</th><th>Status</th></tr>' +
                dokrs.map(d => '<tr><td>' + d.objective + '</td><td>' + d.product_objective + '</td><td>' + d.team_name + '</td><td>' + statusHtml(d.status) + '</td></tr>').join('') +
                '</table>' : '<div class="empty"><p>No delivery OKRs yet. They will be auto-created during generation.</p></div>'}
        </div>
    `;
}

async function runStep7Generate() {
    const btn = document.getElementById('btn-gen7');
    const resultDiv = document.getElementById('gen7-result');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Generating...';
    resultDiv.innerHTML = '';
    try {
        const res = await api('/step7/auto-generate', 'POST', {});
        const featCount = res.features ? res.features.length : 0;
        const dokrCount = res.delivery_okrs ? res.delivery_okrs.length : 0;
        const skipCount = res.skipped ? res.skipped.length : 0;
        const featDepCount = res.feature_dependencies ? res.feature_dependencies.length : 0;
        resultDiv.innerHTML = `
            <div style="padding:16px;background:#064e3b;border-radius:8px;color:#6ee7b7;">
                <strong>Generation Complete</strong>
                ${res.ai_powered ? ' <span class="ai-badge">AI-Powered</span>' : ''}<br>
                ${featCount} features created, ${dokrCount} delivery OKRs created.
                ${featDepCount > 0 ? ' ' + featDepCount + ' feature dependencies mapped.' : ''}
                ${skipCount > 0 ? '<br><span style="color:#fbbf24;">' + skipCount + ' features skipped (already exist).</span>' : ''}
                ${res.ai_powered ? '<br><span style="font-size:12px;color:#c4b5fd;">Features generated as user stories with acceptance criteria and story points.</span>' : ''}
            </div>
        `;
        if (featCount > 0) {
            setTimeout(() => { step7Phase = 'review'; loadStep7(); }, 1500);
        }
    } catch (err) {
        resultDiv.innerHTML = '<div style="padding:16px;background:#7f1d1d;border-radius:8px;color:#fca5a5;">Error: ' + (err.message || err) + '</div>';
    }
    btn.disabled = false;
    btn.textContent = 'Generate Features & Delivery OKRs';
}

// --- Tab 2: Review Features (Initiative â†’ Epic â†’ Feature hierarchy) ---
async function renderStep7Review() {
    const features = await api('/step7/features-full');

    // Group by initiative, then by epic
    const initiatives = {};
    for (const f of features) {
        const initKey = f.initiative_id || 0;
        if (!initiatives[initKey]) {
            initiatives[initKey] = {
                initiative_name: f.initiative_name || 'Ungrouped',
                layer: f.strategy_layer,
                rice: f.rice_override || f.rice_score,
                epics: {}
            };
        }
        const epicKey = f.epic_id;
        if (!initiatives[initKey].epics[epicKey]) {
            initiatives[initKey].epics[epicKey] = {
                epic_name: f.epic_name, layer: f.strategy_layer,
                rice: f.rice_override || f.rice_score,
                product_name: f.product_name, product_group_name: f.product_group_name,
                team_name: f.team_name, features: []
            };
        }
        initiatives[initKey].epics[epicKey].features.push(f);
    }

    let html = '';
    if (!features.length) {
        html = '<div class="empty"><p>No features yet. Use the Generate tab first.</p></div>';
    } else {
        for (const [initId, init] of Object.entries(initiatives)) {
            const initRice = init.rice || 0;
            html += '<div class="card" style="margin-bottom:24px;">' +
                '<h3 style="margin-bottom:16px;">' +
                    init.initiative_name +
                    (init.layer ? ' ' + layerBadge(init.layer) : '') +
                    ' <span class="rice-badge ' + riceClass(initRice) + '" style="margin-left:8px;">RICE ' + Number(initRice).toFixed(1) + '</span>' +
                '</h3>';

            for (const [epicId, group] of Object.entries(init.epics)) {
                html += '<div style="margin-left:16px;margin-bottom:16px;padding:12px;background:#0f172a;border-radius:8px;">' +
                    '<h4 style="font-size:14px;color:#f1f5f9;margin-bottom:10px;">' +
                        group.epic_name +
                        (group.product_name ? ' <span style="font-size:12px;color:#94a3b8;margin-left:8px;">' + group.product_name + '</span>' : '') +
                        (group.team_name ? ' <span style="font-size:12px;color:#64748b;margin-left:4px;">| ' + group.team_name + '</span>' : '') +
                    '</h4>';

                for (const f of group.features) {
                    const borderColor = { business: '#059669', digital: '#2563eb', data: '#d97706', gen_ai: '#7c3aed' }[group.layer] || '#334155';
                    const fRiskCls = 'risk-badge risk-' + (f.risk_level || 'medium');
                    const acId = 'ac-' + f.id;
                    html += '<div class="strategy-card" style="border-left-color:' + borderColor + ';">' +
                        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
                            '<div style="font-weight:500;font-size:14px;">' +
                                f.name +
                                (f.ai_generated ? ' <span class="ai-badge">AI</span>' : '') +
                                (f.estimated_effort ? ' <span class="sp-badge">' + f.estimated_effort + ' SP</span>' : '') +
                                ' <span class="' + fRiskCls + '">' + (f.risk_level || 'medium') + '</span>' +
                            '</div>' +
                            '<div style="display:flex;gap:8px;align-items:center;">' +
                                statusHtml(f.status) +
                                '<button class="btn btn-danger" onclick="deleteFeature(' + f.id + ')">Delete</button>' +
                            '</div>' +
                        '</div>' +
                        '<p style="font-size:13px;color:#94a3b8;margin-bottom:10px;">' + (f.description || '') + '</p>' +
                        '<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">' +
                            '<label style="font-size:11px;color:#64748b;">Value ' +
                                '<select style="width:50px;padding:2px;font-size:12px;" onchange="updateFeatureField(' + f.id + ',\'value_score\',+this.value)">' +
                                    [1,2,3,4,5].map(v => '<option value="' + v + '"' + (f.value_score==v?' selected':'') + '>' + v + '</option>').join('') +
                                '</select>' +
                            '</label>' +
                            '<label style="font-size:11px;color:#64748b;">Size ' +
                                '<select style="width:50px;padding:2px;font-size:12px;" onchange="updateFeatureField(' + f.id + ',\'size_score\',+this.value)">' +
                                    [1,2,3,4,5].map(v => '<option value="' + v + '"' + (f.size_score==v?' selected':'') + '>' + v + '</option>').join('') +
                                '</select>' +
                            '</label>' +
                            '<label style="font-size:11px;color:#64748b;">Effort ' +
                                '<select style="width:50px;padding:2px;font-size:12px;" onchange="updateFeatureField(' + f.id + ',\'effort_score\',+this.value)">' +
                                    [1,2,3,4,5].map(v => '<option value="' + v + '"' + (f.effort_score==v?' selected':'') + '>' + v + '</option>').join('') +
                                '</select>' +
                            '</label>' +
                            '<label style="font-size:11px;color:#64748b;">Risk ' +
                                '<select style="width:80px;padding:2px;font-size:12px;" onchange="updateFeatureField(' + f.id + ',\'risk_level\',this.value)">' +
                                    ['low','medium','high','critical'].map(r => '<option value="' + r + '"' + (f.risk_level==r?' selected':'') + '>' + r + '</option>').join('') +
                                '</select>' +
                            '</label>' +
                            '<span style="font-size:13px;font-weight:600;color:#38bdf8;">Priority: ' + (f.priority_score || 0).toFixed(1) + '</span>' +
                        '</div>' +
                        (f.acceptance_criteria ? '<div style="font-size:12px;color:#6ee7b7;cursor:pointer;margin-bottom:4px;" onclick="var el=document.getElementById(\'' + acId + '\');el.style.display=el.style.display===\'none\'?\'block\':\'none\'">Acceptance Criteria <span class="expand-toggle">[toggle]</span></div><div id="' + acId + '" style="display:none;font-size:12px;color:#94a3b8;padding:10px;background:#0f172a;border-radius:6px;margin-bottom:6px;white-space:pre-line;">' + f.acceptance_criteria + '</div>' : '') +
                        (f.risks ? '<div style="font-size:12px;color:#fca5a5;margin-bottom:6px;cursor:pointer;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">Risks <span class="expand-toggle">[toggle]</span></div><div style="display:none;font-size:12px;color:#94a3b8;padding:8px;background:#1e293b;border-radius:6px;margin-bottom:6px;">' + f.risks + '</div>' : '') +
                        (f.ai_rationale ? '<div style="font-size:11px;color:#c4b5fd;cursor:pointer;margin-bottom:4px;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">AI Rationale <span class="expand-toggle">[toggle]</span></div><div style="display:none;font-size:12px;color:#94a3b8;padding:8px;background:#0f172a;border-radius:6px;margin-bottom:6px;">' + f.ai_rationale + '</div>' : '') +
                        '<div style="font-size:12px;color:#64748b;">' +
                            (f.delivery_okr_objective ? '<span>Delivery OKR: ' + f.delivery_okr_objective + '</span> ' : '') +
                            (f.dependencies_text ? '| Deps: ' + f.dependencies_text + ' ' : '') +
                        '</div>' +
                    '</div>';
                }
                html += '</div>';
            }
            html += '</div>';
        }
    }

    html += '<div style="margin-top:16px;">' +
        '<button class="btn btn-primary" onclick="addManualFeature()">+ Add Manual Feature</button>' +
    '</div>';

    document.getElementById('step7-content').innerHTML = html;
}

async function updateFeatureField(id, field, value) {
    await api('/step7/features/' + id, 'PUT', { [field]: value });
    toast('Updated');
    renderStep7Review();
}

async function deleteFeature(id) {
    if (!confirm('Delete this feature?')) return;
    await api('/step7/features/' + id, 'DELETE');
    toast('Feature deleted');
    renderStep7Review();
}

async function addManualFeature() {
    const epics = await api('/step6/epics');
    if (!epics.length) { alert('Add epics in Step 6 first.'); return; }
    const epicId = prompt('Epic ID (' + epics.map(e => e.id + '=' + e.name).join(', ') + '):');
    if (!epicId) return;
    const name = prompt('Feature name:');
    if (!name) return;
    const description = prompt('Description (optional):');
    await api('/step7/features', 'POST', { epic_id: +epicId, name, description });
    toast('Feature added');
    renderStep7Review();
}

// --- Tab 3: Features Quarterly Roadmap (1 year) ---
async function renderStep7Roadmap() {
    const roadmap = await api('/step7/roadmap');
    const q = roadmap.quarters || [];
    const pc = roadmap.phase_counts || {};

    let html = `
        <div class="qt-summary">
            <div class="qt-summary-card"><div class="qt-val">${roadmap.total}</div><div class="qt-lbl">Total Features</div></div>
            <div class="qt-summary-card"><div class="qt-val" style="color:#6ee7b7">${pc.quick_wins||0}</div><div class="qt-lbl">Quick Wins</div></div>
            <div class="qt-summary-card"><div class="qt-val" style="color:#7dd3fc">${pc.strategic||0}</div><div class="qt-lbl">Strategic</div></div>
            <div class="qt-summary-card"><div class="qt-val" style="color:#fbbf24">${pc.long_term||0}</div><div class="qt-lbl">Long-term</div></div>
        </div>
        <div class="qt-roadmap">
    `;

    for (const qtr of q) {
        html += `<div class="qt-quarter">
            <div class="qt-header">${qtr.label} <span class="qt-count">(${qtr.items.length})</span></div>
            <div class="qt-items">`;
        if (!qtr.items.length) {
            html += '<div style="text-align:center;color:#475569;font-size:12px;padding:20px 0;">No features</div>';
        }
        for (const f of qtr.items) {
            const riskCls = 'risk-' + (f.risk_level || 'medium');
            const phaseColor = {quick_win:'#6ee7b7',strategic:'#7dd3fc',long_term:'#fbbf24'}[f.computed_phase] || '#475569';
            html += `<div class="qt-card" style="border-left: 3px solid ${phaseColor}">
                <div class="qt-name">
                    ${f.name}
                    ${f.ai_generated ? ' <span class="ai-badge">AI</span>' : ''}
                    ${f.estimated_effort ? ' <span class="sp-badge">' + f.estimated_effort + ' SP</span>' : ''}
                </div>
                <div class="qt-parent">
                    ${f.epic_name ? '<span>Epic: ' + f.epic_name + '</span>' : ''}
                    ${f.product_name ? '<span>Product: ' + f.product_name + '</span>' : ''}
                    ${f.initiative_name ? '<span>Initiative: ' + f.initiative_name + '</span>' : ''}
                </div>
                <div class="qt-meta">
                    ${phaseBadge(f.computed_phase)}
                    ${f.strategy_layer ? layerBadge(f.strategy_layer) : ''}
                    <span style="font-weight:600;color:#38bdf8;">P:${(f.priority_score||0).toFixed(1)}</span>
                    <span>E:${f.effort_score||'-'}</span>
                    <span>V:${f.value_score||'-'}</span>
                    <span class="${riskCls}">${f.risk_level||'medium'}</span>
                    ${f.team_name ? '<span>' + f.team_name + '</span>' : ''}
                    ${statusHtml(f.status)}
                </div>
            </div>`;
        }
        html += '</div></div>';
    }
    html += '</div>';
    document.getElementById('step7-content').innerHTML = html;
}

// ===================== REVIEW GATES =====================
async function loadGates() {
    const gates = await api('/gates/');

    const gateConfig = [
        { step: 1, gates: [{n:1, name:'Review dashboard metrics'}, {n:2, name:'Approve performance baseline'}] },
        { step: 2, gates: [{n:1, name:'Refine opportunity levers'}] },
        { step: 3, gates: [{n:1, name:'Validate SWOT entries'}, {n:2, name:'Approve TOWS strategies'}] },
        { step: 4, gates: [{n:1, name:'Review strategies'}, {n:2, name:'Approve Strategic OKRs'}] },
        { step: 5, gates: [{n:1, name:'RICE manual override complete'}, {n:2, name:'Approve initiative list'}] },
        { step: 6, gates: [{n:1, name:'Review team dependencies'}, {n:2, name:'Approve Product OKRs'}] },
        { step: 7, gates: [{n:1, name:'Review Delivery OKRs'}, {n:2, name:'Approve final roadmap'}] },
    ];

    // Seed gates if empty
    if (!gates.length) {
        for (const s of gateConfig) {
            for (const g of s.gates) {
                await api('/gates/', 'POST', { step_number: s.step, gate_number: g.n, gate_name: g.name });
            }
        }
        return loadGates();
    }

    document.getElementById('main-content').innerHTML = `
        <div class="page-header">
            <h2>Review Gates (HITL Approvals)</h2>
            <p>Each step requires human approval before proceeding to the next.</p>
        </div>

        ${gateConfig.map(s => {
            const stepGates = gates.filter(g => g.step_number === s.step);
            return `<div class="card">
                <h3>Step ${s.step}</h3>
                ${stepGates.map(g => `
                    <div class="gate-card">
                        <div class="gate-info">
                            <div class="gate-name">Gate ${g.gate_number}: ${g.gate_name}</div>
                            <div class="gate-desc">${g.review_notes || 'No review notes'}</div>
                        </div>
                        ${statusHtml(g.status)}
                        ${g.status !== 'approved' ? `<button class="btn btn-success btn-sm" style="margin-left:12px" onclick="approveGate(${g.id})">Approve</button>` : ''}
                    </div>
                `).join('')}
            </div>`;
        }).join('')}
    `;
}

async function approveGate(id) {
    const notes = prompt('Review notes (optional):');
    await api(`/gates/${id}`, 'PUT', { status: 'approved', reviewer: 'User', review_notes: notes });
    toast('Gate approved');
    loadGates();
}

// ===================== KNOWLEDGE BASE & DATA MODE =====================
let currentDataMode = 'demo';

async function loadDataMode() {
    try {
        const res = await api('/kb/data-mode');
        if (res && res.data_mode) {
            currentDataMode = res.data_mode;
            updateDataModeBadge();
        }
    } catch (e) {}
}

function updateDataModeBadge() {
    const dot = document.getElementById('mode-dot');
    const text = document.getElementById('mode-text');
    if (dot && text) {
        dot.className = 'mode-dot ' + currentDataMode;
        text.textContent = currentDataMode === 'live' ? 'Live Mode' : 'Demo Mode';
    }
}

async function toggleDataMode() {
    const newMode = currentDataMode === 'demo' ? 'live' : 'demo';
    try {
        const res = await api('/kb/data-mode', 'POST', { data_mode: newMode });
        if (res && res.data_mode) {
            currentDataMode = res.data_mode;
            updateDataModeBadge();
            toast('Switched to ' + (currentDataMode === 'live' ? 'Live' : 'Demo') + ' mode');
            // Update modal toggle if open
            const toggle = document.getElementById('kb-toggle');
            if (toggle) toggle.className = 'toggle-switch' + (currentDataMode === 'live' ? ' live' : '');
            const demoLabel = document.getElementById('kb-demo-label');
            const liveLabel = document.getElementById('kb-live-label');
            if (demoLabel) demoLabel.className = 'mode-label ' + (currentDataMode === 'demo' ? 'active' : 'inactive');
            if (liveLabel) liveLabel.className = 'mode-label ' + (currentDataMode === 'live' ? 'active' : 'inactive');
        }
    } catch (e) {
        toast('Failed to switch mode');
    }
}

async function showKnowledgeBase() {
    // Deselect step nav items
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

    const existing = document.getElementById('gen-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'gen-overlay';
    overlay.className = 'gen-overlay';
    overlay.innerHTML = `<div class="kb-modal">
        <h2>Knowledge Base</h2>
        <p class="kb-subtitle">Manage organization documents and data mode for RAG-enhanced AI analysis</p>

        <div class="data-mode-toggle">
            <span id="kb-demo-label" class="mode-label ${currentDataMode === 'demo' ? 'active' : 'inactive'}">Demo</span>
            <div id="kb-toggle" class="toggle-switch${currentDataMode === 'live' ? ' live' : ''}" onclick="toggleDataMode()">
                <div class="toggle-knob"></div>
            </div>
            <span id="kb-live-label" class="mode-label ${currentDataMode === 'live' ? 'active' : 'inactive'}">Live</span>
        </div>

        <div id="kb-stats-area" class="kb-stats"></div>

        <div class="kb-upload-area" id="kb-upload-area" onclick="document.getElementById('kb-file-input').click()">
            <input type="file" id="kb-file-input" accept=".pdf,.docx,.xlsx,.csv,.txt,.json,.md" onchange="uploadKbDocument()" />
            <p style="color:#94a3b8;font-size:14px;margin-bottom:4px;">Click to upload a document</p>
            <p style="color:#475569;font-size:12px;">PDF, DOCX, XLSX, CSV, TXT, JSON, MD</p>
        </div>

        <div style="margin-bottom:12px;">
            <label style="font-size:13px;color:#94a3b8;">Document Category:</label>
            <select id="kb-doc-category" style="margin-left:8px;padding:4px 8px;">
                <option value="general">General</option>
                <option value="financial">Financial</option>
                <option value="strategy">Strategy</option>
                <option value="operations">Operations</option>
                <option value="value_stream">Value Stream</option>
                <option value="competitor">Competitor</option>
                <option value="technology">Technology</option>
                <option value="market">Market</option>
            </select>
        </div>

        <div class="kb-search">
            <input type="text" id="kb-search-input" placeholder="Search knowledge base..." onkeydown="if(event.key==='Enter')searchKb()" />
            <button class="btn btn-primary btn-sm" onclick="searchKb()">Search</button>
        </div>
        <div id="kb-search-results" class="kb-search-results"></div>

        <h3 style="font-size:15px;margin-bottom:10px;">Documents</h3>
        <div id="kb-doc-list" class="kb-doc-list">
            <p style="color:#64748b;text-align:center;">Loading...</p>
        </div>

        <div class="gen-actions" style="margin-top:20px;">
            <button class="btn-outline" onclick="closeGenOverlay(); if(currentStep) showStep(currentStep);">Close</button>
        </div>
    </div>`;

    document.body.appendChild(overlay);
    loadKbStats();
    loadKbDocuments();
}

async function loadKbStats() {
    try {
        const stats = await api('/kb/stats');
        if (!stats) return;
        document.getElementById('kb-stats-area').innerHTML = `
            <div class="kb-stat"><div class="kb-stat-val">${stats.documents || 0}</div><div class="kb-stat-label">Documents</div></div>
            <div class="kb-stat"><div class="kb-stat-val">${stats.chunks || 0}</div><div class="kb-stat-label">Chunks</div></div>
            <div class="kb-stat"><div class="kb-stat-val">${stats.embedded_chunks || 0}</div><div class="kb-stat-label">Embedded</div></div>
            <div class="kb-stat"><div class="kb-stat-val" style="font-size:14px;color:${stats.data_mode === 'live' ? '#10b981' : '#f59e0b'}">${stats.data_mode || 'demo'}</div><div class="kb-stat-label">Data Mode</div></div>
        `;
    } catch (e) {}
}

async function loadKbDocuments() {
    try {
        const docs = await api('/kb/list');
        const container = document.getElementById('kb-doc-list');
        if (!docs || !docs.length) {
            container.innerHTML = '<p style="color:#64748b;text-align:center;font-size:13px;">No documents uploaded yet. Upload files to build the knowledge base.</p>';
            return;
        }
        container.innerHTML = docs.map(d => `
            <div class="kb-doc-item">
                <div class="kb-doc-info">
                    <div class="kb-doc-name">${d.filename}</div>
                    <div class="kb-doc-meta">${d.file_type} | ${d.chunks || 0} chunks | ${d.embedded_chunks || 0} embedded | ${d.upload_source || 'manual'}</div>
                </div>
                <span class="kb-doc-badge">${d.doc_category || 'general'}</span>
                <button class="btn btn-danger" style="padding:4px 10px;font-size:11px;" onclick="deleteKbDoc(${d.id})">Del</button>
            </div>
        `).join('');
    } catch (e) {
        document.getElementById('kb-doc-list').innerHTML = '<p style="color:#f87171;">Failed to load documents.</p>';
    }
}

async function uploadKbDocument() {
    const fileInput = document.getElementById('kb-file-input');
    if (!fileInput.files.length) return;

    const file = fileInput.files[0];
    const category = document.getElementById('kb-doc-category').value;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('doc_category', category);

    try {
        const headers = {};
        if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
        const res = await fetch(API + '/kb/upload', { method: 'POST', body: formData, headers });
        const result = await res.json();
        if (result.error) {
            toast(result.error);
        } else {
            toast(`Uploaded: ${result.filename} (${result.chunks} chunks)`);
            loadKbStats();
            loadKbDocuments();
        }
    } catch (e) {
        toast('Upload failed');
    }
    fileInput.value = '';
}

async function deleteKbDoc(docId) {
    if (!confirm('Delete this document and all its chunks?')) return;
    await api('/kb/' + docId, 'DELETE');
    toast('Document deleted');
    loadKbStats();
    loadKbDocuments();
}

async function searchKb() {
    const query = document.getElementById('kb-search-input').value.trim();
    if (!query) return;

    const container = document.getElementById('kb-search-results');
    container.innerHTML = '<p style="color:#64748b;text-align:center;">Searching...</p>';

    try {
        const results = await api('/kb/search', 'POST', { query, top_k: 8 });
        if (!results || !results.length) {
            container.innerHTML = '<p style="color:#64748b;text-align:center;font-size:13px;">No matching results.</p>';
            return;
        }
        container.innerHTML = results.map(r => `
            <div class="kb-search-result">
                <div class="chunk-text">${r.chunk_text ? r.chunk_text.substring(0, 300) + (r.chunk_text.length > 300 ? '...' : '') : ''}</div>
                <div class="chunk-meta">Source: ${r.filename || 'Unknown'} | Category: ${r.doc_category || 'general'}${r.similarity != null ? ' | Relevance: ' + Number(r.similarity).toFixed(3) : ''}</div>
            </div>
        `).join('');
    } catch (e) {
        container.innerHTML = '<p style="color:#f87171;">Search failed.</p>';
    }
}

async function refreshCompetitorBenchmarks(vsId) {
    const bpDiv = document.getElementById('competitor-bp-' + vsId);
    if (bpDiv) bpDiv.innerHTML = '<div class="loading-overlay" style="position:static;padding:20px;"><div class="spinner"></div><p>Generating competitor benchmarks with AI...</p></div>';

    try {
        const result = await api(`/step2/value-streams/${vsId}/competitor-benchmarks`, 'POST');
        if (result.error) {
            toast(result.error);
            if (bpDiv) bpDiv.innerHTML = '';
            return;
        }
        toast(`Generated ${result.benchmarks} competitor benchmarks`);

        // Show best practices if available
        if (result.industry_best_practices && result.industry_best_practices.length && bpDiv) {
            bpDiv.innerHTML = `
                <h4 style="margin-top:16px;font-size:14px;color:#38bdf8;">Industry Best Practices</h4>
                <div style="display:flex;flex-direction:column;gap:6px;margin-top:8px;">
                    ${result.industry_best_practices.map(bp => `
                        <div style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:10px 14px;">
                            <div style="font-size:13px;font-weight:500;color:#e2e8f0;">${bp.practice || ''}</div>
                            <div style="font-size:12px;color:#94a3b8;margin-top:4px;">${bp.description || ''}</div>
                            <div style="font-size:11px;color:#64748b;margin-top:4px;">Adoption: ${bp.adoption_rate || 'N/A'} | Impact: ${bp.impact || 'N/A'}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Reload the full edit view to show new benchmark data
        setTimeout(() => renderStep2Edit(), 500);
    } catch (e) {
        toast('Failed to generate benchmarks');
        if (bpDiv) bpDiv.innerHTML = '';
    }
}

// ===================== SHARED REVIEW GATES =====================
const gateConfig = {
    1: [{n:1, name:'Review dashboard metrics'}, {n:2, name:'Approve performance baseline'}],
    2: [{n:1, name:'Refine opportunity levers'}],
    3: [{n:1, name:'Validate SWOT entries'}, {n:2, name:'Approve TOWS strategies'}],
    4: [{n:1, name:'Review strategies'}, {n:2, name:'Approve Strategic OKRs'}],
    5: [{n:1, name:'RICE manual override complete'}, {n:2, name:'Approve initiative list'}],
    6: [{n:1, name:'Review team dependencies'}, {n:2, name:'Approve Product OKRs'}],
    7: [{n:1, name:'Review Delivery OKRs'}, {n:2, name:'Approve final roadmap'}],
};

async function renderStepGates(stepNumber, targetDivId) {
    const target = document.getElementById(targetDivId);
    if (!target) return;

    let gates = await api('/gates/step/' + stepNumber);

    // Seed gates if none exist for this step
    if (!gates.length) {
        const config = gateConfig[stepNumber] || [];
        for (const g of config) {
            await api('/gates/', 'POST', { step_number: stepNumber, gate_number: g.n, gate_name: g.name });
        }
        gates = await api('/gates/step/' + stepNumber);
    }

    if (!gates.length) { target.innerHTML = ''; return; }

    const allApproved = gates.every(g => g.status === 'approved');

    let html = '<div class="card" style="margin-top:24px;border-top:2px solid ' + (allApproved ? '#059669' : '#334155') + ';">' +
        '<h3>Step ' + stepNumber + ' Review Gates</h3>';

    for (const g of gates) {
        html += '<div class="gate-card">' +
            '<div class="gate-info">' +
                '<div class="gate-name">Gate ' + g.gate_number + ': ' + g.gate_name + '</div>' +
                '<div class="gate-desc">' + (g.review_notes || 'No review notes') + '</div>' +
            '</div>' +
            statusHtml(g.status) +
            (g.status !== 'approved' ? ' <button class="btn btn-success btn-sm" style="margin-left:12px" onclick="approveStepGate(' + g.id + ',' + stepNumber + ',\'' + targetDivId + '\')">Approve</button>' : '') +
        '</div>';
    }

    if (allApproved) {
        html += '<div style="text-align:center;padding:16px;background:#064e3b;border-radius:8px;margin-top:12px;">' +
            '<span style="color:#6ee7b7;font-weight:600;font-size:15px;">All gates approved</span>';
        if (stepNumber < 7) {
            html += '<br><button class="btn btn-primary" style="margin-top:10px;" onclick="showStep(' + (stepNumber + 1) + ')">Proceed to Step ' + (stepNumber + 1) + ' &rarr;</button>';
        } else {
            html += '<br><span style="color:#6ee7b7;font-size:13px;margin-top:8px;display:inline-block;">All steps complete!</span>';
        }
        html += '</div>';
    }

    html += '</div>';
    target.innerHTML = html;
}

async function approveStepGate(gateId, stepNumber, targetDivId) {
    const notes = prompt('Review notes (optional):');
    await api('/gates/' + gateId, 'PUT', { status: 'approved', reviewer: 'User', review_notes: notes });
    toast('Gate approved');
    renderStepGates(stepNumber, targetDivId);
}

// ===================== GENERATE ALL STEPS =====================
const STEP_NAMES = {
    1: 'Business Performance',
    2: 'Value Stream Analysis',
    3: 'SWOT / TOWS Engine',
    4: 'Strategy & OKRs',
    5: 'Initiatives & RICE',
    6: 'Epics & Roadmap',
    7: 'Features & Roadmap',
};

let _genPollTimer = null;
let _currentRunId = null;

async function startGenerateAll() {
    const org = await api('/step1/organization');
    if (!org) { alert('Please set up your organization first.'); return; }

    // Check for existing running generation
    const latest = await api('/generate-all/latest');
    if (latest && latest.status === 'running') {
        _currentRunId = latest.run_id;
        showGenOverlay(latest);
        startGenPolling();
        return;
    }

    // Start new generation
    const result = await api('/generate-all/start', 'POST', { org_id: org.id });
    if (result.error) { alert(result.error); return; }
    _currentRunId = result.run_id;
    showGenOverlay({ run_id: result.run_id, status: 'running', current_step: 0, steps_completed: [], steps_failed: [], message: 'Starting...' });
    startGenPolling();
}

function showGenOverlay(runData) {
    // Remove existing overlay if any
    const existing = document.getElementById('gen-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'gen-overlay';
    overlay.className = 'gen-overlay';
    overlay.innerHTML = buildGenModalHtml(runData);
    document.body.appendChild(overlay);
}

function buildGenModalHtml(d) {
    const status = d.status || 'running';
    const currentStep = d.current_step || 0;
    const completed = d.steps_completed || [];
    const failed = d.steps_failed || [];
    const pct = Math.round((completed.length / 7) * 100);

    let title = 'Generating All Steps...';
    if (status === 'completed') title = 'Generation Complete!';
    else if (status === 'failed') title = 'Generation Failed';
    else if (status === 'partial') title = 'Generation Partially Complete';

    let stepsHtml = '';
    for (let i = 1; i <= 7; i++) {
        let iconClass = 'pending';
        let iconText = i;
        let statusText = 'Pending';
        if (completed.includes(i)) {
            iconClass = 'done';
            iconText = '\u2713';
            statusText = 'Complete';
        } else if (failed.includes(i)) {
            iconClass = 'failed';
            iconText = '\u2717';
            statusText = 'Failed';
        } else if (i === currentStep && status === 'running') {
            iconClass = 'running';
            statusText = 'Running...';
        }
        stepsHtml += `<div class="gen-step-item">
            <div class="gen-step-icon ${iconClass}">${iconText}</div>
            <div class="gen-step-info">
                <div class="gen-step-name">Step ${i}: ${STEP_NAMES[i]}</div>
                <div class="gen-step-status">${statusText}</div>
            </div>
        </div>`;
    }

    let actionsHtml = '';
    if (status === 'running') {
        actionsHtml = `<div class="gen-actions"><button class="btn-outline" onclick="closeGenOverlay()">Run in Background</button></div>`;
    } else if (status === 'completed') {
        actionsHtml = `<div class="gen-actions">
            <button class="btn btn-primary" onclick="showReviewWizard()">Review & Approve Steps</button>
            <button class="btn-outline" onclick="closeGenOverlay(); showStep(1);">View Results</button>
        </div>`;
    } else if (status === 'failed' || status === 'partial') {
        actionsHtml = `<div class="gen-actions">
            <button class="btn btn-primary" onclick="retryGeneration()">Retry</button>
            <button class="btn-outline" onclick="closeGenOverlay()">Close</button>
        </div>`;
    }

    return `<div class="gen-modal">
        <h2>${title}</h2>
        <div class="gen-progress-bar"><div class="gen-progress-fill" style="width:${pct}%"></div></div>
        <div class="gen-msg">${d.message || ''}</div>
        <div class="gen-step-list">${stepsHtml}</div>
        ${d.error_message ? `<div style="background:#7f1d1d;border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:#fca5a5;">${d.error_message}</div>` : ''}
        ${actionsHtml}
    </div>`;
}

function startGenPolling() {
    stopGenPolling();
    _genPollTimer = setInterval(async () => {
        if (!_currentRunId) { stopGenPolling(); return; }
        const data = await api('/generate-all/status/' + _currentRunId);
        if (!data || data.error) return;

        const overlay = document.getElementById('gen-overlay');
        if (overlay) {
            overlay.innerHTML = buildGenModalHtml(data);
        }

        if (data.status !== 'running') {
            stopGenPolling();
            if (data.status === 'completed') {
                toast('All 7 steps generated successfully!');
            }
        }
    }, 2000);
}

function stopGenPolling() {
    if (_genPollTimer) { clearInterval(_genPollTimer); _genPollTimer = null; }
}

function closeGenOverlay() {
    const overlay = document.getElementById('gen-overlay');
    if (overlay) overlay.remove();
}

async function retryGeneration() {
    if (!_currentRunId) return;
    const result = await api('/generate-all/retry/' + _currentRunId, 'POST');
    if (result.error) { alert(result.error); return; }
    showGenOverlay({ run_id: _currentRunId, status: 'running', current_step: 0, steps_completed: [], steps_failed: [], message: 'Retrying...' });
    startGenPolling();
}

// ===================== REVIEW WIZARD =====================
async function showReviewWizard() {
    closeGenOverlay();

    const [gates, runData] = await Promise.all([
        api('/gates/'),
        _currentRunId ? api('/generate-all/status/' + _currentRunId) : Promise.resolve(null),
    ]);

    const overlay = document.createElement('div');
    overlay.id = 'gen-overlay';
    overlay.className = 'gen-overlay';

    const approvedCount = (gates || []).filter(g => g.status === 'approved').length;
    const totalGates = (gates || []).length || 7;

    // Group gates by step
    const gatesByStep = {};
    (gates || []).forEach(g => {
        if (!gatesByStep[g.step_number]) gatesByStep[g.step_number] = [];
        gatesByStep[g.step_number].push(g);
    });

    let stepsHtml = '';
    for (let i = 1; i <= 7; i++) {
        const stepGates = gatesByStep[i] || [];
        const allApproved = stepGates.length > 0 && stepGates.every(g => g.status === 'approved');
        const iconClass = allApproved ? 'done' : 'pending';
        const iconText = allApproved ? '\u2713' : i;

        stepsHtml += `<div class="review-step-card">
            <div class="gen-step-icon ${iconClass}">${iconText}</div>
            <div class="rsc-info">
                <div class="rsc-name">Step ${i}: ${STEP_NAMES[i]}</div>
                <div class="rsc-counts">${stepGates.length} gate${stepGates.length !== 1 ? 's' : ''} â€” ${allApproved ? 'All approved' : 'Pending review'}</div>
            </div>
            <div class="rsc-actions">
                <button class="btn btn-sm btn-primary" onclick="closeGenOverlay(); showStep(${i});">Review & Edit</button>
                ${!allApproved ? `<button class="btn btn-sm btn-success" onclick="approveAllStepGates(${i})">Approve</button>` : ''}
            </div>
        </div>`;
    }

    const pct = Math.round((approvedCount / totalGates) * 100);

    overlay.innerHTML = `<div class="gen-modal">
        <h2>Review & Approve Steps</h2>
        <div class="gen-progress-bar"><div class="gen-progress-fill" style="width:${pct}%;background:linear-gradient(90deg,#059669,#6ee7b7);"></div></div>
        <div class="gen-msg">${approvedCount}/${totalGates} gates approved</div>
        <div style="margin-bottom:16px;">${stepsHtml}</div>
        <div class="gen-actions">
            <button class="btn-outline" onclick="closeGenOverlay()">Close</button>
        </div>
    </div>`;

    document.body.appendChild(overlay);
}

async function approveAllStepGates(stepNumber) {
    const gates = await api('/gates/step/' + stepNumber);
    for (const g of gates) {
        if (g.status !== 'approved') {
            await api('/gates/' + g.id, 'PUT', { status: 'approved', reviewer: 'Auto-Review', review_notes: 'Bulk approved after AI generation' });
        }
    }
    toast('Step ' + stepNumber + ' approved');
    showReviewWizard();
}

// Check for in-progress generation on page load
async function checkActiveGeneration() {
    try {
        const latest = await api('/generate-all/latest');
        if (latest && latest.status === 'running') {
            _currentRunId = latest.run_id;
            showGenOverlay(latest);
            startGenPolling();
        }
    } catch (e) {}
}

// --- Init ---
initApp();
</script>

</body>
</html>
